---
phase: 06-real-time-polish
plan: 01
type: execute
domain: next-js
---

<objective>
Implement real-time message updates using Supabase real-time subscriptions so agents see new messages instantly without page refresh.

Purpose: Complete the real-time experience for agents - messages arrive live as customers respond and as AI responds, ensuring no missed communication.

Output: Working MessageList client component with Supabase subscriptions, instant message rendering, scroll-to-bottom behavior, auto-refresh support.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-human-takeover/05-01-SUMMARY.md

# Key files affected by this phase
@src/components/MessageList.tsx
@src/app/dashboard/c/[id]/page.tsx
@src/lib/supabase/client.ts
@src/types/database.ts

# Tech stack available (from prior phases)
- Next.js 16 with Turbopack
- Supabase SSR package (server components)
- Client component patterns established
- TypeScript types for database schema

# Established patterns
- Server components for data fetching
- Supabase client initialization (both server and client variants)
- Type assertions for Supabase join queries (types don't infer correctly)
- RLS policies for authenticated access

# Constraining decisions
- Phase 5 (Human Takeover): Handler type affects who receives/sends messages
- Phase 4 (AI Integration): n8n sends messages via service role webhook - must not be missed by real-time subscriptions
- Phase 3 (Inbox Core): Message persistence already working, only subscription layer needed

# Concerns from prior phases
- Real-time subscriptions can be unreliable without proper cleanup (unsubscribe on unmount)
- Must handle connection state (online/offline) gracefully
- Avoid excessive re-renders when subscribing to updates
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert MessageList to client component with real-time subscription</name>
  <files>src/components/MessageList.tsx, src/app/dashboard/c/[id]/page.tsx</files>
  <action>
    Convert MessageList from server component to client component with real-time subscriptions:

    1. Create new file: src/components/MessageListClient.tsx (client component)
    2. Move message fetching and rendering logic to client component
    3. Add useEffect hook that:
       - Fetches initial messages on mount (same query as server component)
       - Creates Supabase real-time subscription to 'messages' table
       - Filters subscription by conversation_id
       - Appends new messages to state without refetching entire list
       - Handles subscription cleanup on unmount (unsubscribe)
    4. Maintain MessageList as a wrapper component that renders MessageListClient
    5. Keep Suspense fallback in parent page for initial load

    Key implementation details:
    - Use useState for messages array
    - Use useRef to track subscription (for cleanup)
    - Real-time event types: 'INSERT', 'UPDATE', 'DELETE' - handle INSERT by appending
    - Subscribe to table '*' filter by `conversation_id=eq.{conversationId}`
    - Maintain sort order (created_at ascending) when appending new messages
    - DO NOT use optimistic updates here (messages come from database via subscription)
    - Handle edge case: new message arrives during initial fetch (use Set to deduplicate by id)
  </action>
  <verify>
    1. npm run build succeeds without errors
    2. Navigate to conversation
    3. Send message from MessageCompose
    4. Verify message appears instantly without page refresh
    5. Simulate incoming message via Supabase Studio or webhook
    6. Verify message appears in real-time
    7. Check browser DevTools: Network tab shows WebSocket connection (wss://) for real-time
  </verify>
  <done>
    - MessageList converted to client component with subscription
    - New messages render instantly (INSERT events trigger immediate display)
    - Subscription cleaned up on unmount
    - No console errors from subscriptions
    - Messages maintain sort order (oldest first)
    - Build completes without TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add scroll-to-bottom and connection status feedback</name>
  <files>src/components/MessageList.tsx</files>
  <action>
    Enhance MessageList with better UX for real-time messages:

    1. Add scroll-to-bottom behavior:
       - Use useRef for messages container div
       - After initial load and after each message append, scroll to bottom
       - Use scrollIntoView({ behavior: 'smooth' }) on last message

    2. Add connection status indicator:
       - Track subscription state (connecting, connected, disconnected)
       - Display subtle indicator at bottom of message list when disconnected (small banner: "Connection lost - trying to reconnect...")
       - Auto-hide when reconnected
       - DO NOT show "connecting" state (too chatty)

    3. Handle visibility change (tab switching):
       - Re-subscribe when tab regains focus (optional but helpful)
       - Use document.addEventListener('visibilitychange')

    Implementation notes:
    - Connection state comes from subscription object (subscription.state)
    - Keep indicator minimal - don't interrupt agent workflow
    - Update MessageListClient component from Task 1
  </action>
  <verify>
    1. Send message and verify automatic scroll to bottom
    2. Send multiple messages rapidly - all visible, scroll stays at bottom
    3. Simulate disconnect (DevTools -> Network -> set offline)
    4. Verify "Connection lost" banner appears
    5. Restore connection
    6. Verify banner disappears and subscription reconnects
    7. Test: Receive message while scrolled up (don't auto-scroll, keep context)
  </verify>
  <done>
    - New messages auto-scroll to view
    - Connection status feedback displays when offline
    - Subscription auto-reconnects when connection restored
    - Smooth scroll behavior implemented
    - No connection state flicker (only show disconnected after 2-3 seconds)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Real-time message subscriptions for live message updates in conversations.
    - MessageList now uses Supabase real-time subscriptions
    - New messages appear instantly as they arrive
    - Auto-scroll to latest message
    - Connection status feedback when offline
  </what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Open two browser tabs: one for agent (logged in), one with Supabase Studio
    3. Navigate agent to a conversation with existing messages
    4. Test real-time incoming:
       a. In Supabase Studio, insert a new message row manually with conversation_id matching current conversation
       b. Watch agent browser - message appears instantly within 1 second
       c. Message appears at bottom, view auto-scrolls
    5. Test real-time outgoing:
       a. Send message from MessageCompose in agent browser
       b. Message appears immediately in MessageList
    6. Test offline gracefully:
       a. DevTools -> Network -> set to offline
       b. Verify "Connection lost" banner appears at bottom
       c. DevTools -> Network -> set to online
       d. Verify banner disappears and new messages flow again
    7. Confirm: No errors in browser console, no excessive network requests
  </how-to-verify>
  <resume-signal>
    Type "approved" if all verification steps pass, or describe any issues to fix
  </resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors or warnings
- [ ] `npm run dev` starts without errors
- [ ] Navigate to conversation - messages load immediately
- [ ] Real-time test: insert message in Supabase Studio → appears in UI instantly
- [ ] Real-time test: send message from UI → appears instantly without refresh
- [ ] Offline test: disable network → "Connection lost" indicator appears
- [ ] Reconnect test: restore network → indicator clears, messages flow again
- [ ] No console errors or warnings
- [ ] No memory leaks (subscription cleanup verified)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Real-time subscriptions working end-to-end
- Messages appear instantly without page refresh
- Graceful offline handling with status feedback
- No TypeScript errors
- MessageList maintains message order and deduplication

</success_criteria>

<output>
After completion, create `.planning/phases/06-real-time-polish/06-01-SUMMARY.md`:

# Phase 6 Plan 01: Real-time Message Updates Summary

**[One-liner: e.g., "Implemented Supabase real-time subscriptions for instant message delivery and connection status feedback"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/components/MessageListClient.tsx` - New client component with real-time subscriptions
- `src/components/MessageList.tsx` - Updated to wrap MessageListClient
- `src/app/dashboard/c/[id]/page.tsx` - Maintained Suspense boundaries

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 06-02-PLAN.md (Arabic RTL support)
</output>

