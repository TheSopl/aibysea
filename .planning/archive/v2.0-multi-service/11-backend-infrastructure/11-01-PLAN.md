---
phase: 11-backend-infrastructure
plan: 01
type: auto
---

<objective>
Create API routes for Voice Agents service with CRUD operations, call logging, and phone number management.

Purpose: Provide backend endpoints for the Voice Agents UI pages to query and manage agents, call logs, and phone numbers with realistic mock data.

Output: API routes at `/api/voice/agents`, `/api/voice/calls`, `/api/voice/phone-numbers` with GET/POST/PUT/DELETE handlers and mock data returning realistic agent, call log, and phone number records.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-voice-agents-ui/09-01-SUMMARY.md
@.planning/phases/09-voice-agents-ui/09-02-SUMMARY.md
@.planning/phases/09-voice-agents-ui/09-03-SUMMARY.md
@src/app/api/webhooks/whatsapp/route.ts

**Reference patterns:**
- Next.js 16 API routes using TypeScript
- RESTful endpoint patterns from v1.0 webhook routes
- Mock data structure matching UI expectations
- TypeScript types for request/response bodies
- Error handling with appropriate status codes

**Voice Agents API specifics:**
- `/api/voice/agents` - List agents, get agent details, create/update agents
- `/api/voice/calls` - Get call logs, filter by agent/date/status, get call details
- `/api/voice/phone-numbers` - List phone numbers, assign to agents, get availability

**Mock data requirements:**
- 5-8 voice agents with names, status, metrics
- 20+ call logs with caller info, duration, transcription, status
- 3-5 phone numbers with assignment info, availability
- All data should align with Voice Agents UI expectations (agents page, call logs page, phone numbers page)

**Architecture decisions from prior phases:**
- Handlers use `handler_type: 'ai' | 'human'` for color coding
- Service color: Teal (#10B981 â†’ #06B6D4)
- Real-time support requires Supabase real-time integration
- All authenticated agents see all data (simple RLS)

**Established patterns:**
- POST/PUT use request body validation
- GET queries support filtering via URL params
- All responses include timestamps in ISO format
- Error responses include error message in JSON
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create voice agents CRUD API routes</name>
  <files>src/app/api/voice/agents/route.ts, src/app/api/voice/agents/[id]/route.ts, src/types/voice.ts</files>
  <action>
  1. Create `src/types/voice.ts` with TypeScript types:
     - VoiceAgent: id, name, status, phone_number, language, skills[], total_calls, avg_duration, success_rate, last_active, created_at
     - VoiceAgentRequest: name, status, phone_number, language, skills

  2. Create `src/app/api/voice/agents/route.ts` with:
     - GET: Return array of all voice agents with mock data (5-8 agents)
     - POST: Accept VoiceAgentRequest body, return created agent with generated ID
     - Include proper error handling (400 for bad request, 500 for server errors)
     - All timestamps in ISO format

  3. Create `src/app/api/voice/agents/[id]/route.ts` with:
     - GET: Return single agent by ID or 404 if not found
     - PUT: Accept partial VoiceAgentRequest, update and return agent
     - DELETE: Remove agent and return 204 No Content
     - Validate ID format

  4. Mock data for agents (5-8 agents):
     - Mix of status: 'available', 'on-call', 'offline', 'busy'
     - Skills: ['customer_support', 'sales', 'appointment_booking', 'technical_support']
     - Realistic metrics: total_calls (50-500), avg_duration (minutes), success_rate (85-98%)
     - Different phone numbers assigned to each
     - last_active timestamps within last 7 days

  5. Do NOT add database queries - use pure mock data for now. Phase 11-02 will extend the Supabase schema and integrate real data.

  6. Export types for use in other routes.
  </action>
  <verify>
  - curl http://localhost:3000/api/voice/agents returns 200 with array of agents
  - curl http://localhost:3000/api/voice/agents -X POST -H "Content-Type: application/json" -d '{"name":"test","status":"available","phone_number":"+1234567890","language":"en","skills":["support"]}' returns 201 with created agent
  - curl http://localhost:3000/api/voice/agents/{id} returns 200 with single agent
  - curl http://localhost:3000/api/voice/agents/{id} -X DELETE returns 204
  - All timestamps use ISO format (YYYY-MM-DDTHH:mm:ssZ)
  - No console errors or TypeScript errors
  </verify>
  <done>Voice agents CRUD endpoints functional with mock data, all HTTP methods working correctly, proper error handling</done>
</task>

<task type="auto">
  <name>Task 2: Create call logs API routes with filtering</name>
  <files>src/app/api/voice/calls/route.ts, src/app/api/voice/calls/[id]/route.ts</files>
  <action>
  1. Add CallLog type to `src/types/voice.ts`:
     - CallLog: id, agent_id, caller_number, caller_name, direction ('inbound'|'outbound'), status ('completed'|'missed'|'transferred'|'abandoned'), duration_seconds, transcription, sentiment, keywords[], started_at, ended_at

  2. Create `src/app/api/voice/calls/route.ts` with:
     - GET: Return call logs with filtering support:
       - ?agent_id=uuid - Filter by agent
       - ?status=completed - Filter by status
       - ?from_date=YYYY-MM-DD&to_date=YYYY-MM-DD - Date range filtering
       - ?direction=inbound - Filter by direction
       - ?limit=50&offset=0 - Pagination
     - POST: Accept CallLog fields (without id/timestamps), return created call log
     - Default to returning 50 most recent calls if no filters
     - Include count of total results

  3. Create `src/app/api/voice/calls/[id]/route.ts` with:
     - GET: Return single call log by ID with full details including transcription
     - PUT: Update call log (metadata, notes, sentiment review)
     - DELETE: Remove call log (soft delete if needed)

  4. Mock data for calls (20+ call logs):
     - Mix of statuses: 60% completed, 15% missed, 15% transferred, 10% abandoned
     - Various agents (use agents from Task 1)
     - Realistic phone numbers (US format +1-XXX-XXX-XXXX)
     - Durations: 30-1800 seconds (varied based on status)
     - Transcriptions: 2-5 sentences for completed/transferred calls, empty for missed
     - Sentiment: positive (happy), neutral, negative (frustrated) for completed calls
     - Keywords: ['support', 'billing', 'appointment', 'sales', 'technical']
     - Dates within last 30 days with realistic time distribution
     - Direction: 70% inbound, 30% outbound

  5. Ensure filtering works correctly - test all filter combinations.

  6. Validate date formats and handle invalid filters gracefully (return all results instead of error).
  </action>
  <verify>
  - curl http://localhost:3000/api/voice/calls returns 200 with array of 50 most recent calls
  - curl "http://localhost:3000/api/voice/calls?agent_id={id}" filters by agent correctly
  - curl "http://localhost:3000/api/voice/calls?status=completed" returns only completed calls
  - curl "http://localhost:3000/api/voice/calls?from_date=2026-01-01&to_date=2026-01-31" filters by date range
  - curl "http://localhost:3000/api/voice/calls?limit=10&offset=0" returns paginated results
  - curl http://localhost:3000/api/voice/calls/{id} returns single call with full transcription
  - Mock data has realistic distribution of statuses and agents
  - All timestamps in ISO format
  - No console errors or TypeScript errors
  </verify>
  <done>Call logs endpoints functional with filtering, pagination, and detailed transcription retrieval</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run type-check` passes (if configured)
- [ ] All API endpoints respond with proper status codes
- [ ] Mock data is realistic and matches UI expectations (agents page, call logs page)
- [ ] Filtering/pagination works correctly
- [ ] All timestamps in ISO format
- [ ] TypeScript types properly exported and used
- [ ] No console errors when calling endpoints
</verification>

<success_criteria>

- Voice agents CRUD endpoints created and functional with mock data
- Call logs endpoints created with filtering, pagination, and detail retrieval
- All HTTP methods (GET/POST/PUT/DELETE) working correctly
- TypeScript types defined and exported
- Mock data realistic and matches UI page expectations
- Proper error handling for invalid requests
- All timestamps in ISO format
- Ready for Phase 11-02 (document processing API + Supabase schema extension)
  </success_criteria>

<output>
After completion, create `.planning/phases/11-backend-infrastructure/11-01-SUMMARY.md`:

# Phase 11 Plan 1: Voice Agents API Summary

**Created API routes for voice agent management, call logs, and phone number operations with comprehensive mock data.**

## Accomplishments

- Created voice agents CRUD endpoints at `/api/voice/agents` and `/api/voice/agents/[id]`
- Implemented call logs endpoints with filtering by agent, status, date range, and direction
- Created phone numbers management endpoints (created in Task 2)
- Defined TypeScript types for Voice Agent service
- Implemented pagination and filtering logic
- Added realistic mock data (8 agents, 50+ call logs, 5 phone numbers)

## Files Created/Modified

- `src/types/voice.ts` - TypeScript types for Voice Agent service
- `src/app/api/voice/agents/route.ts` - Agents list and create endpoints
- `src/app/api/voice/agents/[id]/route.ts` - Agent detail, update, delete endpoints
- `src/app/api/voice/calls/route.ts` - Call logs list with filtering and pagination
- `src/app/api/voice/calls/[id]/route.ts` - Call detail and update endpoints

## Decisions Made

- Used pure mock data (no database queries) for Phase 11-01, Supabase integration in Phase 11-02
- Filtering via URL parameters (query strings) for flexibility
- Timestamps in ISO 8601 format for consistency with frontend
- Simple RLS model: all authenticated agents see all data

## Issues Encountered

None - straightforward API implementation following established patterns from v1.0.

## Next Phase Readiness

Ready for Phase 11-02: Document processing API routes and Supabase schema extension to replace mock data with real database queries.
</output>
