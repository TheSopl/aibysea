---
phase: 02-whatsapp-integration
plan: 02
type: execute
---

<objective>
Create WhatsApp webhook handler that receives incoming messages and persists them to database.

Purpose: Enable receiving WhatsApp messages via Cloud API webhooks and storing them with proper conversation/contact management.
Output: Working webhook endpoint at /api/webhooks/whatsapp that verifies requests and persists messages.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-whatsapp-integration/02-RESEARCH.md
@.planning/phases/02-whatsapp-integration/02-01-SUMMARY.md (load after Plan 1 completes)
@src/types/database.ts
@src/lib/supabase/server.ts

**Tech stack available:** Next.js 16, Supabase, TypeScript, @whatsapp-cloudapi/types
**Established patterns:**
- Database types in src/types/database.ts
- Supabase server client for server-side operations
- Phone number as primary contact identifier

**From RESEARCH.md - Critical Patterns:**
- Webhook handler: GET for verification, POST for messages
- MUST respond 200 within 5 seconds or WhatsApp retries
- MUST verify X-Hub-Signature-256 header in production
- Check message_id for deduplication (WhatsApp may retry)
- Phone numbers from WhatsApp have no + prefix (wa_id format)

**From RESEARCH.md - Common Pitfalls to Avoid:**
- Blocking webhook response → duplicate messages
- Missing signature verification → security vulnerability
- Phone number format inconsistency → lookup failures
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhook route handler</name>
  <files>src/app/api/webhooks/whatsapp/route.ts</files>
  <action>
Create webhook route handler with GET and POST methods:

**GET handler (webhook verification):**
- Extract query params: hub.mode, hub.verify_token, hub.challenge
- If mode === 'subscribe' AND verify_token matches WHATSAPP_WEBHOOK_VERIFY_TOKEN env var:
  - Return challenge value with 200 status
- Else return 403 Forbidden
- Add logging for debugging subscription attempts

**POST handler (receive messages):**
- Get X-Hub-Signature-256 header
- Get raw body as text (need raw for signature verification)
- Call verifySignature from lib/whatsapp/signature.ts
- If signature invalid: return 401 Unauthorized
- Parse body as JSON (WebhookPayload type)
- Call processWebhook (import from processor - created in Task 2)
- Return 200 OK immediately (processing is async)

**Critical implementation notes:**
- MUST use request.text() not request.json() to get raw body for signature verification
- MUST respond quickly - processWebhook should be async and not awaited
- Add try/catch around JSON.parse (malformed payloads shouldn't crash)
- Add logging for debugging
  </action>
  <verify>TypeScript compiles; route file exists at correct path; exports GET and POST functions</verify>
  <done>Webhook route handles verification (GET) and message receiving (POST) with signature verification</done>
</task>

<task type="auto">
  <name>Task 2: Create message processor with database persistence</name>
  <files>src/services/whatsapp/processor.ts</files>
  <action>
Create message processor that handles webhook payloads and persists to database:

**processWebhook(payload: WebhookPayload): Promise<void>**
- Iterate entry.changes where field === 'messages'
- For each change.value:
  - Handle messages array (incoming messages)
  - Handle statuses array (delivery receipts) - log for now, skip persistence

**For each incoming message:**
1. Extract: from (wa_id), id (message_id), timestamp, type, content
2. Find or create contact by phone number (normalized, no +)
3. Find or create conversation for contact + channel='whatsapp'
4. Check for duplicate by whatsapp_message_id (if exists, skip)
5. Insert message with:
   - conversation_id
   - direction: 'inbound'
   - content: message.text?.body or '[media]' placeholder for non-text
   - content_type: message.type
   - sender_type: 'customer'
   - metadata: { whatsapp_message_id: message.id, ...raw message data }
6. Update conversation.last_message_at
7. Update contact.name if profile.name provided and contact.name is null

**Contact lookup pattern:**
```typescript
const { data: contact } = await supabase
  .from('contacts')
  .select()
  .eq('phone', normalizedPhone)
  .single();

if (!contact) {
  // Insert new contact
}
```

**Critical notes:**
- Wrap entire processing in try/catch - log errors but don't throw
- Use Supabase server client from lib/supabase/server.ts
- Normalize phone: strip + prefix if present (WhatsApp wa_id has no +)
- Handle missing text body gracefully (media messages have no text.body)
  </action>
  <verify>TypeScript compiles; processWebhook function exports correctly; handles text message payload structure</verify>
  <done>Message processor persists incoming WhatsApp messages to database with contact/conversation management</done>
</task>

<task type="auto">
  <name>Task 3: Add whatsapp_message_id to database schema</name>
  <files>supabase/migrations/002_whatsapp_message_id.sql, src/types/database.ts</files>
  <action>
The messages table needs whatsapp_message_id for deduplication.

**Create migration file supabase/migrations/002_whatsapp_message_id.sql:**
```sql
-- Add WhatsApp message ID for deduplication
ALTER TABLE messages ADD COLUMN whatsapp_message_id TEXT;

-- Index for fast duplicate lookup
CREATE INDEX idx_messages_whatsapp_message_id ON messages(whatsapp_message_id) WHERE whatsapp_message_id IS NOT NULL;

-- Note: Not unique because same message might exist in different conversations (unlikely but safe)
```

**Update src/types/database.ts:**
- Add whatsapp_message_id: string | null to messages Row type
- Add whatsapp_message_id?: string | null to messages Insert type
- Add whatsapp_message_id?: string | null to messages Update type

**Important:** Migration file is documentation for user to run on their Supabase instance. The SQL won't auto-execute - user applies it via Supabase Dashboard or CLI.
  </action>
  <verify>Migration SQL file exists; database.ts updated with whatsapp_message_id field; npm run build succeeds</verify>
  <done>Database schema extended with whatsapp_message_id for deduplication</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Webhook route exists at src/app/api/webhooks/whatsapp/route.ts
- [ ] GET handler returns challenge for valid verification requests
- [ ] POST handler verifies signature before processing
- [ ] Message processor handles incoming messages and persists to database
- [ ] Migration file documents whatsapp_message_id column addition
- [ ] TypeScript types updated with whatsapp_message_id
- [ ] `npm run build` succeeds without errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Webhook ready to receive messages (deployment and Meta configuration in Plan 3)
</success_criteria>

<output>
After completion, create `.planning/phases/02-whatsapp-integration/02-02-SUMMARY.md` following the summary template.
</output>
