---
phase: 03-inbox-core
plan: 03
type: execute
---

<objective>
Implement message compose and send functionality for agents.

Purpose: Agents can type and send messages to customers through WhatsApp or Telegram.
Output: Working compose form that sends messages through appropriate channel.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-inbox-core/03-02-PLAN.md
@src/types/database.ts
@src/lib/whatsapp/client.ts
@src/lib/telegram/client.ts
@src/app/dashboard/c/[id]/page.tsx

**Established patterns:**
- sendTextMessage (WhatsApp) - requires 24h window
- sendTelegramMessage (Telegram) - no window restriction
- Messages stored with sender_type='agent' for agent-sent messages
- Server actions for form handling

**Key considerations:**
- WhatsApp 24h window: check isWithin24HourWindow before sending
- Telegram: no restrictions, send directly
- Store outbound messages in database after successful send
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create send message server action</name>
  <files>src/app/actions/messages.ts</files>
  <action>
Create server action for sending messages:

**src/app/actions/messages.ts:**
```typescript
'use server'

export async function sendMessage(
  conversationId: string,
  content: string
): Promise<{ success: boolean; error?: string }>
```

**Logic:**
1. Validate content is not empty
2. Fetch conversation with contact (get channel and contact.phone)
3. Get current agent from session (supabase.auth.getUser())
4. Based on channel:
   - **WhatsApp**:
     - Check isWithin24HourWindow(conversation.last_customer_message_at)
     - If outside window, return error: "24-hour window expired. Use a message template."
     - Extract phone from contact.phone (it's the raw WhatsApp number)
     - Call sendTextMessage(phone, content)
   - **Telegram**:
     - Extract chat_id from contact.phone (format: "telegram:{chat_id}")
     - Call sendTelegramMessage(chat_id, content)
5. On success, insert message to database:
   - conversation_id, direction='outbound', content, sender_type='agent'
   - sender_id = current agent id (from agents table matching auth user)
6. Update conversation.last_message_at
7. Return { success: true }

**Error handling:**
- Catch API errors and return { success: false, error: message }
- Log errors with [SendMessage] prefix
  </action>
  <verify>TypeScript compiles; action exports correctly</verify>
  <done>sendMessage action handles both WhatsApp and Telegram channels</done>
</task>

<task type="auto">
  <name>Task 2: Create message compose component</name>
  <files>src/components/MessageCompose.tsx</files>
  <action>
Create compose form component:

**MessageCompose.tsx (Client Component):**
- Props: conversationId, channel
- State: message text, loading, error
- UI:
  - Textarea (auto-resize, max 4 lines)
  - Send button (right side, blue)
  - Error message display (if error)
  - Loading state (disable button, show spinner)

**Behavior:**
- Submit on button click or Ctrl+Enter
- Clear input on successful send
- Show error toast/message on failure
- Prevent empty sends

**Styling:**
- Fixed height container (min-h-[60px])
- Border-t border-gray-200
- Padding: p-4
- Textarea: flex-1, resize-none, border rounded-lg
- Button: bg-blue-500 text-white, rounded-lg, px-4 py-2

**WhatsApp 24h indicator:**
- If channel='whatsapp', show subtle warning if window might expire soon
- Gray text: "Replying within 24h window"
  </action>
  <verify>Component renders; form submission works</verify>
  <done>MessageCompose handles input and triggers send action</done>
</task>

<task type="auto">
  <name>Task 3: Integrate compose into conversation page</name>
  <files>src/app/dashboard/c/[id]/page.tsx</files>
  <action>
Replace compose placeholder with real component:

- Import MessageCompose
- Pass conversationId and channel props
- Adjust layout so MessageCompose is fixed at bottom
- MessageList should fill available space and scroll

**Layout update:**
- Container: flex flex-col h-full
- Header: flex-shrink-0
- MessageList: flex-1 overflow-y-auto
- MessageCompose: flex-shrink-0

**Auto-scroll:**
- After sending, scroll MessageList to bottom
- Pass a callback or use router.refresh() to reload messages
  </action>
  <verify>Compose form visible and functional in conversation view</verify>
  <done>Agents can send messages from conversation view</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] MessageCompose renders in conversation view
- [ ] Sending Telegram message works (test with bot)
- [ ] WhatsApp 24h window check prevents expired sends
- [ ] Messages appear in database after send
- [ ] Error handling works for failed sends
</verification>

<success_criteria>

- All 3 tasks completed
- All verification checks pass
- Agents can send messages through both channels
- Phase 3 complete: Inbox Core functional
</success_criteria>

<output>
After completion, create `.planning/phases/03-inbox-core/03-03-SUMMARY.md` following the summary template.

**Phase 3 complete at this point.** Update STATE.md to reflect:
- Phase 3: Complete
- Next action: /gsd:plan-phase 4 (AI Integration)
</output>
