---
phase: 18.1-internationalization
plan: 01
subsystem: i18n
tags: [next-intl, i18n, rtl, arabic, turkish, locale-routing]

# Dependency graph
requires:
  - phase: 17-core-pages-responsive
    provides: Mobile-responsive pages structure
provides:
  - next-intl infrastructure with [locale] routing
  - RTL support for Arabic with IBM Plex Sans Arabic font
  - Middleware-based locale detection and routing
  - Locale-aware Supabase auth protection
affects: [18.1-02, all-future-phases]

# Tech tracking
tech-stack:
  added: [next-intl, IBM_Plex_Sans_Arabic]
  patterns: [locale-segment-routing, middleware-composition, rtl-direction]

key-files:
  created:
    - src/i18n/routing.ts
    - src/i18n/navigation.ts
    - src/i18n/request.ts
    - src/app/[locale]/layout.tsx
    - src/messages/en.json
    - src/messages/tr.json
    - src/messages/ar.json
  modified:
    - src/proxy.ts
    - src/lib/supabase/middleware.ts
    - next.config.ts
    - src/app/layout.tsx

key-decisions:
  - "Use localePrefix: 'as-needed' for cleaner default locale URLs"
  - "Integrate i18n middleware with existing proxy.ts instead of separate middleware.ts"
  - "IBM Plex Sans Arabic font for Arabic glyphs"

patterns-established:
  - "Locale-aware routing via [locale] dynamic segment"
  - "Middleware composition: intl routing → auth handling"
  - "RTL via html dir attribute based on locale"

issues-created: []

# Metrics
duration: 18min
completed: 2026-01-27
---

# Phase 18.1 Plan 01: i18n Infrastructure Summary

**next-intl infrastructure with [locale] routing, RTL Arabic support via IBM Plex Sans Arabic font, and middleware-based locale detection integrated with Supabase auth**

## Performance

- **Duration:** 18 min
- **Started:** 2026-01-27T05:16:00Z
- **Completed:** 2026-01-27T05:34:00Z
- **Tasks:** 2
- **Files modified:** 15 (9 created, 6 modified)

## Accomplishments

- Installed next-intl and configured locale routing for EN/TR/AR
- Restructured entire app under [locale] dynamic segment
- Added Arabic font (IBM Plex Sans Arabic) with RTL direction support
- Integrated i18n middleware with existing Supabase auth proxy
- Updated auth middleware to handle locale-prefixed paths

## Task Commits

Each task was committed atomically:

1. **Task 1: Install next-intl and create i18n configuration** - `fa93e04` (feat)
2. **Task 2: Restructure app for [locale] routing** - `5f6678f` (feat)
3. **Fix: Middleware composition for default locale** - `b16cdb5` (fix)

## Files Created/Modified

### Created
- `src/i18n/routing.ts` - Locale configuration (en, tr, ar)
- `src/i18n/navigation.ts` - Locale-aware Link, useRouter exports
- `src/i18n/request.ts` - Server-side message loading
- `src/app/[locale]/layout.tsx` - Locale layout with RTL and Arabic font
- `src/messages/en.json` - English stub translations
- `src/messages/tr.json` - Turkish stub translations
- `src/messages/ar.json` - Arabic stub translations

### Modified
- `next.config.ts` - Added next-intl plugin wrapper
- `src/proxy.ts` - Integrated i18n middleware with auth
- `src/lib/supabase/middleware.ts` - Handle locale-prefixed paths
- `src/app/layout.tsx` - Simplified to passthrough only

### Moved (to [locale] segment)
- All pages under `src/app/(main)/` → `src/app/[locale]/(main)/`
- `src/app/login/` → `src/app/[locale]/login/`
- `src/app/conversations/` → `src/app/[locale]/conversations/`
- `src/app/page.tsx` → `src/app/[locale]/page.tsx`

## Decisions Made

1. **localePrefix: 'as-needed'** - Default locale (en) doesn't need URL prefix, cleaner URLs
2. **Proxy.ts integration** - Next.js 16 uses proxy.ts not middleware.ts, integrated i18n there
3. **IBM Plex Sans Arabic** - Professional Arabic font with multiple weights for UI consistency

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Next.js 16 uses proxy.ts not middleware.ts**
- **Found during:** Task 2 (Middleware setup)
- **Issue:** Build failed - can't have both middleware.ts and proxy.ts
- **Fix:** Integrated i18n middleware into existing proxy.ts
- **Files modified:** src/proxy.ts
- **Verification:** Build passes
- **Committed in:** 5f6678f

**2. [Rule 1 - Bug] Default locale paths returning 404**
- **Found during:** Verification
- **Issue:** `/login` (without locale prefix) returned 404 due to middleware composition
- **Fix:** Return intl response for non-locale paths to preserve internal rewrite
- **Files modified:** src/proxy.ts
- **Verification:** `/login` now returns correct page with `lang="en"`
- **Committed in:** b16cdb5

---

**Total deviations:** 2 auto-fixed (1 blocking, 1 bug), 0 deferred
**Impact on plan:** Both fixes necessary for correct operation. No scope creep.

## Issues Encountered

None beyond the auto-fixed deviations above.

## Next Phase Readiness

- i18n infrastructure complete, ready for translation files
- Next plan (18.1-02) will add full translations and language switcher
- All three locales (en, tr, ar) routing and rendering correctly
- RTL direction working for Arabic

---
*Phase: 18.1-internationalization*
*Completed: 2026-01-27*
