---
phase: 19-performance-polish
plan: 04
type: execute
---

<objective>
Set up automated performance monitoring with Lighthouse CI and configure performance budgets to prevent regressions.

Purpose: Ensure performance gains are maintained over time through automated checks on every commit.
Output: Lighthouse CI workflow, performance budgets, production build verification, v4.0 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-performance-polish/RESEARCH.md
@.planning/phases/19-performance-polish/19-01-SUMMARY.md
@.planning/phases/19-performance-polish/19-02-SUMMARY.md
@.planning/phases/19-performance-polish/19-03-SUMMARY.md
@.planning/phases/19-performance-polish/BASELINE.md
@next.config.ts
@package.json

**From prior plans:**
- Bundle analyzer configured
- Code splitting implemented (~400KB saved)
- Images optimized to WebP
- Skeleton loading states complete

**Performance targets:**
- Initial JS bundle < 300KB gzipped
- Lighthouse Performance > 85 (mobile)
- LCP < 2.5s, FID < 100ms, CLS < 0.1

**Pattern from RESEARCH.md:**
- Lighthouse CI for automated audits
- Performance budgets in next.config.ts
- Production build verification (dev builds are larger)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure performance budgets in next.config.ts</name>
  <files>next.config.ts</files>
  <action>
Add performance budgets to Next.js config to catch bundle size regressions:

```typescript
import type { NextConfig } from "next";
import bundleAnalyzer from '@next/bundle-analyzer';

const withBundleAnalyzer = bundleAnalyzer({
  enabled: process.env.ANALYZE === 'true',
});

const nextConfig: NextConfig = {
  webpack: (config, { isServer }) => {
    // Performance budgets for client bundle
    if (!isServer) {
      config.performance = {
        hints: 'warning',
        maxEntrypointSize: 300000,  // 300KB - initial bundle limit
        maxAssetSize: 200000,       // 200KB - max chunk size
      };
    }
    return config;
  },
};

export default withBundleAnalyzer(nextConfig);
```

These budgets trigger webpack warnings during build if exceeded:
- maxEntrypointSize: 300KB = our target for initial page load
- maxAssetSize: 200KB = prevents any single chunk from being too large

Why 300KB: Our target from RESEARCH.md. Allows ~250KB code + 50KB overhead.
Why warnings not errors: Gives visibility without blocking builds. Can adjust if needed.
  </action>
  <verify>npm run build shows performance budget warnings if limits exceeded, no build failures</verify>
  <done>Performance budgets configured with 300KB entrypoint and 200KB asset limits</done>
</task>

<task type="auto">
  <name>Task 2: Set up Lighthouse CI workflow</name>
  <files>.github/workflows/lighthouse.yml, lighthouserc.json, package.json</files>
  <action>
Create automated Lighthouse audits that run on every push:

1. **Create .github/workflows/ directory:**
```bash
mkdir -p .github/workflows
```

2. **Create lighthouse.yml workflow:**
```yaml
name: Lighthouse CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build production
        run: npm run build

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
```

3. **Create lighthouserc.json config:**
```json
{
  "ci": {
    "collect": {
      "startServerCommand": "npm run start",
      "startServerReadyPattern": "Local:",
      "url": [
        "http://localhost:3000/",
        "http://localhost:3000/inbox",
        "http://localhost:3000/dashboard",
        "http://localhost:3000/agents"
      ],
      "numberOfRuns": 3
    },
    "assert": {
      "preset": "lighthouse:recommended",
      "assertions": {
        "categories:performance": ["error", { "minScore": 0.85 }],
        "categories:accessibility": ["warn", { "minScore": 0.9 }],
        "first-contentful-paint": ["warn", { "maxNumericValue": 1500 }],
        "largest-contentful-paint": ["error", { "maxNumericValue": 2500 }],
        "cumulative-layout-shift": ["error", { "maxNumericValue": 0.1 }],
        "total-blocking-time": ["warn", { "maxNumericValue": 300 }]
      }
    },
    "upload": {
      "target": "temporary-public-storage"
    }
  }
}
```

4. **Add Lighthouse CI to package.json devDependencies:**
```bash
npm install --save-dev @lhci/cli
```

5. **Add local audit script to package.json:**
```json
"scripts": {
  "lighthouse": "lhci autorun"
}
```

Why 3 runs: Lighthouse scores vary slightly between runs. Multiple runs provide average.
Why temporary-public-storage: Free storage for viewing reports. Can upgrade to LHCI server later.
Why error vs warn: Errors fail CI (performance, LCP, CLS). Warnings notify but don't block (FCP, TBT, accessibility).
  </action>
  <verify>Lighthouse workflow file exists in .github/workflows/, lighthouserc.json exists, @lhci/cli installed in devDependencies</verify>
  <done>Lighthouse CI configured with automated audits for 4 key pages and strict performance budgets</done>
</task>

<task type="auto">
  <name>Task 3: Run production build verification and document final metrics</name>
  <files>.planning/phases/19-performance-polish/FINAL-METRICS.md</files>
  <action>
Verify all optimizations in production build and document improvements:

1. **Run production build with bundle analysis:**
```bash
npm run build
ANALYZE=true npm run build
```

2. **Start production server and run Lighthouse:**
```bash
npm run build
npm run start
# Open Chrome DevTools → Lighthouse
# Run Mobile audit on http://localhost:3000/dashboard
```

3. **Create FINAL-METRICS.md:**
```markdown
# Final Performance Metrics - Post-Optimization

**Date:** 2026-01-27
**Environment:** Production build (npm run build + npm run start)

## Bundle Analysis

### Before Optimization (from BASELINE.md)
- Initial bundle: ~800KB+ (estimated)
- recharts in main bundle: ~400KB
- All imports synchronous

### After Optimization
- Initial bundle: XXX KB (measured)
- recharts in Dashboard chunk only: ~400KB
- Bundle reduction: ~XXX KB (~XX%)

### Chunk Breakdown (from bundle analyzer)
- Main bundle: XXX KB
- Dashboard chunk: XXX KB (includes recharts)
- Other chunks: [list]

## Lighthouse Scores

### Dashboard Page (Mobile)
**Before:** (from BASELINE.md)
- Performance: XX/100
- FCP: X.Xs
- LCP: X.Xs
- CLS: 0.XX

**After:**
- Performance: XX/100 (↑ XX)
- FCP: X.Xs (↓ X.Xs)
- LCP: X.Xs (↓ X.Xs)
- TBT: XXXms
- CLS: 0.XX (↓ 0.XX)

### Inbox Page (Mobile)
- Performance: XX/100
- LCP: X.Xs
- CLS: 0.XX

### Agents Page (Mobile)
- Performance: XX/100
- LCP: X.Xs
- CLS: 0.XX

## Optimizations Delivered

1. ✅ Bundle analyzer configured
2. ✅ Code splitting: recharts → Dashboard-only chunk (~400KB saved)
3. ✅ Dynamic imports with loading states
4. ✅ Error boundaries for chunk failures
5. ✅ Image optimization: Logo PNG → WebP
6. ✅ Skeleton loading components (5 components)
7. ✅ Suspense boundaries on key pages
8. ✅ Performance budgets: 300KB entrypoint, 200KB chunks
9. ✅ Lighthouse CI: Automated audits on every push

## Target Achievement

| Metric | Target | Achieved | Status |
|--------|--------|----------|--------|
| Initial bundle | < 300KB | XXX KB | ✅/❌ |
| Lighthouse Perf | > 85 | XX | ✅/❌ |
| LCP | < 2.5s | X.Xs | ✅/❌ |
| FID | < 100ms | XXms | ✅/❌ |
| CLS | < 0.1 | 0.XX | ✅/❌ |

## Next Steps (if targets not met)

[If any targets missed, note what additional optimization would help]
[If all targets met: "All targets achieved. Phase 19 complete."]

## v4.0 Mobile Compatibility - COMPLETE

Phase 19 marks completion of v4.0 milestone:
- ✅ Phase 15: Mobile Foundation (breakpoints, design tokens)
- ✅ Phase 16: Navigation & Mobile UX (bottom nav, drawer)
- ✅ Phase 17: Core Pages Responsive (inbox, dashboard, agents)
- ✅ Phase 18: Secondary Pages Responsive (voice, documents)
- ✅ Phase 19: Performance & Polish (bundle optimization, loading states, CI)

**v4.0 Achievement:** Professional mobile-compatible platform with responsive design, optimized performance, and automated quality checks.
```

Fill in actual measurements from bundle analyzer and Lighthouse. Compare to BASELINE.md to show improvements.

If targets aren't met: Document what else could be tried (virtual scrolling, further splitting, etc.) but don't implement - this phase is about establishing the foundation and measurement, not perfection.
  </action>
  <verify>FINAL-METRICS.md exists with production build measurements comparing baseline to final metrics</verify>
  <done>Production build verified, final metrics documented, v4.0 milestone complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds with performance budget output
- [ ] Lighthouse CI workflow file committed to .github/workflows/
- [ ] lighthouserc.json exists with correct assertions
- [ ] @lhci/cli installed in devDependencies
- [ ] FINAL-METRICS.md documents production build measurements
- [ ] Bundle analyzer shows recharts in separate chunk (not main)
- [ ] All Phase 19 optimizations verified in production
</verification>

<success_criteria>

- Performance budgets enforced in webpack config
- Lighthouse CI automated for continuous monitoring
- Production build verified with final metrics documented
- All optimizations from Plans 01-04 working in production
- v4.0 Mobile Compatibility milestone complete
- Phase 19 complete and ready for v5.0 planning
</success_criteria>

<output>
After completion, create `.planning/phases/19-performance-polish/19-04-SUMMARY.md`:

# Phase 19-04 Summary: Performance CI & Polish

**Automated performance monitoring established with Lighthouse CI and production build verified.**

## Accomplishments

- Configured performance budgets (300KB entrypoint, 200KB chunks)
- Set up Lighthouse CI workflow for automated audits
- Verified all optimizations in production build
- Documented final performance metrics vs baseline
- Completed v4.0 Mobile Compatibility milestone

## Files Created/Modified

- `next.config.ts` - Added performance budgets
- `.github/workflows/lighthouse.yml` - Lighthouse CI automation
- `lighthouserc.json` - Lighthouse assertions and config
- `package.json` - Added @lhci/cli, lighthouse script
- `.planning/phases/19-performance-polish/FINAL-METRICS.md` - Final measurements

## Decisions Made

- 300KB entrypoint budget (allows ~250KB code + overhead)
- 200KB per-chunk budget (prevents oversized splits)
- Lighthouse errors for: performance < 85, LCP > 2.5s, CLS > 0.1
- Lighthouse warnings for: FCP, TBT, accessibility
- 3 runs per audit for consistency

## Performance Achievements

**Bundle Optimization:**
- Initial bundle reduced by ~400KB (recharts to Dashboard chunk)
- Code splitting with dynamic imports
- Error boundaries for graceful failures

**Loading Experience:**
- Skeleton loading states prevent layout shift
- WebP images reduce payload
- Suspense boundaries for async data

**Continuous Monitoring:**
- Automated Lighthouse audits on every push
- Performance budgets prevent regressions
- Public reports for tracking over time

## v4.0 Complete

Phase 19 completes the v4.0 Mobile Compatibility milestone:
- 5 phases (15-19)
- 11 plans total
- Professional responsive design with optimized performance

## Issues Encountered

[Note any issues, or "None"]

## Next Phase

v4.0 complete. Ready for v5.0 milestone planning.

Potential v5.0 features:
- Real backend integrations (Voice provider, Document processing)
- Message search and filtering
- Dashboard with real metrics
- E2E testing and deployment readiness
</output>
