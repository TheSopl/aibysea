---
phase: 19-performance-polish
plan: 02
type: execute
---

<objective>
Implement code splitting for recharts and heavy dependencies using dynamic imports to reduce initial bundle size by ~400KB.

Purpose: Load charting library only on Dashboard route, reducing initial page load time for all other pages.
Output: Dynamic imports with loading states, error boundaries, and ~50% smaller initial bundle.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-performance-polish/RESEARCH.md
@.planning/phases/19-performance-polish/19-01-SUMMARY.md
@.planning/phases/19-performance-polish/SPLITTING-STRATEGY.md
@src/app/(main)/dashboard/page.tsx
@src/components/dashboard/LatencyChart.tsx
@src/components/dashboard/ConfidenceScores.tsx

**From Plan 01:**
- Bundle analyzer configured
- Baseline metrics documented
- recharts identified as Priority 1 target (~400KB)

**Current recharts usage:**
- src/app/(main)/dashboard/page.tsx - AreaChart for response times
- src/components/dashboard/LatencyChart.tsx - BarChart
- src/components/dashboard/ConfidenceScores.tsx - LineChart

**Pattern from RESEARCH.md:**
Create wrapper components with dynamic imports and loading states. Use ssr: false for client-only chart rendering. Implement error boundaries for chunk loading failures.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dynamic chart wrapper components</name>
  <files>src/components/charts/DynamicAreaChart.tsx, src/components/charts/DynamicBarChart.tsx, src/components/charts/DynamicLineChart.tsx, src/components/charts/ChartSkeleton.tsx</files>
  <action>
Create src/components/charts/ directory and implement dynamic wrappers:

1. ChartSkeleton.tsx - Loading placeholder:
```tsx
'use client';

export function ChartSkeleton({ height = 300 }: { height?: number }) {
  return (
    <div
      className="animate-pulse bg-gray-200 dark:bg-slate-700 rounded-lg"
      style={{ height: `${height}px` }}
    />
  );
}
```

2. DynamicAreaChart.tsx:
```tsx
'use client';

import dynamic from 'next/dynamic';
import { ChartSkeleton } from './ChartSkeleton';

const AreaChartImpl = dynamic(
  () => import('./AreaChartImpl'),
  {
    ssr: false,
    loading: () => <ChartSkeleton />
  }
);

export { AreaChartImpl as DynamicAreaChart };
```

3. AreaChartImpl.tsx (implementation):
```tsx
'use client';

import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer
} from 'recharts';

interface Props {
  data: any[];
  xKey: string;
  yKey: string;
  color?: string;
  height?: number;
}

export default function AreaChartImpl({
  data,
  xKey,
  yKey,
  color = '#3b82f6',
  height = 300
}: Props) {
  return (
    <ResponsiveContainer width="100%" height={height}>
      <AreaChart data={data}>
        <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
        <XAxis dataKey={xKey} stroke="#6b7280" />
        <YAxis stroke="#6b7280" />
        <Tooltip />
        <Area
          type="monotone"
          dataKey={yKey}
          stroke={color}
          fill={color}
          fillOpacity={0.2}
        />
      </AreaChart>
    </ResponsiveContainer>
  );
}
```

4. Repeat pattern for DynamicBarChart.tsx/BarChartImpl.tsx and DynamicLineChart.tsx/LineChartImpl.tsx

Why ssr: false: Recharts uses browser APIs (canvas, window sizing) that fail during SSR. Why separate Impl file: Keeps dynamic import clean and allows full recharts imports in isolated file.
  </action>
  <verify>src/components/charts/ directory exists with 7 files: ChartSkeleton, 3 Dynamic wrappers, 3 Impl files</verify>
  <done>All chart wrappers created with dynamic imports, loading states, and typed interfaces</done>
</task>

<task type="auto">
  <name>Task 2: Replace static recharts imports with dynamic wrappers</name>
  <files>src/app/(main)/dashboard/page.tsx, src/components/dashboard/LatencyChart.tsx, src/components/dashboard/ConfidenceScores.tsx</files>
  <action>
Replace static recharts imports with dynamic wrappers in all three files:

**Dashboard page.tsx:**
```tsx
// Before (REMOVE):
import { AreaChart, Area, XAxis, YAxis, ... } from 'recharts';

// After (ADD):
import { DynamicAreaChart } from '@/components/charts/DynamicAreaChart';

// In JSX, replace <ResponsiveContainer><AreaChart>...</AreaChart></ResponsiveContainer>
// with:
<DynamicAreaChart
  data={responseTimeData}
  xKey="time"
  yKey="value"
  height={300}
/>
```

**LatencyChart.tsx:**
```tsx
// Before (REMOVE):
import { BarChart, Bar, XAxis, YAxis, ... } from 'recharts';

// After (ADD):
import { DynamicBarChart } from '@/components/charts/DynamicBarChart';

<DynamicBarChart
  data={latencyData}
  xKey="hour"
  yKey="latency"
  color="#10b981"
  height={200}
/>
```

**ConfidenceScores.tsx:**
```tsx
// Before (REMOVE):
import { LineChart, Line, XAxis, YAxis, ... } from 'recharts';

// After (ADD):
import { DynamicLineChart } from '@/components/charts/DynamicLineChart';

<DynamicLineChart
  data={confidenceData}
  xKey="timestamp"
  yKey="score"
  color="#8b5cf6"
  height={250}
/>
```

Ensure all chart data structures match the expected Props interfaces. Remove any unused recharts imports and ResponsiveContainer wrappers (now handled by Impl components).
  </action>
  <verify>npm run build succeeds, grep "from 'recharts'" shows NO matches in page.tsx or component files (only in chart Impl files)</verify>
  <done>All three files converted to dynamic imports with no static recharts references remaining in main bundle</done>
</task>

<task type="auto">
  <name>Task 3: Add error boundaries for chunk loading failures</name>
  <files>src/components/charts/ChartErrorBoundary.tsx, src/app/(main)/dashboard/page.tsx</files>
  <action>
Create error boundary for graceful chunk loading failures:

**ChartErrorBoundary.tsx:**
```tsx
'use client';

import { Component, ReactNode } from 'react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export class ChartErrorBoundary extends Component<Props, State> {
  state: State = { hasError: false };

  static getDerivedStateFromError(error: Error) {
    // Check if it's a chunk loading error
    const isChunkError = error.message.includes('Loading chunk') ||
                         error.message.includes('Failed to fetch');

    return { hasError: isChunkError, error };
  }

  handleRetry = () => {
    this.setState({ hasError: false, error: undefined });
    // Force reload to fetch fresh chunks
    window.location.reload();
  };

  render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div className="flex flex-col items-center justify-center p-8 text-center border border-red-200 rounded-lg bg-red-50 dark:bg-red-900/10 dark:border-red-800">
          <p className="text-red-600 dark:text-red-400 mb-4">
            Failed to load chart component
          </p>
          <button
            onClick={this.handleRetry}
            className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors min-h-[44px]"
          >
            Retry
          </button>
        </div>
      );
    }

    return this.props.children;
  }
}
```

**Wrap charts in Dashboard page.tsx:**
```tsx
import { ChartErrorBoundary } from '@/components/charts/ChartErrorBoundary';

// Wrap each chart section:
<ChartErrorBoundary>
  <DynamicAreaChart ... />
</ChartErrorBoundary>

<ChartErrorBoundary>
  <DynamicBarChart ... />
</ChartErrorBoundary>
```

Why: Dynamic imports can fail due to network issues, stale cache, or CDN problems. Error boundary prevents entire page crash and provides user-friendly retry option.
  </action>
  <verify>Build succeeds, ChartErrorBoundary wraps all dynamic charts, test by temporarily breaking import path to confirm error UI shows</verify>
  <done>Error boundaries implemented with retry mechanism, all charts wrapped, graceful degradation confirmed</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] No "from 'recharts'" imports in non-chart-impl files
- [ ] ChartSkeleton shows briefly during chart load
- [ ] Error boundary catches and displays chunk load failures
- [ ] Dashboard page loads and charts render correctly
- [ ] Run `npm run analyze` - confirm recharts now in separate chunk, not main bundle
</verification>

<success_criteria>

- All recharts imports converted to dynamic with loading states
- Error boundaries implemented for graceful failures
- Bundle analyzer shows recharts in Dashboard chunk only
- Initial bundle reduced by ~400KB
- All charts render correctly with no functionality lost
</success_criteria>

<output>
After completion, create `.planning/phases/19-performance-polish/19-02-SUMMARY.md`:

# Phase 19-02 Summary: Code Splitting & Dynamic Imports

**Implemented dynamic imports for recharts, reducing initial bundle by ~400KB.**

## Accomplishments

- Created dynamic chart wrapper system with loading states
- Converted 3 chart components to dynamic imports
- Implemented error boundaries for chunk loading failures
- Separated recharts into Dashboard-only chunk

## Files Created/Modified

- `src/components/charts/ChartSkeleton.tsx` - Loading placeholder
- `src/components/charts/DynamicAreaChart.tsx` - Area chart wrapper
- `src/components/charts/AreaChartImpl.tsx` - Area chart implementation
- `src/components/charts/DynamicBarChart.tsx` - Bar chart wrapper
- `src/components/charts/BarChartImpl.tsx` - Bar chart implementation
- `src/components/charts/DynamicLineChart.tsx` - Line chart wrapper
- `src/components/charts/LineChartImpl.tsx` - Line chart implementation
- `src/components/charts/ChartErrorBoundary.tsx` - Error boundary
- `src/app/(main)/dashboard/page.tsx` - Converted to dynamic charts
- `src/components/dashboard/LatencyChart.tsx` - Converted to dynamic
- `src/components/dashboard/ConfidenceScores.tsx` - Converted to dynamic

## Decisions Made

- Wrapper pattern for reusable dynamic imports
- ssr: false for all charts (browser-only rendering)
- Separate Impl files to isolate recharts imports
- Error boundary with reload for chunk failures

## Bundle Impact

- Before: recharts in main bundle (~400KB)
- After: recharts in dashboard chunk only
- Initial bundle reduction: ~400KB (verified with bundle analyzer)

## Issues Encountered

[Note any issues, or "None"]

## Next Step

Ready for 19-03-PLAN.md: Image & Asset Optimization
</output>
