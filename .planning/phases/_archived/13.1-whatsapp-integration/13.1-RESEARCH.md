# Phase 13.1: WhatsApp Integration - Research

**Researched:** 2026-01-20
**Domain:** WhatsApp Cloud API integration, Meta Business Platform
**Confidence:** HIGH

<research_summary>
## Summary

Researched WhatsApp Cloud API integration patterns to complete the messaging infrastructure started in v1.0. The project already has comprehensive WhatsApp infrastructure built (`src/lib/whatsapp/`, `src/services/whatsapp/`, webhook handler) but Phase 13 skipped WhatsApp testing due to missing Meta dashboard configuration.

**Context:** This is NOT greenfield - v1.0 built complete WhatsApp infrastructure including webhook verification (HMAC-SHA256), message processor, client for sending text/template messages, and TypeScript types via `@whatsapp-cloudapi/types`. Phase 13.1 needs to verify this infrastructure works end-to-end and add any missing pieces.

**Primary recommendation:** Verify and test existing infrastructure end-to-end. Add WhatsApp send endpoint (like Telegram has), configure Meta dashboard, and ensure the `/inbox` page works with WhatsApp messages.
</research_summary>

<standard_stack>
## Standard Stack

### Already Implemented (v1.0)
| Library | Version | Purpose | Status |
|---------|---------|---------|--------|
| @whatsapp-cloudapi/types | ^1.x | Zero-runtime TypeScript types | Installed |
| Node.js crypto | Built-in | HMAC-SHA256 signature verification | Implemented |

### What's Built
- `src/lib/whatsapp/signature.ts` - HMAC-SHA256 verification with timingSafeEqual
- `src/lib/whatsapp/client.ts` - sendTextMessage, sendTemplateMessage, isWithin24HourWindow
- `src/lib/whatsapp/types.ts` - Re-exports from @whatsapp-cloudapi/types + custom bridge types
- `src/lib/whatsapp/constants.ts` - API URL builder, token getters
- `src/services/whatsapp/processor.ts` - Full webhook processor with contact/conversation creation
- `src/app/api/webhooks/whatsapp/route.ts` - GET (verification) + POST (webhook receiver)

### Missing Components
| Component | Purpose | Priority |
|-----------|---------|----------|
| `/api/whatsapp/send` endpoint | Send messages from inbox UI | HIGH |
| Media download handler | Download images/audio/video/docs | MEDIUM |
| Interactive message support | Buttons, lists, quick replies | LOW |
| Template management UI | Manage message templates | DEFERRED |

### NPM Packages Available (Not Currently Used)
| Library | Purpose | When to Use |
|---------|---------|-------------|
| whatsapp (official) | Official Meta Node.js SDK | Only if rebuilding from scratch |
| @great-detail/whatsapp | Community SDK with TypeScript | If need more abstraction |
| @whatsapp-cloudapi/emulator | Local testing without Meta | Development/testing |

**Note:** Current implementation uses direct `fetch()` calls to Graph API - this is fine and avoids SDK dependencies. Official SDK requires Node 16+ which we have.
</standard_stack>

<architecture_patterns>
## Architecture Patterns

### Current Implementation Pattern (Good)
```
Webhook → Route Handler → Processor → Supabase
                ↓
         Signature Verify (fail fast)
                ↓
         Parse JSON
                ↓
         Process Async (don't await - respond < 5s)
```

### Pattern 1: Webhook Processing (Already Implemented)
**What:** Async processing with immediate 200 response
**Why:** Meta requires response within 5 seconds or retries
**Current Code:**
```typescript
// Process webhook asynchronously - DO NOT await
processWebhook(payload).catch((error) => {
  console.error('[WhatsApp Webhook] Processing error:', error);
});
// Respond immediately with 200 OK
return NextResponse.json({ status: 'ok' }, { status: 200 });
```

### Pattern 2: 24-Hour Window Enforcement (Already Implemented)
**What:** Check window before sending free-form vs template
**Current Code:**
```typescript
export function isWithin24HourWindow(lastCustomerMessageAt: string | null): boolean {
  if (!lastCustomerMessageAt) return false;
  const hoursDiff = (now.getTime() - lastMessage.getTime()) / (1000 * 60 * 60);
  return hoursDiff < 24;
}
```

### Pattern 3: Message Deduplication (Already Implemented)
**What:** Store whatsapp_message_id and check before insert
**Why:** Meta retries webhooks, causing duplicate messages
**Current:** Uses `whatsapp_message_id` column in messages table

### Pattern 4: Send Endpoint (NEEDED)
**What:** API endpoint for inbox UI to send messages
**Pattern:** Mirror the existing Telegram send endpoint
```
/api/whatsapp/send
POST { conversationId, content }
  → Get conversation → Get contact phone
  → Check 24h window → sendTextMessage or sendTemplateMessage
  → Save to DB with direction: 'outbound', sender_type: 'agent'
```

### Anti-Patterns to Avoid
- **Awaiting webhook processing:** Will cause Meta retries and duplicate messages
- **Trusting webhook without signature:** Security vulnerability
- **Storing sensitive tokens in code:** Use environment variables (already done)
- **Ignoring 24-hour window:** Will cause API errors (131047)
</architecture_patterns>

<dont_hand_roll>
## Don't Hand-Roll

| Problem | Already Solved | Why |
|---------|---------------|-----|
| Signature verification | `src/lib/whatsapp/signature.ts` | Already uses timingSafeEqual correctly |
| Message types | `@whatsapp-cloudapi/types` | Comprehensive webhook/API types |
| Phone number normalization | `normalizePhoneNumber()` | Handles +, spaces, dashes |
| 24h window check | `isWithin24HourWindow()` | Already implemented |
| Contact/conversation creation | `processor.ts` | Already handles find-or-create |

**Key insight:** The v1.0 implementation is solid. Don't rewrite - extend and verify.
</dont_hand_roll>

<common_pitfalls>
## Common Pitfalls

### Pitfall 1: Webhook Timeout (Meta Retries)
**What goes wrong:** Webhook handler takes >5 seconds, Meta retries, duplicates occur
**Why it happens:** Awaiting slow database operations in webhook handler
**How to avoid:** Process async, respond immediately (already implemented)
**Warning signs:** Duplicate messages in database, Meta retry logs

### Pitfall 2: 24-Hour Window Expired (Error 131047)
**What goes wrong:** Sending free-form message outside 24h window fails
**Why it happens:** Customer hasn't messaged in 24 hours
**How to avoid:** Check `last_customer_message_at`, use template if expired
**Warning signs:** Error code 131047 in logs

### Pitfall 3: Pair Rate Limit (Error 131056)
**What goes wrong:** Too many messages to same user in short time
**Why it happens:** Sending multiple messages rapidly to same number
**How to avoid:** Implement backoff, rate limit per-conversation
**Warning signs:** Error code 131056, messages failing to specific users

### Pitfall 4: Media URL Expiry
**What goes wrong:** Media URL returned by API expires after 5 minutes
**Why it happens:** Graph API returns temporary signed URLs
**How to avoid:** Download immediately and store in own storage
**Warning signs:** Broken media links in UI, 404s when fetching

### Pitfall 5: Raw Body Parsing for Signature
**What goes wrong:** Signature verification fails after body parsing
**Why it happens:** `express.json()` or `request.json()` modifies body
**How to avoid:** Use `request.text()` first for signature, then parse (already implemented)
**Warning signs:** All webhooks returning 401

### Pitfall 6: Template Not Approved
**What goes wrong:** Template message fails with error 132001
**Why it happens:** Using template name before Meta approval
**How to avoid:** Check template status in WhatsApp Manager before using
**Warning signs:** Error code 132001 in logs
</common_pitfalls>

<code_examples>
## Code Examples

### Send Message Endpoint (Pattern to Implement)
```typescript
// src/app/api/whatsapp/send/route.ts
// Based on existing /api/telegram/send/route.ts pattern

import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { sendTextMessage, isWithin24HourWindow } from '@/lib/whatsapp/client';

export async function POST(request: NextRequest) {
  const supabase = await createClient();
  const { conversationId, content } = await request.json();

  // Get conversation with contact
  const { data: conversation } = await supabase
    .from('conversations')
    .select('*, contact:contacts(*)')
    .eq('id', conversationId)
    .single();

  if (!conversation?.contact?.phone) {
    return NextResponse.json({ error: 'Contact not found' }, { status: 404 });
  }

  // Check 24h window
  if (!isWithin24HourWindow(conversation.last_customer_message_at)) {
    return NextResponse.json({
      error: '24-hour window expired - template required'
    }, { status: 400 });
  }

  // Send via WhatsApp Cloud API
  const result = await sendTextMessage(conversation.contact.phone, content);

  // Save to database
  await supabase.from('messages').insert({
    conversation_id: conversationId,
    direction: 'outbound',
    content,
    content_type: 'text',
    sender_type: 'agent',
    whatsapp_message_id: result.messages[0].id,
  });

  return NextResponse.json({ success: true, messageId: result.messages[0].id });
}
```

### Existing Webhook Handler (Already Correct)
```typescript
// Current implementation in src/app/api/webhooks/whatsapp/route.ts
// This is correct - keep it

// Get raw body for signature verification
const rawBody = await request.text();

// Verify signature BEFORE parsing
if (!verifySignature(rawBody, signature)) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}

// Now safe to parse
const payload = JSON.parse(rawBody) as WebhookPayload;

// Process async - DON'T await
processWebhook(payload).catch(console.error);

// Respond immediately
return NextResponse.json({ status: 'ok' }, { status: 200 });
```

### Environment Variables Required
```env
# WhatsApp Cloud API Configuration
WHATSAPP_PHONE_NUMBER_ID=your_phone_number_id
WHATSAPP_ACCESS_TOKEN=your_access_token
WHATSAPP_WEBHOOK_VERIFY_TOKEN=your_custom_verify_token
WHATSAPP_APP_SECRET=your_app_secret
WHATSAPP_API_VERSION=v21.0
```
</code_examples>

<sota_updates>
## State of the Art (2025-2026)

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Conversation pricing | Per-message pricing | Jan 2026 | Template costs change, utility in 24h free |
| Per-number limits | Portfolio-level limits | Oct 2025 | Limits apply to business account, not number |
| 80 MPS default | Auto-upgrade to 1000 MPS | 2025 | High-quality accounts get faster throughput |

**New in 2025-2026:**
- **Per-Message Pricing:** Template messages now billed per message (not conversation)
- **Free Utility in 24h:** Utility templates within customer service window are FREE
- **Portfolio Limits:** Messaging limits now at business portfolio level, not phone number
- **Graph API v21.0:** Current stable version (project already uses this)

**Deprecated/Outdated:**
- Conversation-based billing (replaced by per-message)
- Per-phone-number messaging limits (now portfolio-level)
</sota_updates>

<meta_dashboard_setup>
## Meta Dashboard Configuration (Required for Phase 13.1)

### Prerequisites
1. Meta Business Account (verified)
2. WhatsApp Business Account linked to Meta Business
3. App created in Meta Developer Dashboard

### Configuration Steps

**1. Create/Select App:**
- Go to Meta Developer Dashboard
- Create new app or select existing (type: Business)
- Add "WhatsApp" product to app

**2. Get Credentials:**
- Phone Number ID: From WhatsApp > API Setup
- Access Token: Generate permanent token via System User
- App Secret: From App Settings > Basic
- Verify Token: Create custom string for webhook verification

**3. Configure Webhook:**
- Webhook URL: `https://your-domain.com/api/webhooks/whatsapp`
- Verify Token: Same as WHATSAPP_WEBHOOK_VERIFY_TOKEN env var
- Subscribe to: `messages` field

**4. Test Phone Number:**
- Use test phone number for development
- Or register production number with business verification

### Webhook Subscription Fields
Subscribe to these webhook fields:
- `messages` - Required for receiving messages
- `message_deliveries` - Optional, for delivery receipts
- `message_reads` - Optional, for read receipts
</meta_dashboard_setup>

<open_questions>
## Open Questions

1. **Media Handling Strategy**
   - What we know: WhatsApp sends media URLs that expire in 5 minutes
   - What's unclear: Should we download and store media, or just display placeholder?
   - Recommendation: Start with placeholder (current behavior), add media download in future phase

2. **Template Message UI**
   - What we know: Templates required outside 24h window
   - What's unclear: What templates does the business have approved?
   - Recommendation: For MVP, show error when 24h expired; add template selector later

3. **Interactive Messages**
   - What we know: Buttons/lists work within session without approval
   - What's unclear: Will the business need interactive message support?
   - Recommendation: Defer to future phase unless explicitly needed
</open_questions>

<sources>
## Sources

### Primary (HIGH confidence)
- Existing codebase analysis: `src/lib/whatsapp/`, `src/services/whatsapp/`
- Phase 13-01 Summary: Documented WhatsApp was skipped due to Meta dashboard
- @whatsapp-cloudapi/types npm package documentation

### Secondary (MEDIUM confidence)
- [WhatsApp Cloud API Security Guide 2026](https://www.wuseller.com/whatsapp-business-knowledge-hub/whatsapp-cloud-api-security-2026-privacy-compliance-guide-for-business/)
- [WhatsApp API Rate Limits Guide](https://www.wati.io/en/blog/whatsapp-business-api/whatsapp-api-rate-limits/)
- [WhatsApp Business API Compliance 2026](https://gmcsco.com/your-simple-guide-to-whatsapp-api-compliance-2026/)
- [WhatsApp API Error Codes Guide](https://www.heltar.com/blogs/all-meta-error-codes-explained-along-with-complete-troubleshooting-guide-2025-cm69x5e0k000710xtwup66500)
- [WhatsApp Interactive Messages Guide](https://www.delightchat.io/blog/whatsapp-list-message-reply-buttons-interactive-message)

### Meta Official (verified via WebSearch)
- Webhook signature verification uses HMAC-SHA256 with X-Hub-Signature-256 header
- 5-second webhook response requirement confirmed
- 24-hour customer service window confirmed
- Per-message pricing change effective January 2026 confirmed
</sources>

<metadata>
## Metadata

**Research scope:**
- Core technology: WhatsApp Cloud API (Graph API v21.0)
- Ecosystem: @whatsapp-cloudapi/types, existing infrastructure
- Patterns: Webhook handling, 24h window, deduplication, send endpoint
- Pitfalls: Timeout, rate limits, media expiry, signature verification

**Confidence breakdown:**
- Standard stack: HIGH - Existing codebase already implements correctly
- Architecture: HIGH - Patterns verified against current implementation
- Pitfalls: HIGH - Documented in error code guides, some already mitigated
- Code examples: HIGH - Based on existing working patterns in codebase

**Research date:** 2026-01-20
**Valid until:** 2026-02-20 (30 days - WhatsApp API stable, pricing change already effective)
</metadata>

<complete_setup_guide>
## Complete Meta Dashboard Setup Guide

This is the critical path. Follow these steps exactly to avoid hidden gotchas.

### Prerequisites Checklist
- [ ] Meta personal account (your Facebook login)
- [ ] Meta Business account at business.facebook.com
- [ ] Phone number NOT linked to any WhatsApp account (personal or business app)
- [ ] Valid business website with privacy policy page
- [ ] Business documents ready (registration certificate, tax ID, or utility bill)

### Phase 1: Create Meta Developer App (10 min)

**Step 1.1: Access Developer Portal**
```
1. Go to developers.facebook.com
2. Log in with your Facebook account
3. Click "My Apps" in top right
4. Click "Create App"
```

**Step 1.2: Create Business App**
```
1. Select use case: "Other"
2. Select app type: "Business"
3. App name: Your project name (e.g., "AI BY SEA WhatsApp")
4. Contact email: Your business email
5. Business Account: Select your Meta Business account
6. Click "Create App"
```

**Step 1.3: Add WhatsApp Product**
```
1. On App Dashboard, scroll to "Add products to your app"
2. Find "WhatsApp" tile
3. Click "Set up"
4. This creates a WhatsApp Business Account (WABA) or links existing one
```

### Phase 2: Get Credentials (15 min)

**Step 2.1: Get Phone Number ID**
```
1. In left menu: WhatsApp > API Setup
2. Under "Send and receive messages"
3. Note the "Phone number ID" (starts with numbers)
4. This is your WHATSAPP_PHONE_NUMBER_ID
```

**Step 2.2: Get App Secret**
```
1. In left menu: App Settings > Basic
2. Find "App Secret" field
3. Click "Show" button
4. Copy the secret
5. This is your WHATSAPP_APP_SECRET
```

**Step 2.3: Create Permanent Access Token (CRITICAL)**

⚠️ **WARNING: The temporary token on API Setup page expires in 24 hours. You MUST create a permanent token.**

```
1. Go to business.facebook.com
2. Business Settings > Users > System Users
3. Click "Add" to create new system user
4. Name: "whatsapp-api" (or similar)
5. Role: Admin
6. Click "Create System User"

Now assign assets:
7. Click "Assign Assets" button
8. Select "Apps" in left column
9. Check your WhatsApp app
10. Enable "Full control"
11. Click "Assign assets"

Now link to WhatsApp:
12. Go to Business Settings > Accounts > WhatsApp Accounts
13. Select your WhatsApp account
14. Go to "People" tab
15. Click "Add People"
16. Select the system user you created
17. Assign "Full Control"

Now generate token:
18. Go back to Business Settings > Users > System Users
19. Click on your system user
20. Click "Generate New Token"
21. Select your app from dropdown
22. Enable permissions:
    - whatsapp_business_management
    - whatsapp_business_messaging
23. Token expiration: "Never" (or 60 days if you prefer)
24. Click "Generate Token"
25. COPY THIS TOKEN IMMEDIATELY - you cannot see it again!
26. This is your WHATSAPP_ACCESS_TOKEN
```

**Step 2.4: Create Verify Token**
```
1. Create a random secure string (e.g., use: openssl rand -hex 32)
2. Example: "my_secure_verify_token_abc123"
3. This is your WHATSAPP_WEBHOOK_VERIFY_TOKEN
4. You'll use this same string in Meta dashboard
```

### Phase 3: Configure Webhook (10 min)

**Step 3.1: Deploy Your App First**
Your webhook endpoint must be live and accessible via HTTPS before configuring in Meta.

```
# Verify your endpoint is accessible
curl https://your-domain.com/api/webhooks/whatsapp

# Should return something (even an error is fine - means it's reachable)
```

**Step 3.2: Configure Webhook in Meta**
```
1. Go to developers.facebook.com > Your App
2. In left menu: WhatsApp > Configuration
3. Under "Webhook", click "Edit"
4. Callback URL: https://your-domain.com/api/webhooks/whatsapp
5. Verify Token: Same as WHATSAPP_WEBHOOK_VERIFY_TOKEN
6. Click "Verify and Save"
```

**Step 3.3: Subscribe to Webhook Fields**
```
1. After verification succeeds, you'll see webhook fields
2. Click "Manage" next to your webhook
3. Subscribe to these fields:
   - messages (REQUIRED)
   - message_deliveries (optional - for read receipts)
4. Click "Done"
```

### Phase 4: The Hidden Gotcha - WABA Subscription (CRITICAL)

⚠️ **THIS IS THE #1 REASON WEBHOOKS FAIL SILENTLY**

Even if your webhook is configured correctly, messages will NOT be delivered unless your app is subscribed to your WhatsApp Business Account (WABA).

**Step 4.1: Check Current Subscription**
```bash
# Replace with your actual WABA ID and token
curl "https://graph.facebook.com/v21.0/YOUR_WABA_ID/subscribed_apps?access_token=YOUR_SYSTEM_USER_TOKEN"

# If empty or your app is missing, webhooks won't work!
```

**Step 4.2: Subscribe Your App to WABA**
```bash
# This is the fix for "shadow delivery" - messages disappearing
curl -X POST "https://graph.facebook.com/v21.0/YOUR_WABA_ID/subscribed_apps" \
  -d "access_token=YOUR_SYSTEM_USER_TOKEN"

# Response should be: {"success": true}
```

**Step 4.3: Where to Find Your WABA ID**
```
1. Go to business.facebook.com
2. Business Settings > Accounts > WhatsApp Accounts
3. Select your WhatsApp account
4. The ID is in the URL or shown on the page
5. Format: 15-20 digit number
```

### Phase 5: Add Test Phone Numbers (5 min)

**For Development:**
```
1. Go to developers.facebook.com > Your App
2. WhatsApp > API Setup
3. Under "To" field, click "Manage phone number list"
4. Add your personal WhatsApp number for testing
5. You'll receive a code in WhatsApp - enter it to verify
6. Now you can send test messages to this number
```

**For Production (Your Business Number):**
```
1. Go to WhatsApp > API Setup
2. Click "Add phone number"
3. Enter your business phone number
4. Select verification method (SMS or Voice)
5. Enter the 6-digit code received
6. Wait for display name approval (1-3 days)
```

### Phase 6: Go Live Mode (5 min)

**Step 6.1: Add Privacy Policy**
```
1. Go to App Settings > Basic
2. Find "Privacy Policy URL" field
3. Enter your privacy policy URL (required for live mode)
4. Click "Save Changes"
```

**Step 6.2: Switch to Live**
```
1. At top of App Dashboard, find "App Mode" toggle
2. Switch from "Development" to "Live"
3. If it fails, check that privacy policy is set
```

### Environment Variables Summary

```env
# WhatsApp Cloud API Configuration
WHATSAPP_PHONE_NUMBER_ID=123456789012345      # From WhatsApp > API Setup
WHATSAPP_ACCESS_TOKEN=EAAxxxxxxxxx...         # System user permanent token
WHATSAPP_WEBHOOK_VERIFY_TOKEN=your_random_string  # You created this
WHATSAPP_APP_SECRET=abc123def456...           # From App Settings > Basic
WHATSAPP_API_VERSION=v21.0                    # Current stable version
```
</complete_setup_guide>

<troubleshooting_guide>
## Troubleshooting Guide

### Problem: Webhook Verification Fails

**Symptoms:**
- Meta shows "Callback verification failed"
- Error: HTTP 404 or timeout

**Checklist:**
1. [ ] Is your server running and deployed?
2. [ ] Is the URL accessible from the internet? (Test with curl from another machine)
3. [ ] Is it HTTPS? (HTTP won't work)
4. [ ] Is the verify token EXACTLY the same in both places?
5. [ ] Does your endpoint return the `hub.challenge` value as plain text?

**Debug:**
```bash
# Simulate Meta's verification request
curl "https://your-domain.com/api/webhooks/whatsapp?hub.mode=subscribe&hub.verify_token=YOUR_TOKEN&hub.challenge=test123"

# Should return: test123
```

**Common Fixes:**
- Check Vercel/deployment logs for errors
- Ensure GET handler returns `challenge` as plain text, not JSON
- Remove any authentication middleware from webhook route

---

### Problem: Webhook Verified But No Messages Received

**Symptoms:**
- Webhook verification succeeded
- "Send Test" in Meta works
- But real WhatsApp messages don't arrive

**THE #1 CAUSE: WABA Not Subscribed**
```bash
# Check if your app is subscribed
curl "https://graph.facebook.com/v21.0/WABA_ID/subscribed_apps?access_token=TOKEN"

# If empty, run:
curl -X POST "https://graph.facebook.com/v21.0/WABA_ID/subscribed_apps" \
  -d "access_token=TOKEN"
```

**Other Causes:**
1. [ ] App still in Development mode (switch to Live)
2. [ ] Phone number moved to different app
3. [ ] Webhook configured on wrong app
4. [ ] Sender number not verified in test recipients

---

### Problem: Error 131047 - Re-engagement Message

**Symptoms:**
- Error: "Re-engagement message"
- Code: 131047

**Cause:** Trying to send a free-form message after 24-hour window expired.

**Fix:**
```typescript
// Check before sending
if (!isWithin24HourWindow(conversation.last_customer_message_at)) {
  // Use a template message instead
  await sendTemplateMessage(phone, 'hello_world', 'en');
} else {
  // Free-form OK
  await sendTextMessage(phone, content);
}
```

**Long-term:** Create and approve utility/marketing templates for re-engagement.

---

### Problem: Error 131056 - Pair Rate Limit

**Symptoms:**
- Error: "Too many messages sent to this phone number"
- Code: 131056

**Cause:** Sending too many messages to the same user too quickly.

**Fix:**
- Wait before retrying (start with 10 seconds, increase exponentially)
- Don't send multiple messages in quick succession to same user
- Combine messages into one if possible

---

### Problem: Error 131005 - Access Denied

**Symptoms:**
- Error: "Access denied"
- Code: 131005

**Cause:** Token doesn't have required permissions.

**Fix:**
1. Go to Business Settings > System Users
2. Select your system user
3. Generate new token with permissions:
   - `whatsapp_business_management`
   - `whatsapp_business_messaging`
4. Update your environment variable

---

### Problem: Signature Verification Fails (401)

**Symptoms:**
- All webhooks return 401 Unauthorized
- Logs show "Invalid signature"

**Cause:** App Secret mismatch or body parsing issue.

**Fix:**
1. Verify `WHATSAPP_APP_SECRET` matches App Settings > Basic
2. Ensure you're using `request.text()` BEFORE parsing JSON
3. Don't use middleware that parses body before signature check

**Verify Your Code:**
```typescript
// CORRECT - get raw body first
const rawBody = await request.text();
const isValid = verifySignature(rawBody, signatureHeader);
const payload = JSON.parse(rawBody);

// WRONG - parsing modifies body
const payload = await request.json(); // Signature will fail!
```

---

### Problem: Display Name Rejected

**Symptoms:**
- Phone number registration stuck
- Display name shows "Rejected"

**Common Rejection Reasons:**
- Name doesn't appear on your website
- Using all caps: "SUNNY'S STORE" (use "Sunny's Store")
- Generic terms: "Support", "Agent", "Bot"
- Special characters or emojis
- URL format: "MyStore.com"

**Fix:**
1. Use exact business name from your website
2. Proper capitalization (not ALL CAPS)
3. Add business suffix if needed: "Sunny's Store Customer Support"
4. Submit appeal with business registration document

---

### Problem: Template Rejected

**Symptoms:**
- Template status: "Rejected"
- Can't use template messages

**Common Rejection Reasons:**
- Variable at start/end of message
- Marketing content in Utility template
- Missing sample values
- Duplicate of existing template
- Button label too long (max 25 chars)

**Fix:**
1. Don't start/end with {{1}} variables
2. Use correct category (Marketing vs Utility vs Authentication)
3. Provide realistic sample values
4. Keep button labels under 20 chars to be safe
5. No threatening language ("Act now or lose access")

---

### Problem: Test Messages Work, Production Fails

**Symptoms:**
- Can send to test numbers
- Real users don't receive messages

**Checklist:**
1. [ ] App is in Live mode (not Development)
2. [ ] Phone number display name approved
3. [ ] Business verification complete
4. [ ] User has opted in to receive messages
5. [ ] User hasn't blocked your number

---

### Problem: Messages Duplicated

**Symptoms:**
- Same message appears multiple times in database

**Cause:** Webhook handler takes too long, Meta retries.

**Fix:**
```typescript
// Process async, don't await
processWebhook(payload).catch(console.error);

// Respond immediately
return NextResponse.json({ status: 'ok' });
```

Also ensure deduplication:
```typescript
// Check whatsapp_message_id before insert
const existing = await supabase
  .from('messages')
  .select('id')
  .eq('whatsapp_message_id', messageId)
  .single();

if (existing) return; // Already processed
```
</troubleshooting_guide>

<local_development>
## Local Development with ngrok

### Setup ngrok for Local Testing

**Step 1: Install ngrok**
```bash
# macOS
brew install ngrok

# Windows (chocolatey)
choco install ngrok

# Or download from ngrok.com
```

**Step 2: Get ngrok Auth Token**
```bash
# Sign up at ngrok.com and get your auth token
ngrok config add-authtoken YOUR_AUTH_TOKEN
```

**Step 3: Start Your Local Server**
```bash
npm run dev
# Server running on http://localhost:3000
```

**Step 4: Start ngrok Tunnel**
```bash
ngrok http 3000
# Example output: https://abc123.ngrok-free.app
```

**Step 5: Configure Webhook with ngrok URL**
```
1. Go to Meta Developer > WhatsApp > Configuration
2. Edit webhook
3. Callback URL: https://abc123.ngrok-free.app/api/webhooks/whatsapp
4. Verify token: same as your env var
5. Verify and Save
```

### ngrok Web Interface

Access http://127.0.0.1:4040 while ngrok is running to:
- See all incoming webhook requests
- Inspect headers and body
- Replay requests with one click
- Debug verification issues

### Important Notes

- ngrok URL changes each time you restart (unless you pay for static URL)
- You'll need to update Meta webhook config each time
- Some delays may occur - if webhook times out, try cloudflared or VS Code dev tunnels as alternatives
- Free tier: 500 signature validations/month
</local_development>

<production_checklist>
## Production Go-Live Checklist

### Before Launch

**Meta Configuration:**
- [ ] Meta Business account verified (documents approved)
- [ ] App switched to Live mode
- [ ] Privacy Policy URL set in App Settings
- [ ] Phone number display name approved
- [ ] At least one message template approved (for re-engagement)
- [ ] WABA subscribed to your app

**Environment Variables:**
- [ ] `WHATSAPP_PHONE_NUMBER_ID` - production phone number ID
- [ ] `WHATSAPP_ACCESS_TOKEN` - permanent system user token
- [ ] `WHATSAPP_WEBHOOK_VERIFY_TOKEN` - secure random string
- [ ] `WHATSAPP_APP_SECRET` - from App Settings > Basic
- [ ] `WHATSAPP_API_VERSION` - v21.0

**Code Verification:**
- [ ] Webhook signature verification working
- [ ] Raw body used for signature (not parsed JSON)
- [ ] Async processing (respond within 5 seconds)
- [ ] Message deduplication via whatsapp_message_id
- [ ] 24-hour window check before sending
- [ ] Error handling for all API calls

**Webhook Configuration:**
- [ ] Production URL configured in Meta
- [ ] Webhook verified successfully
- [ ] Subscribed to "messages" field
- [ ] Test message received from Meta

**Database:**
- [ ] contacts table has phone column
- [ ] conversations table has channel='whatsapp'
- [ ] messages table has whatsapp_message_id column
- [ ] last_customer_message_at tracked for 24h window

### Messaging Limits

**New Account Limits:**
- Starts at 250 unique users per 24 hours
- Increases to 1,000 after proving quality
- Then 10,000 → 100,000 → unlimited

**How to Increase:**
- Send high-quality messages (low block/report rate)
- Reach 1,000 unique contacts in 30 days
- Maintain good quality rating
- Limits upgrade automatically

### Billing Setup

**Enable Payments:**
1. Go to business.facebook.com
2. Business Settings > Billing and Payments
3. Add payment method (credit card)
4. Select your WhatsApp account to enable billing

**Pricing (2026):**
- Service conversations: Charged per 24h window
- Utility templates in 24h window: FREE
- Marketing templates: Per message
- Authentication templates: Per message
- First 1,000 service conversations/month: FREE

### Monitoring

**What to Monitor:**
- Webhook delivery success rate
- Message send success rate
- Quality rating in WhatsApp Manager
- Error codes in logs (especially 131047, 131056)

**Where to Check:**
- WhatsApp Manager: Quality rating, phone status
- Meta for Developers: Webhook delivery stats
- Your logs: Error codes, response times
</production_checklist>

<error_code_reference>
## Error Code Quick Reference

| Code | Name | Cause | Solution |
|------|------|-------|----------|
| 131047 | Re-engagement | 24h window expired | Use template message |
| 131056 | Pair rate limit | Too many msgs to same user | Wait and retry with backoff |
| 131051 | Unsupported type | Invalid message type | Check supported types |
| 131052 | Media download failed | Can't fetch media URL | Check URL accessibility |
| 131053 | Media upload failed | Upload failed | Check file size/format |
| 132001 | Template not found | Template doesn't exist | Create/approve template |
| 131005 | Access denied | Permission issue | Check token permissions |
| 131009 | Invalid parameter | Bad request format | Validate request structure |
| 131008 | Missing parameter | Required field missing | Add required fields |
| 130429 | Throughput limit | Too many API calls | Reduce request rate |

### Error Response Format
```json
{
  "error": {
    "message": "Description of error",
    "type": "OAuthException",
    "code": 131047,
    "error_subcode": 2494010,
    "fbtrace_id": "ABC123..."
  }
}
```
</error_code_reference>

---

*Phase: 13.1-whatsapp-integration*
*Research completed: 2026-01-20*
*Deep dive completed: 2026-01-20*
*Ready for planning: yes*
