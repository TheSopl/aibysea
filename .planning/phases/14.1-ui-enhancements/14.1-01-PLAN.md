# Phase 14.1 Plan 01: UI Enhancements

## Objective

Implement three UI enhancements:
1. **AI Agent Form Redesign** - Full-page Manychat-style editor with Instructions, Actions, Knowledge Sources, and Test Chat
2. **Inbox Animation Optimization** - Only animate last 6 visible messages when opening a conversation
3. **Dashboard Scrolling** - Add page-level scrolling with transparent background (dashboard only)

## Execution Context

- Phase: 14.1 (UI Enhancements - INSERTED)
- Dependencies: Phase 14 complete (AI Agent Management)
- Scope: Medium (3 distinct enhancements)

## Context

### Current State

**AI Agents Page** (`src/app/(main)/agents/page.tsx`):
- Uses modal-based form (AgentFormModal component)
- Limited fields: name, status, model, system_prompt, greeting_message
- behaviors/triggers stored as JSONB but not exposed in UI

**Inbox Messages** (`src/app/(main)/inbox/page.tsx`):
- All messages animate with staggered delay: `transition-delay: ${index * 0.05}s`
- Long conversations cause slow perceived load time

**Dashboard** (`src/app/(main)/dashboard/page.tsx`):
- Fixed layout with no page-level scrolling
- Background gradient covers full viewport

### Target State

**AI Agent Editor**:
- Full-page editor at `/agents/[id]/edit` and `/agents/new`
- Left column: Configuration (Instructions, Actions, Knowledge Sources)
- Right column: Test Chat panel with live preview
- Actions as toggle cards (Close conversations, Assign to agent, Trigger workflows, etc.)

**Inbox Animation**:
- Only last 6 messages animate when opening conversation
- Earlier messages render instantly (no animation delay)

**Dashboard Scrolling**:
- Content can scroll when exceeding viewport
- Background remains fixed/transparent during scroll

## Tasks

### Task 1: Create AI Agent Editor Page Structure

**Files to create:**
- `src/app/(main)/agents/[id]/edit/page.tsx` - Edit existing agent
- `src/app/(main)/agents/new/page.tsx` - Create new agent

**Files to modify:**
- `src/app/(main)/agents/page.tsx` - Update card links to go to `/agents/[id]/edit`

**Implementation:**
```typescript
// src/app/(main)/agents/[id]/edit/page.tsx
'use client';

import { useParams, useRouter } from 'next/navigation';
import { useState, useEffect, useCallback } from 'react';
import { createClient } from '@/lib/supabase/client';
import { ArrowLeft, Save, Play, X, Plus, Trash2, GripVertical, ChevronDown, ChevronUp, MessageSquare, Zap, BookOpen, Settings } from 'lucide-react';

// Types for the enhanced form
interface Instruction {
  id: string;
  text: string;
  order: number;
}

interface ActionConfig {
  closeConversations: boolean;
  assignToAgent: boolean;
  updateLifecycle: boolean;
  triggerWorkflows: boolean;
  addComments: boolean;
  handleCalls: boolean;
}

interface KnowledgeSource {
  id: string;
  name: string;
  type: 'file' | 'url' | 'text';
  content?: string;
  url?: string;
  fileSize?: number;
  addedAt: string;
}

interface AgentFormData {
  name: string;
  status: 'active' | 'inactive';
  model: string;
  system_prompt: string;
  greeting_message: string;
  instructions: Instruction[];
  actions: ActionConfig;
  knowledgeSources: KnowledgeSource[];
}
```

**Commit:** `feat(14.1): create agent editor page structure`

### Task 2: Implement Agent Editor UI Components

**Implementation details:**

**Header Section:**
- Back button to /agents
- Agent name (editable inline)
- Status toggle (Active/Inactive pill)
- Save button (primary action)

**Left Column - Configuration:**
1. **Instructions Section** (collapsible)
   - Numbered instruction cards with drag handles
   - Add instruction button
   - Delete per instruction
   - Reorder via drag-drop or up/down buttons

2. **Actions Section** (collapsible)
   - Toggle cards for each action type:
     - Close conversations
     - Assign to agent (with agent selector)
     - Update lifecycle stage
     - Trigger workflows
     - Add comments
     - Handle calls
   - Each toggle shows description when enabled

3. **Knowledge Sources Section** (collapsible)
   - List of added sources with type icons
   - Add source button (file upload, URL, or text)
   - Remove source option
   - File size display

4. **Model Settings Section** (collapsible)
   - Model dropdown (gpt-4, gpt-3.5-turbo, claude-3)
   - System prompt textarea

**Right Column - Test Chat:**
- Chat interface preview
- Mock conversation with agent responses
- "Start Test" button
- Shows greeting message on start
- Input field to test responses

**Commit:** `feat(14.1): implement agent editor UI components`

### Task 3: Wire Up Agent Editor Data Flow

**Implementation:**
- Fetch agent data on mount (for edit mode)
- Transform behaviors JSONB to/from form state
- Save handler that:
  1. Validates required fields (name)
  2. Transforms form data to database format
  3. Updates via /api/ai-agents/[id] PUT endpoint
  4. Shows success toast and redirects to /agents
- Handle create mode (POST to /api/ai-agents)

**Data transformation:**
```typescript
// Form to DB
const toDatabase = (form: AgentFormData) => ({
  name: form.name,
  status: form.status,
  model: form.model,
  system_prompt: form.system_prompt,
  greeting_message: form.greeting_message,
  triggers: form.instructions.map(i => i.text),
  behaviors: {
    actions: form.actions,
    knowledgeSources: form.knowledgeSources,
  },
});

// DB to Form
const fromDatabase = (agent: AIAgent): AgentFormData => ({
  name: agent.name,
  status: agent.status,
  model: agent.model,
  system_prompt: agent.system_prompt || '',
  greeting_message: agent.greeting_message || '',
  instructions: (agent.triggers || []).map((t, i) => ({
    id: crypto.randomUUID(),
    text: t,
    order: i,
  })),
  actions: agent.behaviors?.actions || defaultActions,
  knowledgeSources: agent.behaviors?.knowledgeSources || [],
});
```

**Commit:** `feat(14.1): wire up agent editor data flow`

### Task 4: Update Agents List Page

**Modify** `src/app/(main)/agents/page.tsx`:
- Change card click to navigate to `/agents/[id]/edit`
- Add "Create Agent" button linking to `/agents/new`
- Remove modal-based editing (keep for reference or delete)
- Keep delete confirmation modal

**Commit:** `feat(14.1): update agents list with editor navigation`

### Task 5: Optimize Inbox Message Animation

**Modify** `src/app/(main)/inbox/page.tsx`:

Find the message rendering section and update animation logic:

```typescript
// Current (animates all):
style={{ transitionDelay: `${index * 0.05}s` }}

// New (only animate last 6 visible):
const totalMessages = messages.length;
const animateFromIndex = Math.max(0, totalMessages - 6);
const shouldAnimate = index >= animateFromIndex;

style={{
  transitionDelay: shouldAnimate ? `${(index - animateFromIndex) * 0.05}s` : '0s',
  opacity: shouldAnimate ? undefined : 1,
  transform: shouldAnimate ? undefined : 'none',
}}
```

Also ensure messages before the animation threshold render without initial hidden state.

**Commit:** `feat(14.1): optimize inbox message animation for long chats`

### Task 6: Add Dashboard Scrolling

**Modify** `src/app/(main)/dashboard/page.tsx`:

Add scrollable container with fixed background:

```typescript
// Wrap content in scrollable container
<div className="h-full overflow-y-auto">
  <div className="min-h-full p-6 space-y-6">
    {/* Dashboard content */}
  </div>
</div>
```

Ensure background gradient is applied to parent container (fixed) not the scrollable area.

**Commit:** `feat(14.1): add dashboard page scrolling with fixed background`

### Task 7: Verification Checkpoint

**Build check:**
```bash
npm run build
```

**Manual verification:**
1. Navigate to /agents - cards should link to /agents/[id]/edit
2. Open agent editor - should show full-page layout with all sections
3. Edit and save an agent - data should persist
4. Create new agent at /agents/new
5. Open long conversation in inbox - only last 6 messages should animate
6. Dashboard should scroll when content exceeds viewport

## Verification

- [ ] Build passes without errors
- [ ] Agent editor shows Instructions, Actions, Knowledge Sources, Test Chat
- [ ] Agent data saves and loads correctly
- [ ] Inbox message animation only affects last 6 messages
- [ ] Dashboard scrolls with fixed background

## Success Criteria

- AI Agent editor provides Manychat-style UX with rich configuration options
- Long inbox conversations load without animation lag
- Dashboard content is fully scrollable

## Output

Files created:
- `src/app/(main)/agents/[id]/edit/page.tsx`
- `src/app/(main)/agents/new/page.tsx`

Files modified:
- `src/app/(main)/agents/page.tsx`
- `src/app/(main)/inbox/page.tsx`
- `src/app/(main)/dashboard/page.tsx`

Commits: 6 feature commits + 1 verification
