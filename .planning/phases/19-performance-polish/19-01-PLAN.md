---
phase: 19-performance-polish
plan: 01
type: execute
---

<objective>
Establish performance measurement baseline and identify optimization targets through bundle analysis.

Purpose: Understand current bundle size and composition to prioritize code splitting efforts for maximum impact.
Output: Bundle analyzer installed, baseline metrics documented, splitting strategy defined.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-performance-polish/RESEARCH.md
@next.config.ts
@package.json

**Tech stack available:**
- Next.js 16.1.1 with Turbopack
- recharts (~400KB) - Dashboard charts
- framer-motion (~150KB) - Animations across app
- numeral (~15KB) - Number formatting

**Current state:**
- All responsive pages complete (Phase 18)
- No bundle analysis configured
- No Lighthouse CI
- Static imports for all dependencies
- Estimated initial bundle: ~800KB+

**Performance targets (from RESEARCH.md):**
- Initial JS bundle < 300KB gzipped
- Lighthouse Performance > 85
- LCP < 2.5s, FID < 100ms, CLS < 0.1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure bundle analyzer</name>
  <files>package.json, next.config.ts</files>
  <action>
Install @next/bundle-analyzer:
```bash
npm install --save-dev @next/bundle-analyzer
```

Update next.config.ts to wrap config with bundle analyzer:
```typescript
import type { NextConfig } from "next";
import bundleAnalyzer from '@next/bundle-analyzer';

const withBundleAnalyzer = bundleAnalyzer({
  enabled: process.env.ANALYZE === 'true',
});

const nextConfig: NextConfig = {
  /* config options here */
};

export default withBundleAnalyzer(nextConfig);
```

Add npm script to package.json scripts:
```json
"analyze": "ANALYZE=true npm run build"
```

Why: Bundle analyzer shows visual treemap of bundle composition to identify optimization targets. ANALYZE env var prevents analyzer from running on every build (would slow down development).
  </action>
  <verify>npm run analyze generates bundle report and opens in browser showing client and server bundle composition</verify>
  <done>Bundle analyzer installed, configured, and analyzer script added to package.json</done>
</task>

<task type="auto">
  <name>Task 2: Run baseline Lighthouse audit and document metrics</name>
  <files>.planning/phases/19-performance-polish/BASELINE.md</files>
  <action>
Create BASELINE.md in phase directory documenting current performance.

Run Lighthouse audit on key pages:
1. Start dev server: `npm run dev`
2. Open Chrome DevTools â†’ Lighthouse
3. Run audits for Mobile + Desktop on:
   - http://localhost:3000/ (Landing/Dashboard)
   - http://localhost:3000/inbox
   - http://localhost:3000/dashboard

Document in BASELINE.md:
```markdown
# Performance Baseline - Pre-Optimization

**Date:** 2026-01-27
**Environment:** Development (npm run dev)

## Lighthouse Scores (Mobile)

### Dashboard Page
- Performance: XX/100
- FCP: X.Xs
- LCP: X.Xs
- TBT: XXXms
- CLS: 0.XX

### Inbox Page
- Performance: XX/100
- FCP: X.Xs
- LCP: X.Xs
- TBT: XXXms
- CLS: 0.XX

## Key Findings
- [List main performance issues from Lighthouse]
- [Note bundle size warnings]
- [Document any CLS sources]

## Optimization Targets
Based on bundle analyzer + Lighthouse:
1. [Largest bundle chunk and size]
2. [Second largest issue]
3. [Third priority]
```

Note: Development builds are larger than production. We're establishing baseline for comparison - final verification will use production build.
  </action>
  <verify>BASELINE.md exists with Lighthouse scores and bundle analyzer observations documented</verify>
  <done>Baseline metrics captured for all key pages with specific scores and optimization targets identified</done>
</task>

<task type="auto">
  <name>Task 3: Generate bundle report and identify splitting targets</name>
  <files>.planning/phases/19-performance-polish/SPLITTING-STRATEGY.md</files>
  <action>
Run bundle analyzer and document splitting strategy:

1. Generate report: `npm run analyze`
2. Review treemap for largest chunks
3. Create SPLITTING-STRATEGY.md:

```markdown
# Code Splitting Strategy

## Bundle Analysis Results

### Current Bundle Composition
- Total client bundle: XXX KB
- Largest chunks:
  1. recharts: ~XXX KB (Dashboard only)
  2. framer-motion: ~XXX KB (Multiple pages)
  3. Other heavy deps: [list]

### Splitting Targets (Priority Order)

**Priority 1: recharts (Dashboard)**
- Current: Static import
- Target: Dynamic import with loading state
- Expected savings: ~400KB from initial bundle
- Files to modify:
  - src/app/(main)/dashboard/page.tsx
  - src/components/dashboard/LatencyChart.tsx
  - src/components/dashboard/ConfidenceScores.tsx

**Priority 2: framer-motion components**
- Current: Static imports across multiple components
- Target: Conditional rendering with reduced motion preference
- Expected savings: Varies by page
- Files to modify: [list components using motion]

**Priority 3: numeral (if needed)**
- Current: Static import
- Target: Dynamic import or replace with Intl.NumberFormat
- Expected savings: ~15KB

### Implementation Plan
- Plan 19-02: Implement recharts dynamic imports + error boundaries
- Plan 19-03: Optimize framer-motion and images
- Plan 19-04: Final CI setup and verification
```

Use actual file sizes and chunk names from the bundle analyzer report. Be specific about which files import which dependencies.
  </action>
  <verify>SPLITTING-STRATEGY.md exists with specific file sizes, target files, and prioritized plan</verify>
  <done>Complete splitting strategy documented with actual bundle sizes and prioritized file list for Plans 02-04</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run analyze` successfully generates bundle report
- [ ] BASELINE.md exists with Lighthouse scores for 3 key pages
- [ ] SPLITTING-STRATEGY.md exists with specific targets and file list
- [ ] Bundle analyzer configured correctly (enabled only with ANALYZE=true)
- [ ] No build errors introduced
</verification>

<success_criteria>

- Bundle analyzer installed and configured
- Baseline Lighthouse metrics documented
- Bundle composition analyzed and documented
- Code splitting strategy defined with priorities
- Ready to implement optimizations in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/19-performance-polish/19-01-SUMMARY.md`:

# Phase 19-01 Summary: Bundle Analysis & Measurement

**Performance measurement baseline established with bundle analyzer and Lighthouse audits.**

## Accomplishments

- Installed and configured @next/bundle-analyzer
- Documented baseline Lighthouse scores for key pages
- Generated bundle composition report
- Identified optimization targets and priorities

## Files Created/Modified

- `next.config.ts` - Added bundle analyzer wrapper
- `package.json` - Added analyze script, installed dependency
- `.planning/phases/19-performance-polish/BASELINE.md` - Performance baseline
- `.planning/phases/19-performance-polish/SPLITTING-STRATEGY.md` - Splitting strategy

## Decisions Made

- recharts as Priority 1 (largest dependency, used only in Dashboard)
- Development baseline acceptable (production build verification in Plan 04)
- Bundle analyzer gated behind ANALYZE env var to avoid slowing development

## Issues Encountered

[Note any issues, or "None"]

## Next Step

Ready for 19-02-PLAN.md: Code Splitting & Dynamic Imports
</output>
