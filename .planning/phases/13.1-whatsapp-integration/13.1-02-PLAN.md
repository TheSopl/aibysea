---
phase: 13.1-whatsapp-integration
plan: 02
type: execute
---

<objective>
Create WhatsApp send endpoint and integrate with inbox UI.

Purpose: Enable agents to send WhatsApp messages from the inbox UI, following the same pattern as Telegram send endpoint. This completes bidirectional WhatsApp messaging.

Output: Working `/api/whatsapp/send` endpoint, inbox UI updated to send via WhatsApp channel, end-to-end message flow verified.
</objective>

<execution_context>
Existing infrastructure:
- WhatsApp client: `src/lib/whatsapp/client.ts` (sendTextMessage, sendTemplateMessage)
- Telegram send pattern: `src/app/api/telegram/send/route.ts`
- Webhook processor: `src/services/whatsapp/processor.ts`
- 24h window checker: `isWithin24HourWindow()` in client.ts

Key constraints:
- Must check 24h messaging window before sending free-form messages
- Outside 24h window, can only send approved templates
- Must check handler_type (skip if human mode and AI trying to send)
- Must update last_customer_message_at when customers message us
</execution_context>

<context>
@src/app/api/telegram/send/route.ts
@src/lib/whatsapp/client.ts
@src/lib/whatsapp/types.ts
@src/services/whatsapp/processor.ts
@src/app/\(dashboard\)/inbox/components/ConversationView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WhatsApp send endpoint</name>
  <files>src/app/api/whatsapp/send/route.ts</files>
  <action>
    Create POST endpoint following Telegram send pattern with WhatsApp-specific logic:

    Request body:
    ```typescript
    {
      to: string;           // WhatsApp phone number (with country code)
      message: string;      // Text message content
      conversation_id?: string;  // For handler check and window check
      skip_handler_check?: boolean;  // For human agents sending
    }
    ```

    Implementation:
    1. Validate required fields (to, message)
    2. If conversation_id provided and !skip_handler_check:
       - Query conversation for handler_type
       - If handler_type === 'human', block AI messages (return 200 with blocked: true)
    3. If conversation_id provided:
       - Query conversation for last_customer_message_at
       - Use isWithin24HourWindow() to check
       - If OUTSIDE window, return error with 'template_required: true'
    4. Call sendTextMessage(to, message) from whatsapp/client.ts
    5. Return { success: true, message_id: result.messages[0].id }

    Error handling:
    - 400: Missing to or message
    - 200 with blocked: true - conversation in human mode
    - 200 with template_required: true - outside 24h window
    - 500: WhatsApp API error (with error details)

    Use createAdminClient() for DB queries (same as Telegram pattern).
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>Endpoint created at /api/whatsapp/send with handler check and 24h window validation</done>
</task>

<task type="auto">
  <name>Task 2: Update inbox to send via channel</name>
  <files>src/app/(dashboard)/inbox/components/ConversationView.tsx</files>
  <action>
    Update the message send handler in ConversationView to:

    1. Check conversation.channel (whatsapp or telegram)
    2. Route to appropriate endpoint:
       - whatsapp → POST /api/whatsapp/send with { to: contact.phone_number, message, conversation_id, skip_handler_check: true }
       - telegram → POST /api/telegram/send with { chatId: contact.telegram_chat_id, message, conversation_id, skip_handler_check: true }

    3. Handle template_required response for WhatsApp:
       - If response has template_required: true
       - Show toast/alert: "24h window expired. Template message required."
       - Don't add message to UI

    4. For successful sends:
       - Optimistically add message to UI (existing behavior)
       - The real-time subscription will sync actual message from DB

    Note: Human agents always send with skip_handler_check: true since they're explicitly sending.
    The handler check is for AI/n8n webhook calls to respect human takeover.
  </action>
  <verify>TypeScript compiles, no errors in console</verify>
  <done>Inbox routes messages to correct channel endpoint, handles 24h window feedback</done>
</task>

<task type="auto">
  <name>Task 3: Store outbound messages in database</name>
  <files>src/app/api/whatsapp/send/route.ts</files>
  <action>
    After successful WhatsApp API send, store the outbound message in database:

    1. After sendTextMessage() succeeds
    2. Insert into messages table:
       ```typescript
       await supabase.from('messages').insert({
         conversation_id: conversation_id,
         content: message,
         direction: 'outbound',
         channel: 'whatsapp',
         whatsapp_message_id: result.messages[0].id,
         created_at: new Date().toISOString()
       });
       ```

    3. Only insert if conversation_id was provided (we need it for the FK)

    This ensures outbound messages appear in the inbox chat history and trigger real-time updates.
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>Outbound messages persisted to database with WhatsApp message ID</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete WhatsApp send flow from inbox UI</what-built>
  <how-to-verify>
    **Prerequisites:**
    - Dev server running: `npm run dev`
    - You have a WhatsApp conversation from Plan 01 testing

    **Test 1: Send message from inbox**
    1. Open http://localhost:3000/inbox
    2. Find the WhatsApp conversation (from your test reply in Plan 01)
    3. Type a message in the input field
    4. Click send
    5. Message should appear in chat immediately (optimistic update)
    6. Check your phone - you should receive the message via WhatsApp

    **Test 2: Verify database storage**
    1. Open Supabase dashboard > messages table
    2. Find the message you just sent
    3. Verify: direction = 'outbound', channel = 'whatsapp', whatsapp_message_id present

    **Test 3: Two-way conversation**
    1. Reply from your phone
    2. Reply should appear in inbox (via real-time subscription)
    3. Send another message from inbox
    4. Verify back-and-forth works smoothly
  </how-to-verify>
  <resume-signal>Type "approved" if bidirectional messaging works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] /api/whatsapp/send endpoint exists and handles all cases
- [ ] Inbox correctly routes WhatsApp vs Telegram messages
- [ ] 24h window check works (returns template_required if expired)
- [ ] Outbound messages stored in database
- [ ] Bidirectional messaging verified end-to-end
</verification>

<success_criteria>
- WhatsApp send endpoint created at /api/whatsapp/send
- Handler check prevents AI messages during human takeover
- 24h window enforced with clear feedback
- Inbox sends to correct endpoint based on channel
- Messages stored in database for both directions
- Real-time sync works for new messages
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-whatsapp-integration/13.1-02-SUMMARY.md`:

# Phase 13.1 Plan 02: WhatsApp Send Endpoint

**[One-liner summary]**

## Accomplishments
- /api/whatsapp/send endpoint with 24h window validation
- Inbox channel-aware sending
- Outbound message persistence
- Bidirectional messaging verified

## Files Created/Modified
- src/app/api/whatsapp/send/route.ts (created)
- src/app/(dashboard)/inbox/components/ConversationView.tsx (modified)

## Technical Details
- 24h window check via isWithin24HourWindow()
- Handler check respects human takeover
- Outbound messages stored with whatsapp_message_id

## Issues Encountered
[Any issues and resolutions]

## Phase Completion
Phase 13.1 complete - WhatsApp fully integrated
</output>
