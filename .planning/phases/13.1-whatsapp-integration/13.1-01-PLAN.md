---
phase: 13.1-whatsapp-integration
plan: 01
type: execute
---

<objective>
Configure Meta Dashboard for WhatsApp webhook integration.

Purpose: Set up the Meta App's webhook endpoint to receive WhatsApp messages at our API endpoint, add test phone numbers for development, and subscribe the WABA to message events.

Output: Working webhook connection receiving test messages, with test phone number ready for development while production number awaits display name approval.
</objective>

<execution_context>
User has:
- WABA ID: 1520477139032199
- Production phone: +90 538 675 63 88 (display name PENDING - cannot use yet)
- Permanent System User access token
- App in Development mode
- Existing webhook handler at: `/api/webhooks/whatsapp`

Strategy: Use Meta's test phone number for development while production number awaits approval.
</execution_context>

<context>
@.planning/phases/13.1-whatsapp-integration/13.1-RESEARCH.md
@src/app/api/webhooks/whatsapp/route.ts
@src/lib/whatsapp/signature.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify environment variables</name>
  <files>.env.local (check only)</files>
  <action>
    Check that required WhatsApp environment variables exist:
    - WHATSAPP_PHONE_NUMBER_ID (phone number ID, not WABA ID)
    - WHATSAPP_ACCESS_TOKEN (permanent System User token)
    - WHATSAPP_APP_SECRET (for webhook signature verification)
    - WHATSAPP_WEBHOOK_VERIFY_TOKEN (any string for verification handshake)

    If WHATSAPP_WEBHOOK_VERIFY_TOKEN doesn't exist, generate a random secure string and instruct user to add it.

    Note: We'll update WHATSAPP_PHONE_NUMBER_ID to the test phone ID after Meta dashboard setup.
  </action>
  <verify>Console output confirms which env vars exist/missing</verify>
  <done>List of env vars documented, any missing ones identified</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure Meta App webhook settings in Meta Developer Dashboard</action>
  <instructions>
    I'll guide you through each step. Open Meta Developer Dashboard:
    https://developers.facebook.com/apps/

    **Step 1: Navigate to WhatsApp > Configuration**
    - Select your app
    - Left sidebar: WhatsApp > Configuration

    **Step 2: Configure Webhook URL**
    - Find "Webhook" section
    - Click "Edit" button
    - Callback URL: `https://your-domain.com/api/webhooks/whatsapp`
      (Use ngrok URL for local dev: run `ngrok http 3000` first)
    - Verify Token: Use your WHATSAPP_WEBHOOK_VERIFY_TOKEN value from .env.local
    - Click "Verify and Save"

    **Step 3: Subscribe to Webhook Fields**
    - After verification succeeds, find "Webhook fields" section
    - Click "Manage" next to your WABA (1520477139032199)
    - Enable these subscriptions:
      ✅ messages (REQUIRED - for incoming messages)
      ✅ message_template_status_update (for template approvals)
    - Click "Done"

    **Step 4: Add Test Phone Number**
    - Go to WhatsApp > API Setup
    - Find "From" dropdown showing phone numbers
    - You should see Meta's test phone number available
    - Copy the TEST Phone Number ID (different from your production phone)

    **Step 5: Add Your Phone as Recipient**
    - In API Setup, find "To" field
    - Click "Manage phone number list"
    - Add your personal phone number for testing
    - You'll receive a verification code via WhatsApp
    - Enter the code to verify
  </instructions>
  <verification>
    After completing, tell me:
    1. Did webhook verification succeed? (should show green checkmark)
    2. What is the TEST Phone Number ID? (I'll update .env.local)
    3. Did you add and verify your personal phone?
  </verification>
  <resume-signal>Provide the answers above, or describe any errors</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Subscribe WABA to app (critical step)</name>
  <files>None (API call)</files>
  <action>
    Execute the WABA subscription API call to ensure webhooks are properly routed.
    This is the #1 hidden cause of "webhooks not receiving messages".

    Use curl to subscribe:
    ```
    curl -X POST "https://graph.facebook.com/v21.0/1520477139032199/subscribed_apps" \
      -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
    ```

    Expected response: {"success": true}

    If already subscribed, it will return success anyway.
  </action>
  <verify>API response shows {"success": true}</verify>
  <done>WABA subscription confirmed active</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete webhook configuration with WABA subscription</what-built>
  <how-to-verify>
    **Test 1: Send a test message FROM Meta API Setup**
    1. In Meta Developer Dashboard > WhatsApp > API Setup
    2. Select the TEST phone number in "From"
    3. Select your verified personal phone in "To"
    4. Click "Send Message" (hello_world template)
    5. You should receive a WhatsApp message

    **Test 2: Reply to trigger webhook**
    1. Open WhatsApp on your personal phone
    2. Find the message from the test number
    3. Reply with any text (e.g., "Hello")
    4. Check your server logs for:
       `[WhatsApp Webhook] Received payload:`
       `[WhatsApp Webhook] Full payload:`

    **Test 3: Verify message in database**
    1. Check Supabase > messages table
    2. Should see your reply message stored
  </how-to-verify>
  <resume-signal>Type "approved" if webhooks working, or describe what failed</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Webhook URL configured and verified in Meta Dashboard
- [ ] WABA subscribed to messages webhook field
- [ ] Test phone number available and ID captured
- [ ] Personal phone added as test recipient
- [ ] WABA subscription API call successful
- [ ] End-to-end test: send template → receive → reply → webhook logs show message
</verification>

<success_criteria>
- Webhook verification shows green checkmark in Meta Dashboard
- Test message sent successfully via API Setup
- Reply triggers webhook and appears in server logs
- Message saved to Supabase database
- Test Phone Number ID captured for .env.local
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-whatsapp-integration/13.1-01-SUMMARY.md`:

# Phase 13.1 Plan 01: Meta Dashboard Configuration

**[One-liner summary]**

## Accomplishments
- Webhook URL configured
- WABA subscribed to app
- Test phone number ready
- End-to-end webhook verified

## Configuration Details
- Test Phone Number ID: [captured]
- Webhook URL: [configured]
- Subscribed fields: messages, message_template_status_update

## Issues Encountered
[Any issues and resolutions]

## Next Plan Readiness
Ready for 13.1-02: WhatsApp send endpoint implementation
</output>
