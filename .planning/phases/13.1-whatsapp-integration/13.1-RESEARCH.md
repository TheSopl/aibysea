# Phase 13.1: WhatsApp Integration - Research

**Researched:** 2026-01-20
**Domain:** WhatsApp Cloud API integration, Meta Business Platform
**Confidence:** HIGH

<research_summary>
## Summary

Researched WhatsApp Cloud API integration patterns to complete the messaging infrastructure started in v1.0. The project already has comprehensive WhatsApp infrastructure built (`src/lib/whatsapp/`, `src/services/whatsapp/`, webhook handler) but Phase 13 skipped WhatsApp testing due to missing Meta dashboard configuration.

**Context:** This is NOT greenfield - v1.0 built complete WhatsApp infrastructure including webhook verification (HMAC-SHA256), message processor, client for sending text/template messages, and TypeScript types via `@whatsapp-cloudapi/types`. Phase 13.1 needs to verify this infrastructure works end-to-end and add any missing pieces.

**Primary recommendation:** Verify and test existing infrastructure end-to-end. Add WhatsApp send endpoint (like Telegram has), configure Meta dashboard, and ensure the `/inbox` page works with WhatsApp messages.
</research_summary>

<standard_stack>
## Standard Stack

### Already Implemented (v1.0)
| Library | Version | Purpose | Status |
|---------|---------|---------|--------|
| @whatsapp-cloudapi/types | ^1.x | Zero-runtime TypeScript types | Installed |
| Node.js crypto | Built-in | HMAC-SHA256 signature verification | Implemented |

### What's Built
- `src/lib/whatsapp/signature.ts` - HMAC-SHA256 verification with timingSafeEqual
- `src/lib/whatsapp/client.ts` - sendTextMessage, sendTemplateMessage, isWithin24HourWindow
- `src/lib/whatsapp/types.ts` - Re-exports from @whatsapp-cloudapi/types + custom bridge types
- `src/lib/whatsapp/constants.ts` - API URL builder, token getters
- `src/services/whatsapp/processor.ts` - Full webhook processor with contact/conversation creation
- `src/app/api/webhooks/whatsapp/route.ts` - GET (verification) + POST (webhook receiver)

### Missing Components
| Component | Purpose | Priority |
|-----------|---------|----------|
| `/api/whatsapp/send` endpoint | Send messages from inbox UI | HIGH |
| Media download handler | Download images/audio/video/docs | MEDIUM |
| Interactive message support | Buttons, lists, quick replies | LOW |
| Template management UI | Manage message templates | DEFERRED |

### NPM Packages Available (Not Currently Used)
| Library | Purpose | When to Use |
|---------|---------|-------------|
| whatsapp (official) | Official Meta Node.js SDK | Only if rebuilding from scratch |
| @great-detail/whatsapp | Community SDK with TypeScript | If need more abstraction |
| @whatsapp-cloudapi/emulator | Local testing without Meta | Development/testing |

**Note:** Current implementation uses direct `fetch()` calls to Graph API - this is fine and avoids SDK dependencies. Official SDK requires Node 16+ which we have.
</standard_stack>

<architecture_patterns>
## Architecture Patterns

### Current Implementation Pattern (Good)
```
Webhook → Route Handler → Processor → Supabase
                ↓
         Signature Verify (fail fast)
                ↓
         Parse JSON
                ↓
         Process Async (don't await - respond < 5s)
```

### Pattern 1: Webhook Processing (Already Implemented)
**What:** Async processing with immediate 200 response
**Why:** Meta requires response within 5 seconds or retries
**Current Code:**
```typescript
// Process webhook asynchronously - DO NOT await
processWebhook(payload).catch((error) => {
  console.error('[WhatsApp Webhook] Processing error:', error);
});
// Respond immediately with 200 OK
return NextResponse.json({ status: 'ok' }, { status: 200 });
```

### Pattern 2: 24-Hour Window Enforcement (Already Implemented)
**What:** Check window before sending free-form vs template
**Current Code:**
```typescript
export function isWithin24HourWindow(lastCustomerMessageAt: string | null): boolean {
  if (!lastCustomerMessageAt) return false;
  const hoursDiff = (now.getTime() - lastMessage.getTime()) / (1000 * 60 * 60);
  return hoursDiff < 24;
}
```

### Pattern 3: Message Deduplication (Already Implemented)
**What:** Store whatsapp_message_id and check before insert
**Why:** Meta retries webhooks, causing duplicate messages
**Current:** Uses `whatsapp_message_id` column in messages table

### Pattern 4: Send Endpoint (NEEDED)
**What:** API endpoint for inbox UI to send messages
**Pattern:** Mirror the existing Telegram send endpoint
```
/api/whatsapp/send
POST { conversationId, content }
  → Get conversation → Get contact phone
  → Check 24h window → sendTextMessage or sendTemplateMessage
  → Save to DB with direction: 'outbound', sender_type: 'agent'
```

### Anti-Patterns to Avoid
- **Awaiting webhook processing:** Will cause Meta retries and duplicate messages
- **Trusting webhook without signature:** Security vulnerability
- **Storing sensitive tokens in code:** Use environment variables (already done)
- **Ignoring 24-hour window:** Will cause API errors (131047)
</architecture_patterns>

<dont_hand_roll>
## Don't Hand-Roll

| Problem | Already Solved | Why |
|---------|---------------|-----|
| Signature verification | `src/lib/whatsapp/signature.ts` | Already uses timingSafeEqual correctly |
| Message types | `@whatsapp-cloudapi/types` | Comprehensive webhook/API types |
| Phone number normalization | `normalizePhoneNumber()` | Handles +, spaces, dashes |
| 24h window check | `isWithin24HourWindow()` | Already implemented |
| Contact/conversation creation | `processor.ts` | Already handles find-or-create |

**Key insight:** The v1.0 implementation is solid. Don't rewrite - extend and verify.
</dont_hand_roll>

<common_pitfalls>
## Common Pitfalls

### Pitfall 1: Webhook Timeout (Meta Retries)
**What goes wrong:** Webhook handler takes >5 seconds, Meta retries, duplicates occur
**Why it happens:** Awaiting slow database operations in webhook handler
**How to avoid:** Process async, respond immediately (already implemented)
**Warning signs:** Duplicate messages in database, Meta retry logs

### Pitfall 2: 24-Hour Window Expired (Error 131047)
**What goes wrong:** Sending free-form message outside 24h window fails
**Why it happens:** Customer hasn't messaged in 24 hours
**How to avoid:** Check `last_customer_message_at`, use template if expired
**Warning signs:** Error code 131047 in logs

### Pitfall 3: Pair Rate Limit (Error 131056)
**What goes wrong:** Too many messages to same user in short time
**Why it happens:** Sending multiple messages rapidly to same number
**How to avoid:** Implement backoff, rate limit per-conversation
**Warning signs:** Error code 131056, messages failing to specific users

### Pitfall 4: Media URL Expiry
**What goes wrong:** Media URL returned by API expires after 5 minutes
**Why it happens:** Graph API returns temporary signed URLs
**How to avoid:** Download immediately and store in own storage
**Warning signs:** Broken media links in UI, 404s when fetching

### Pitfall 5: Raw Body Parsing for Signature
**What goes wrong:** Signature verification fails after body parsing
**Why it happens:** `express.json()` or `request.json()` modifies body
**How to avoid:** Use `request.text()` first for signature, then parse (already implemented)
**Warning signs:** All webhooks returning 401

### Pitfall 6: Template Not Approved
**What goes wrong:** Template message fails with error 132001
**Why it happens:** Using template name before Meta approval
**How to avoid:** Check template status in WhatsApp Manager before using
**Warning signs:** Error code 132001 in logs
</common_pitfalls>

<code_examples>
## Code Examples

### Send Message Endpoint (Pattern to Implement)
```typescript
// src/app/api/whatsapp/send/route.ts
// Based on existing /api/telegram/send/route.ts pattern

import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { sendTextMessage, isWithin24HourWindow } from '@/lib/whatsapp/client';

export async function POST(request: NextRequest) {
  const supabase = await createClient();
  const { conversationId, content } = await request.json();

  // Get conversation with contact
  const { data: conversation } = await supabase
    .from('conversations')
    .select('*, contact:contacts(*)')
    .eq('id', conversationId)
    .single();

  if (!conversation?.contact?.phone) {
    return NextResponse.json({ error: 'Contact not found' }, { status: 404 });
  }

  // Check 24h window
  if (!isWithin24HourWindow(conversation.last_customer_message_at)) {
    return NextResponse.json({
      error: '24-hour window expired - template required'
    }, { status: 400 });
  }

  // Send via WhatsApp Cloud API
  const result = await sendTextMessage(conversation.contact.phone, content);

  // Save to database
  await supabase.from('messages').insert({
    conversation_id: conversationId,
    direction: 'outbound',
    content,
    content_type: 'text',
    sender_type: 'agent',
    whatsapp_message_id: result.messages[0].id,
  });

  return NextResponse.json({ success: true, messageId: result.messages[0].id });
}
```

### Existing Webhook Handler (Already Correct)
```typescript
// Current implementation in src/app/api/webhooks/whatsapp/route.ts
// This is correct - keep it

// Get raw body for signature verification
const rawBody = await request.text();

// Verify signature BEFORE parsing
if (!verifySignature(rawBody, signature)) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}

// Now safe to parse
const payload = JSON.parse(rawBody) as WebhookPayload;

// Process async - DON'T await
processWebhook(payload).catch(console.error);

// Respond immediately
return NextResponse.json({ status: 'ok' }, { status: 200 });
```

### Environment Variables Required
```env
# WhatsApp Cloud API Configuration
WHATSAPP_PHONE_NUMBER_ID=your_phone_number_id
WHATSAPP_ACCESS_TOKEN=your_access_token
WHATSAPP_WEBHOOK_VERIFY_TOKEN=your_custom_verify_token
WHATSAPP_APP_SECRET=your_app_secret
WHATSAPP_API_VERSION=v21.0
```
</code_examples>

<sota_updates>
## State of the Art (2025-2026)

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Conversation pricing | Per-message pricing | Jan 2026 | Template costs change, utility in 24h free |
| Per-number limits | Portfolio-level limits | Oct 2025 | Limits apply to business account, not number |
| 80 MPS default | Auto-upgrade to 1000 MPS | 2025 | High-quality accounts get faster throughput |

**New in 2025-2026:**
- **Per-Message Pricing:** Template messages now billed per message (not conversation)
- **Free Utility in 24h:** Utility templates within customer service window are FREE
- **Portfolio Limits:** Messaging limits now at business portfolio level, not phone number
- **Graph API v21.0:** Current stable version (project already uses this)

**Deprecated/Outdated:**
- Conversation-based billing (replaced by per-message)
- Per-phone-number messaging limits (now portfolio-level)
</sota_updates>

<meta_dashboard_setup>
## Meta Dashboard Configuration (Required for Phase 13.1)

### Prerequisites
1. Meta Business Account (verified)
2. WhatsApp Business Account linked to Meta Business
3. App created in Meta Developer Dashboard

### Configuration Steps

**1. Create/Select App:**
- Go to Meta Developer Dashboard
- Create new app or select existing (type: Business)
- Add "WhatsApp" product to app

**2. Get Credentials:**
- Phone Number ID: From WhatsApp > API Setup
- Access Token: Generate permanent token via System User
- App Secret: From App Settings > Basic
- Verify Token: Create custom string for webhook verification

**3. Configure Webhook:**
- Webhook URL: `https://your-domain.com/api/webhooks/whatsapp`
- Verify Token: Same as WHATSAPP_WEBHOOK_VERIFY_TOKEN env var
- Subscribe to: `messages` field

**4. Test Phone Number:**
- Use test phone number for development
- Or register production number with business verification

### Webhook Subscription Fields
Subscribe to these webhook fields:
- `messages` - Required for receiving messages
- `message_deliveries` - Optional, for delivery receipts
- `message_reads` - Optional, for read receipts
</meta_dashboard_setup>

<open_questions>
## Open Questions

1. **Media Handling Strategy**
   - What we know: WhatsApp sends media URLs that expire in 5 minutes
   - What's unclear: Should we download and store media, or just display placeholder?
   - Recommendation: Start with placeholder (current behavior), add media download in future phase

2. **Template Message UI**
   - What we know: Templates required outside 24h window
   - What's unclear: What templates does the business have approved?
   - Recommendation: For MVP, show error when 24h expired; add template selector later

3. **Interactive Messages**
   - What we know: Buttons/lists work within session without approval
   - What's unclear: Will the business need interactive message support?
   - Recommendation: Defer to future phase unless explicitly needed
</open_questions>

<sources>
## Sources

### Primary (HIGH confidence)
- Existing codebase analysis: `src/lib/whatsapp/`, `src/services/whatsapp/`
- Phase 13-01 Summary: Documented WhatsApp was skipped due to Meta dashboard
- @whatsapp-cloudapi/types npm package documentation

### Secondary (MEDIUM confidence)
- [WhatsApp Cloud API Security Guide 2026](https://www.wuseller.com/whatsapp-business-knowledge-hub/whatsapp-cloud-api-security-2026-privacy-compliance-guide-for-business/)
- [WhatsApp API Rate Limits Guide](https://www.wati.io/en/blog/whatsapp-business-api/whatsapp-api-rate-limits/)
- [WhatsApp Business API Compliance 2026](https://gmcsco.com/your-simple-guide-to-whatsapp-api-compliance-2026/)
- [WhatsApp API Error Codes Guide](https://www.heltar.com/blogs/all-meta-error-codes-explained-along-with-complete-troubleshooting-guide-2025-cm69x5e0k000710xtwup66500)
- [WhatsApp Interactive Messages Guide](https://www.delightchat.io/blog/whatsapp-list-message-reply-buttons-interactive-message)

### Meta Official (verified via WebSearch)
- Webhook signature verification uses HMAC-SHA256 with X-Hub-Signature-256 header
- 5-second webhook response requirement confirmed
- 24-hour customer service window confirmed
- Per-message pricing change effective January 2026 confirmed
</sources>

<metadata>
## Metadata

**Research scope:**
- Core technology: WhatsApp Cloud API (Graph API v21.0)
- Ecosystem: @whatsapp-cloudapi/types, existing infrastructure
- Patterns: Webhook handling, 24h window, deduplication, send endpoint
- Pitfalls: Timeout, rate limits, media expiry, signature verification

**Confidence breakdown:**
- Standard stack: HIGH - Existing codebase already implements correctly
- Architecture: HIGH - Patterns verified against current implementation
- Pitfalls: HIGH - Documented in error code guides, some already mitigated
- Code examples: HIGH - Based on existing working patterns in codebase

**Research date:** 2026-01-20
**Valid until:** 2026-02-20 (30 days - WhatsApp API stable, pricing change already effective)
</metadata>

---

*Phase: 13.1-whatsapp-integration*
*Research completed: 2026-01-20*
*Ready for planning: yes*
