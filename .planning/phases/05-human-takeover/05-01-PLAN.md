---
phase: 05-human-takeover
plan: 01
type: execute
---

<objective>
Build the human takeover UI and state management system that allows agents to take over conversations from AI and pause/resume AI handling.

Purpose: Agents need clear visual feedback about who's handling each conversation and one-click ability to take over when AI gets stuck.
Output: Takeover button, conversation state UI indicators, and backend state management that toggles AI handling on/off
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-ai-integration/04-01-SUMMARY.md

**Tech stack available:** Next.js 16, Supabase, React, TypeScript, TailwindCSS
**Established patterns:**
- Supabase admin client for webhook processing
- Server Actions for API calls
- React hooks for UI state
- Timing-safe authentication for webhooks

**Key files to reference:**
@src/app/api/webhooks/n8n/ai-response/route.ts
@src/app/dashboard/c/[id]/page.tsx
@src/lib/supabase/client.ts

**Constraining decisions from Phase 4:**
- Conversation model has `handler_type` field ('ai' or 'human')
- n8n checks this field to route messages appropriately
- Messages already flow through database correctly
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create takeover button component and state management</name>
  <files>src/components/TakeoverButton.tsx, src/hooks/useConversationHandler.ts</files>
  <action>
Create a TakeoverButton component that:
1. Shows "AI Handling" or "You're Handling" badge based on conversation.handler_type
2. Displays a "Take Over" button when AI is currently handling (handler_type='ai')
3. Displays a "Resume AI" dropdown when you're currently handling (handler_type='human')
4. On "Take Over" click: calls server action to update handler_type to 'human', updates UI optimistically
5. On "Resume AI" click: calls server action to update handler_type to 'ai', updates UI optimistically

Create useConversationHandler hook that:
- Takes conversation_id as input
- Fetches current handler_type from Supabase
- Provides updateHandler function that calls server action
- Returns loading state and error state
- Optimistically updates local state while server processes

Use the pattern from Phase 4 auth endpoints - Supabase admin client for database writes, no RLS bypass needed (agents can edit conversations they can see).
  </action>
  <verify>
Component renders without errors: npm run build succeeds
Button shows correct state: "Take Over" when handler_type='ai', "Resume AI" when handler_type='human'
State updates reflect in Supabase: query messages table after takeover and verify new messages have correct sender_type
  </verify>
  <done>
- TakeoverButton renders correct label based on handler_type
- Click updates conversation.handler_type in Supabase
- n8n skips messages when handler_type='human' (verified in n8n execution logs from Phase 4 testing)
- Optimistic UI updates show new state immediately
  </done>
</task>

<task type="auto">
  <name>Task 2: Add takeover button to conversation header and integrate with chat UI</name>
  <files>src/app/dashboard/c/[id]/page.tsx</files>
  <action>
Update the conversation view page to:
1. Import TakeoverButton component
2. Add it to the conversation header (next to conversation name)
3. Pass current conversation object and onHandlerChange callback
4. When handler changes, refresh the message list (conversation state should be fresh)
5. Add visual indicator in the message list header showing who's currently handling:
   - "AI is handling this conversation" (when handler_type='ai')
   - "You are handling this conversation" (when handler_type='human')
   - Use different colors: blue for AI, orange/red for human

Avoid over-engineering: keep it simple. This is state tracking, not complex logic. Just show who's handling and allow one-click toggle.
  </action>
  <verify>
Page renders without errors and button appears in header
Clicking button updates the handler_type in real-time
Page reflects current state after refresh
  </verify>
  <done>
- TakeoverButton integrated into conversation header
- Visual indicator shows current handler
- Clicking button toggles handler_type and UI updates
- New messages arriving don't break UI state
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Human takeover UI with state toggle. Agents can now take over from AI and re-enable AI handling.
  </what-built>
  <how-to-verify>
1. Start the app: npm run dev
2. Login and navigate to a conversation (should have existing messages)
3. Look for TakeoverButton in the conversation header
4. Verify button shows "Take Over" (assuming conversation starts with AI handling)
5. Click "Take Over" button
6. Verify:
   - Button changes to "Resume AI"
   - Visual indicator changes to "You are handling"
   - Send a test message and verify it appears as from your agent (sender_type='agent')
7. Click "Resume AI"
8. Verify:
   - Button changes back to "Take Over"
   - Visual indicator changes to "AI is handling"
9. Send another test message to the bot's Telegram (if available) and verify:
   - n8n processes it (check n8n execution logs)
   - AI response is generated and saved
   - Message appears in inbox
  </how-to-verify>
  <resume-signal>Type "approved" if the takeover flow works, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm run build succeeds with no TypeScript errors
- [ ] TakeoverButton component renders in conversation view
- [ ] Clicking "Take Over" updates conversation.handler_type to 'human' in Supabase
- [ ] Clicking "Resume AI" updates conversation.handler_type to 'ai' in Supabase
- [ ] UI reflects state changes immediately (optimistic update)
- [ ] Visual indicators show correct handler state
- [ ] Messages sent while in 'human' mode have sender_type='agent'
- [ ] n8n skips messages when handler_type='human' (verified in n8n logs)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors or console warnings
- Takeover button functional and responsive
- Conversation state updates correctly
- Visual feedback is clear to agents
  </success_criteria>

<output>
After completion, create `.planning/phases/05-human-takeover/05-01-SUMMARY.md`:

# Phase 5 Plan 01: Human Takeover UI Summary

**Built the UI and state management for agents to take over conversations from AI and control handler assignment.**

## Accomplishments
- TakeoverButton component with state-based rendering
- useConversationHandler hook for state management
- Conversation header integrated with takeover controls
- Visual indicators showing current handler (AI vs Human)
- Optimistic UI updates for responsive feel

## Files Created/Modified
- `src/components/TakeoverButton.tsx` - Takeover button component
- `src/hooks/useConversationHandler.ts` - State management hook
- `src/app/dashboard/c/[id]/page.tsx` - Integrated takeover button into conversation view

## Decisions Made
- Optimistic UI updates for takeover (no loading spinner delay)
- Color coding for visual clarity (blue for AI, orange for human)
- Simple toggle pattern (Take Over / Resume AI)

## Issues Encountered
[If any - describe problems and how they were resolved]

## Next Phase Readiness
- Phase 5 UI complete
- Ready for Phase 6: Real-time updates (live message loading without refresh) and Arabic RTL support
- n8n integration already working - messages skip correctly when handler_type='human'
</output>
