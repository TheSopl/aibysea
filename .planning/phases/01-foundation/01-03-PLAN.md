---
phase: 01-foundation
plan: 03
type: execute
---

<objective>
Implement agent authentication and basic app shell layout.

Purpose: Enable agents to log in securely and establish the visual structure for the inbox application.
Output: Working login/logout flow with protected dashboard routes and basic two-panel layout shell.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@src/lib/supabase/client.ts
@src/lib/supabase/server.ts
@src/lib/supabase/middleware.ts

**Key requirements:**
- Agent authentication (login/logout)
- Basic app shell/layout
- Two-panel layout for inbox (from PROJECT.md)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create authentication pages</name>
  <files>src/app/login/page.tsx, src/app/auth/callback/route.ts, src/app/actions/auth.ts</files>
  <action>
    1. Create src/app/login/page.tsx - Login page with email/password form:
       ```typescript
       'use client'

       import { createClient } from '@/lib/supabase/client'
       import { useRouter } from 'next/navigation'
       import { useState } from 'react'

       export default function LoginPage() {
         const [email, setEmail] = useState('')
         const [password, setPassword] = useState('')
         const [error, setError] = useState<string | null>(null)
         const [loading, setLoading] = useState(false)
         const router = useRouter()
         const supabase = createClient()

         const handleLogin = async (e: React.FormEvent) => {
           e.preventDefault()
           setError(null)
           setLoading(true)

           const { error } = await supabase.auth.signInWithPassword({
             email,
             password,
           })

           if (error) {
             setError(error.message)
             setLoading(false)
             return
           }

           router.push('/dashboard')
           router.refresh()
         }

         return (
           <div className="min-h-screen flex items-center justify-center bg-gray-50">
             <div className="max-w-md w-full space-y-8 p-8 bg-white rounded-lg shadow">
               <div>
                 <h2 className="text-center text-3xl font-bold text-gray-900">
                   AIBYSEA
                 </h2>
                 <p className="mt-2 text-center text-sm text-gray-600">
                   Sign in to your agent account
                 </p>
               </div>
               <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                 {error && (
                   <div className="bg-red-50 text-red-500 p-3 rounded text-sm">
                     {error}
                   </div>
                 )}
                 <div className="space-y-4">
                   <div>
                     <label htmlFor="email" className="block text-sm font-medium text-gray-700">
                       Email
                     </label>
                     <input
                       id="email"
                       type="email"
                       required
                       value={email}
                       onChange={(e) => setEmail(e.target.value)}
                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                     />
                   </div>
                   <div>
                     <label htmlFor="password" className="block text-sm font-medium text-gray-700">
                       Password
                     </label>
                     <input
                       id="password"
                       type="password"
                       required
                       value={password}
                       onChange={(e) => setPassword(e.target.value)}
                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                     />
                   </div>
                 </div>
                 <button
                   type="submit"
                   disabled={loading}
                   className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
                 >
                   {loading ? 'Signing in...' : 'Sign in'}
                 </button>
               </form>
             </div>
           </div>
         )
       }
       ```

    2. Create src/app/auth/callback/route.ts - Handle OAuth callbacks (for future social login):
       ```typescript
       import { createClient } from '@/lib/supabase/server'
       import { NextResponse } from 'next/server'

       export async function GET(request: Request) {
         const { searchParams, origin } = new URL(request.url)
         const code = searchParams.get('code')
         const next = searchParams.get('next') ?? '/dashboard'

         if (code) {
           const supabase = await createClient()
           const { error } = await supabase.auth.exchangeCodeForSession(code)
           if (!error) {
             return NextResponse.redirect(`${origin}${next}`)
           }
         }

         return NextResponse.redirect(`${origin}/login?error=auth`)
       }
       ```

    3. Create src/app/actions/auth.ts - Server action for logout:
       ```typescript
       'use server'

       import { createClient } from '@/lib/supabase/server'
       import { redirect } from 'next/navigation'

       export async function signOut() {
         const supabase = await createClient()
         await supabase.auth.signOut()
         redirect('/login')
       }
       ```
  </action>
  <verify>npm run build succeeds, /login page renders without errors</verify>
  <done>Login page created with email/password form, auth callback route for OAuth, signOut server action</done>
</task>

<task type="auto">
  <name>Task 2: Add authentication middleware</name>
  <files>src/middleware.ts</files>
  <action>
    Create src/middleware.ts to protect /dashboard routes:

    ```typescript
    import { type NextRequest } from 'next/server'
    import { updateSession } from '@/lib/supabase/middleware'

    export async function middleware(request: NextRequest) {
      return await updateSession(request)
    }

    export const config = {
      matcher: [
        /*
         * Match all request paths except:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * - public folder
         */
        '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
      ],
    }
    ```

    Update src/lib/supabase/middleware.ts to handle auth redirects:

    ```typescript
    import { createServerClient } from '@supabase/ssr'
    import { NextResponse, type NextRequest } from 'next/server'

    export async function updateSession(request: NextRequest) {
      let supabaseResponse = NextResponse.next({
        request,
      })

      const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
          cookies: {
            getAll() {
              return request.cookies.getAll()
            },
            setAll(cookiesToSet) {
              cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value))
              supabaseResponse = NextResponse.next({
                request,
              })
              cookiesToSet.forEach(({ name, value, options }) =>
                supabaseResponse.cookies.set(name, value, options)
              )
            },
          },
        }
      )

      const {
        data: { user },
      } = await supabase.auth.getUser()

      // Protected routes - redirect to login if not authenticated
      if (
        !user &&
        request.nextUrl.pathname.startsWith('/dashboard')
      ) {
        const url = request.nextUrl.clone()
        url.pathname = '/login'
        return NextResponse.redirect(url)
      }

      // Redirect authenticated users away from login
      if (user && request.nextUrl.pathname === '/login') {
        const url = request.nextUrl.clone()
        url.pathname = '/dashboard'
        return NextResponse.redirect(url)
      }

      return supabaseResponse
    }
    ```
  </action>
  <verify>npm run build succeeds, visiting /dashboard without auth redirects to /login</verify>
  <done>Middleware protects /dashboard routes, redirects unauthenticated users to /login, redirects authenticated users from /login to /dashboard</done>
</task>

<task type="auto">
  <name>Task 3: Create app shell layout</name>
  <files>src/app/dashboard/layout.tsx, src/app/dashboard/page.tsx, src/components/Sidebar.tsx, src/components/Header.tsx</files>
  <action>
    1. Create src/components/Header.tsx - Top navigation with logout:
       ```typescript
       import { signOut } from '@/app/actions/auth'

       export function Header() {
         return (
           <header className="h-16 border-b border-gray-200 bg-white flex items-center justify-between px-6">
             <h1 className="text-xl font-semibold text-gray-900">AIBYSEA</h1>
             <form action={signOut}>
               <button
                 type="submit"
                 className="text-sm text-gray-600 hover:text-gray-900"
               >
                 Sign out
               </button>
             </form>
           </header>
         )
       }
       ```

    2. Create src/components/Sidebar.tsx - Left sidebar placeholder for chat list:
       ```typescript
       export function Sidebar() {
         return (
           <aside className="w-80 border-r border-gray-200 bg-gray-50 flex flex-col">
             <div className="p-4 border-b border-gray-200">
               <h2 className="font-medium text-gray-900">Conversations</h2>
             </div>
             <div className="flex-1 overflow-y-auto p-4">
               <p className="text-sm text-gray-500">
                 No conversations yet. They will appear here once WhatsApp integration is complete.
               </p>
             </div>
           </aside>
         )
       }
       ```

    3. Create src/app/dashboard/layout.tsx - Two-panel layout:
       ```typescript
       import { Header } from '@/components/Header'
       import { Sidebar } from '@/components/Sidebar'

       export default function DashboardLayout({
         children,
       }: {
         children: React.ReactNode
       }) {
         return (
           <div className="h-screen flex flex-col">
             <Header />
             <div className="flex-1 flex overflow-hidden">
               <Sidebar />
               <main className="flex-1 overflow-y-auto bg-white">
                 {children}
               </main>
             </div>
           </div>
         )
       }
       ```

    4. Create src/app/dashboard/page.tsx - Dashboard placeholder:
       ```typescript
       import { createClient } from '@/lib/supabase/server'

       export default async function DashboardPage() {
         const supabase = await createClient()
         const { data: { user } } = await supabase.auth.getUser()

         return (
           <div className="h-full flex items-center justify-center">
             <div className="text-center">
               <h2 className="text-2xl font-semibold text-gray-900 mb-2">
                 Welcome to AIBYSEA
               </h2>
               <p className="text-gray-600">
                 Logged in as {user?.email}
               </p>
               <p className="text-sm text-gray-500 mt-4">
                 Select a conversation from the sidebar to begin.
               </p>
             </div>
           </div>
         )
       }
       ```

    5. Update src/app/page.tsx to redirect to dashboard:
       ```typescript
       import { redirect } from 'next/navigation'

       export default function Home() {
         redirect('/dashboard')
       }
       ```
  </action>
  <verify>npm run build succeeds, /dashboard shows two-panel layout with header, sidebar, and main content area</verify>
  <done>Dashboard layout created with header (logout button), sidebar (conversation list placeholder), and main content area. Root redirects to /dashboard.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication flow with protected dashboard and app shell layout</what-built>
  <how-to-verify>
    **Prerequisites:**
    1. Create a Supabase project at https://supabase.com if you haven't already
    2. Copy your project URL and anon key from Settings > API
    3. Create .env.local with:
       ```
       NEXT_PUBLIC_SUPABASE_URL=your-project-url
       NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
       ```
    4. In Supabase dashboard, go to Authentication > Users and create a test user (or enable email signup)
    5. Apply the schema from supabase/migrations/001_initial_schema.sql in SQL Editor

    **Testing:**
    1. Run: `npm run dev`
    2. Visit: http://localhost:3000 - should redirect to /dashboard, then to /login (not authenticated)
    3. Enter test user credentials and click "Sign in"
    4. Should redirect to /dashboard with:
       - Header showing "AIBYSEA" and "Sign out" button
       - Left sidebar with "Conversations" heading
       - Main area showing "Welcome to AIBYSEA" and your email
    5. Click "Sign out" - should redirect to /login
    6. Try visiting /dashboard directly - should redirect to /login
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Login page renders at /login
- [ ] Dashboard protected by auth middleware
- [ ] Two-panel layout visible on /dashboard
- [ ] Logout redirects to /login
- [ ] Human verification completed
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Authentication flow works end-to-end
- Dashboard layout shows two-panel structure
- Phase 1: Foundation complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
