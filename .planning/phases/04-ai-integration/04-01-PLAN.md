---
phase: 04-ai-integration
plan: 01
type: execute
---

<objective>
Implement webhook endpoints for n8n to manage AI agent conversation handling and human takeover triggers.

Purpose: Enable n8n workflow to orchestrate conversation routing (AI vs human) and state management through Next.js API endpoints.
Output: Two webhook endpoints ready for n8n integration (/api/webhooks/n8n/ai-response and /api/webhooks/n8n/human-takeover)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-ai-integration/04-RESEARCH.md
@.planning/phases/03-inbox-core/03-03-SUMMARY.md
@src/types/database.ts
@src/lib/supabase/server.ts
@src/lib/supabase/admin.ts
@src/services/telegram/processor.ts

**Established patterns:**
- Webhook security: Use crypto.timingSafeEqual for signature verification
- Service role client: Use admin client for webhook processing (RLS bypass)
- Error handling: Console log with [Service] prefix
- Message storage: direction='outbound', sender_type='agent', sender_id from agents table

**Tech stack available:**
- Next.js 16 with TypeScript
- Supabase with RLS and service role key
- Existing webhook patterns from Phase 2 (WhatsApp processor)

**Constraining decisions (from Phase 3):**
- Use server-side actions and Supabase any-cast for type safety
- Update conversation.last_message_at after state changes
- Track handler_type ('ai' or 'human') to route conversations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI response webhook endpoint</name>
  <files>src/app/api/webhooks/n8n/ai-response/route.ts</files>
  <action>
Create POST endpoint `/api/webhooks/n8n/ai-response` that:
1. Receives n8n webhook payload with: conversation_id, content (AI response), metadata (optional)
2. Validate request is from n8n (use webhook secret - environment variable N8N_WEBHOOK_SECRET with timing-safe comparison)
3. Query Supabase for conversation to verify it exists and handler_type='ai'
4. Insert message to Supabase messages table:
   - conversation_id, direction='outbound', content, sender_type='agent', sender_id='ai-agent'
5. Update conversation.last_message_at to now()
6. Return 200 {success: true, message_id}

Use service role client (createAdminClient) to bypass RLS since n8n is backend-to-backend.
Use crypto.timingSafeEqual for signature verification to prevent timing attacks.
Handle errors: return 400 for invalid payload, 401 for auth failure, 404 for missing conversation, 500 for DB error.
  </action>
  <verify>curl -X POST http://localhost:3000/api/webhooks/n8n/ai-response -H "Authorization: Bearer {SECRET}" -H "Content-Type: application/json" -d '{"conversation_id":"test-id","content":"Hello"}' returns 200</verify>
  <done>Endpoint accepts AI responses, stores them in database, and returns success response</done>
</task>

<task type="auto">
  <name>Task 2: Create human takeover webhook endpoint</name>
  <files>src/app/api/webhooks/n8n/human-takeover/route.ts</files>
  <action>
Create POST endpoint `/api/webhooks/n8n/human-takeover` that:
1. Receives payload with: conversation_id, agent_id (triggering agent), reason (optional)
2. Validate request is from n8n (timing-safe comparison with N8N_WEBHOOK_SECRET)
3. Query Supabase for conversation and verify it exists
4. Update conversation:
   - Set handler_type='human'
   - Set assigned_agent_id=agent_id (from request)
   - Update last_message_at to now()
5. Log: "[Human Takeover] Conversation {conv_id} assigned to {agent_id} (reason: {reason})"
6. Return 200 {success: true, conversation_id, assigned_agent_id}

This endpoint is called by n8n when AI gets stuck or customer explicitly requests human.
Use service role client for RLS bypass.
Handle errors: 400 invalid payload, 401 auth failure, 404 conversation not found, 500 DB error.
  </action>
  <verify>curl -X POST http://localhost:3000/api/webhooks/n8n/human-takeover -H "Authorization: Bearer {SECRET}" -H "Content-Type: application/json" -d '{"conversation_id":"test-id","agent_id":"agent-123"}' returns 200</verify>
  <done>Endpoint accepts takeover requests, updates conversation state, and returns confirmation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] Both endpoints exist in `/api/webhooks/n8n/`
- [ ] Endpoints verify N8N_WEBHOOK_SECRET header using timing-safe comparison
- [ ] Endpoints use service role client for database operations
- [ ] Error responses include appropriate HTTP status codes (400/401/404/500)
- [ ] Messages created include sender_type='agent' and sender_id='ai-agent'
- [ ] conversation.last_message_at updated on each webhook call
</verification>

<success_criteria>

- Both webhook endpoints created
- Authentication working (secret verification)
- Database updates working (messages inserted, conversations updated)
- Error handling in place
- Ready for n8n workflow integration
  </success_criteria>

<output>
After completion, create `.planning/phases/04-ai-integration/04-01-SUMMARY.md`:

# Phase 4 Plan 01: AI Response Webhook Summary

**[Substantive one-liner about what shipped]**

## Accomplishments
- AI response webhook endpoint accepting n8n messages
- Human takeover webhook endpoint managing conversation assignment
- Timing-safe authentication for webhook security

## Files Created/Modified
- `src/app/api/webhooks/n8n/ai-response/route.ts` - AI message handling
- `src/app/api/webhooks/n8n/human-takeover/route.ts` - Takeover request handling

## Decisions Made
[Any decisions made during implementation]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
Ready for Phase 4 Plan 02: n8n workflow setup and testing
</output>
