---
phase: 04-ai-integration
plan: 02
type: execute
---

<objective>
Set up and test n8n workflow for AI agent message handling with conversation state management.

Purpose: Build the n8n automation that routes incoming WhatsApp messages to AI agents, maintains context, and handles human takeover.
Output: Working n8n workflow that processes WhatsApp messages and calls Next.js webhook endpoints
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-ai-integration/04-RESEARCH.md
@.planning/phases/04-01-SUMMARY.md

**Standard Stack (from research):**
- n8n 1.70+ (orchestration engine)
- n8n WhatsApp Business Cloud node (for triggering on incoming messages)
- n8n Supabase node (for state queries and updates)
- OpenAI API (LLM for agent responses)
- Error recovery: exponential backoff with "Retry On Fail"

**Established patterns from research:**
- Respond immediately to webhook (prevent 100s timeout)
- Query Supabase conversation state before responding
- Load last 10 messages for LLM context
- Use exponential backoff (1s, 2s, 5s, 13s) for API retries
- Route based on handler_type: 'ai' → respond, 'human' → notify agent

**Constraints:**
- WhatsApp Cloud API credentials configured (Phase 2)
- Supabase already has conversation and message tables
- Next.js webhook endpoints ready (04-01)
- OpenAI API key needed as environment variable
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up n8n instance and WhatsApp incoming webhook</name>
  <files>n8n-config.md (documentation), .env.local (environment configuration)</files>
  <action>
Set up n8n environment:
1. Deploy n8n instance (Cloud or self-hosted via Docker - recommend n8n Cloud for MVP)
2. Configure n8n credentials:
   - Supabase: URL, API key (from .env.local)
   - OpenAI: API key (from .env.local)
   - WhatsApp Cloud API: Phone number ID, Business Account ID, access token (already have from Phase 2)
3. Create WhatsApp Business Cloud trigger node:
   - This is the incoming webhook from WhatsApp (not same as our Next.js endpoints)
   - Set up to trigger on message_received events
   - Extract: conversation_id (use contact.phone as identifier), message_content
4. Test: Send test message through WhatsApp and verify n8n receives it
5. Document n8n setup steps in n8n-config.md for reference

Note: n8n Cloud is managed (easier), self-hosted requires Docker setup.
  </action>
  <verify>WhatsApp Cloud sends test message, n8n workflow triggers and logs received payload</verify>
  <done>n8n receives incoming WhatsApp messages and extracts conversation ID and content</done>
</task>

<task type="auto">
  <name>Task 2: Build n8n workflow for AI message routing and response</name>
  <files>n8n-workflow-export.json (n8n workflow backup), n8n-setup-steps.md (documentation)</files>
  <action>
Build n8n workflow following the research architecture pattern:

1. **Start: WhatsApp incoming message trigger**

2. **Extract and transform:**
   - Extract conversation_id from webhook payload
   - Extract message_content

3. **Query Supabase conversation state:**
   - Use Supabase node to SELECT conversations WHERE id=conversation_id
   - Extract handler_type field

4. **Conditional routing:**
   - IF handler_type='ai':
     - Continue to AI response flow
   - ELSE (handler_type='human'):
     - Log "[n8n] Skipping message - human handling conversation {id}"
     - Stop workflow (don't process further)

5. **AI Response Flow (if handler_type='ai'):**
   - Query last 10 messages: SELECT * FROM messages WHERE conversation_id=X ORDER BY created_at DESC LIMIT 10
   - Transform messages into context array (format for LLM)
   - Call OpenAI API:
     - Model: gpt-4o or gpt-3.5-turbo (configurable)
     - System prompt: "You are a customer support AI. Be helpful, concise, professional."
     - Messages: full conversation context
     - Include incoming message as latest user message
   - Use error handling: Retry On Fail (3-5 retries, exponential backoff)
   - If retries fail: Call Next.js human-takeover endpoint (error escalation)

6. **Store AI response:**
   - Call Next.js webhook: POST /api/webhooks/n8n/ai-response
   - Payload: {conversation_id, content: AI_RESPONSE}
   - Include N8N_WEBHOOK_SECRET header for authentication

7. **Error handling:**
   - If any step fails, log to console with [n8n-workflow] prefix
   - Don't silently fail

Export workflow as JSON and document setup steps.
  </action>
  <verify>Manual test: Send WhatsApp message with handler_type='ai', verify n8n processes it, AI responds via webhook</verify>
  <done>n8n workflow successfully routes AI messages and stores responses in database</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>n8n workflow for AI agent message handling</what-built>
  <how-to-verify>
    1. Access n8n instance (Cloud dashboard or localhost:5678)
    2. Verify workflow exists with all nodes: WhatsApp trigger, Supabase queries, OpenAI call, HTTP webhook
    3. Test workflow manually:
       - Send test message to WhatsApp number
       - Check n8n logs show message received
       - Verify Supabase query returns conversation state
       - Verify OpenAI API was called
       - Check Next.js webhook received the response
    4. Verify AI response appears in database (messages table)
    5. Verify conversation.last_message_at was updated
  </how-to-verify>
  <resume-signal>Type "approved" if workflow is working, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] n8n instance deployed and accessible
- [ ] WhatsApp Business Cloud webhook configured
- [ ] Workflow receives incoming WhatsApp messages
- [ ] Supabase integration working (can query conversations/messages)
- [ ] OpenAI API integration working (AI responding to messages)
- [ ] HTTP webhook to Next.js endpoint working
- [ ] AI responses stored in database
- [ ] Error handling in place (retries, escalation)
</verification>

<success_criteria>

- n8n instance operational
- Complete workflow deployed
- AI responses generated and stored
- Human takeover escalation available
- Integration with existing Next.js API working
  </success_criteria>

<output>
After completion, create `.planning/phases/04-ai-integration/04-02-SUMMARY.md`:

# Phase 4 Plan 02: AI Workflow Setup Summary

**[Substantive one-liner about what shipped]**

## Accomplishments
- n8n instance deployed with WhatsApp integration
- AI message routing workflow configured
- Error handling and escalation implemented

## Files Created/Modified
- n8n-config.md - Setup and credential configuration
- n8n-workflow-export.json - Workflow backup
- n8n-setup-steps.md - Documentation for future reference

## Decisions Made
- n8n deployment method (Cloud vs self-hosted)
- LLM choice (GPT-4o vs cheaper models)

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
- Phase 4 (AI Integration) complete
- AI agents now handle conversations until stuck or human takeover
- Ready for Phase 5: Human Takeover (agent takeover UI, pause/resume AI)
</output>
