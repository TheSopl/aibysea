---
phase: 20-foundation-quality-infrastructure
plan: 02
type: execute
---

<objective>
Establish end-to-end testing infrastructure with Playwright for Next.js 16.

Purpose: Enable testing of async Server Components and critical user flows that cannot be unit tested (login, messaging, i18n routing). Complements unit tests from Plan 1.
Output: Working Playwright setup with E2E tests for authentication and inbox messaging flows.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-foundation-quality-infrastructure/20-RESEARCH.md
@.planning/phases/20-foundation-quality-infrastructure/CONTEXT.md
@.planning/phases/20-foundation-quality-infrastructure/20-01-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STACK.md

**Tech stack:**
- Next.js 16 App Router with Server Components
- Supabase authentication (cookie-based sessions)
- next-intl for EN/AR routing (/en/*, /ar/*)
- Real-time messaging via Supabase channels

**From RESEARCH.md:**
- Playwright is official Next.js recommendation for E2E testing
- Required for testing async Server Components (Vitest/Jest cannot)
- Auto-wait for elements, cross-browser support, debugging tools
- Use `npx playwright codegen` to generate test code from interactions
- Don't hand-roll Puppeteer scripts - Playwright handles edge cases

**From Plan 1:**
- Unit test infrastructure established
- Webhook and utility tests passing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Playwright for Next.js 16</name>
  <files>playwright.config.ts, package.json, .gitignore</files>
  <action>
Install Playwright:
```bash
npm install -D @playwright/test
npx playwright install --with-deps
```

Create `playwright.config.ts` with:
- baseURL: 'http://localhost:3000'
- testDir: './e2e'
- Use Chromium, Firefox, WebKit browsers (cross-browser testing)
- webServer configuration to auto-start Next.js dev server before tests
- fullyParallel: false (tests may share database state)
- retries: 2 for CI environments
- Screenshots on failure, trace on first retry

Add to package.json scripts:
- "test:e2e": "playwright test"
- "test:e2e:ui": "playwright test --ui"
- "test:e2e:debug": "playwright test --debug"

Update .gitignore:
```
# Playwright
/test-results/
/playwright-report/
/playwright/.cache/
```

AVOID: Using Cypress (slower than Playwright per research). AVOID: Running E2E tests in parallel initially (database state conflicts). AVOID: Using headless: false by default (use --headed flag when needed).
  </action>
  <verify>Run `npx playwright --version` to confirm installation. Run `npx playwright test --list` to verify config loads (should list 0 tests initially).</verify>
  <done>Playwright installed, config file created, test scripts added to package.json, .gitignore updated, no configuration errors</done>
</task>

<task type="auto">
  <name>Task 2: Write E2E tests for authentication and inbox flows</name>
  <files>e2e/auth.spec.ts, e2e/inbox.spec.ts, e2e/i18n.spec.ts</files>
  <action>
Create `e2e/auth.spec.ts`:
- Test: Navigate to /login, fill email/password, submit, expect redirect to /dashboard or /inbox
- Test: Access protected route without auth, expect redirect to /login
- Test: Logout flow clears session
- Use page.goto(), page.getByLabel(), page.getByRole(), page.waitForURL()
- Use test fixtures for test user credentials (from Supabase test data)

Create `e2e/inbox.spec.ts`:
- Test: Load inbox page, verify conversation list renders
- Test: Click conversation, verify messages load
- Test: Send message, verify message appears in conversation (optimistic UI)
- Test: Real-time message update (if time allows - may require webhook simulation)
- Use page.locator(), expect(page).toHaveURL(), expect(element).toBeVisible()

Create `e2e/i18n.spec.ts`:
- Test: Navigate to /ar/dashboard, verify HTML dir="rtl" attribute
- Test: Navigate to /en/dashboard, verify HTML dir="ltr" attribute
- Test: Verify Arabic navigation labels render (if visible in DOM)
- Test: Language switcher changes locale (if implemented in UI)

Use Playwright's auto-wait (don't use explicit waits unless necessary).
Use descriptive test names: "should redirect to login when accessing protected route unauthenticated"
Use page.screenshot() on failure for debugging.

AVOID: Testing implementation details. AVOID: Hardcoding selectors - use getByRole/getByLabel. AVOID: Not cleaning up test data (if creating records).
  </action>
  <verify>Run `npm run test:e2e` (will start dev server, run tests, shut down). Should see 5-7 tests pass across 3 spec files. Tests should complete in under 60 seconds total.</verify>
  <done>All E2E tests pass, auth flow tested, inbox messaging tested, i18n routing tested, Playwright generates reports on failure</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:e2e` passes all tests
- [ ] Auth flow works (login → redirect → logout)
- [ ] Inbox loads and displays conversations
- [ ] i18n routing works (EN and AR locales)
- [ ] No flaky tests (run twice to confirm stability)
</verification>

<success_criteria>

- All tasks completed
- Playwright configured for Next.js 16
- 5-7 E2E tests passing (auth, inbox, i18n)
- Cross-browser testing enabled (Chromium, Firefox, WebKit)
- Auto-start dev server before tests
- No flaky or failing tests
  </success_criteria>

<output>
After completion, create `.planning/phases/20-foundation-quality-infrastructure/20-02-SUMMARY.md`:

# Phase 20 Plan 2: E2E Testing with Playwright Summary

**End-to-end testing infrastructure established with 7 passing tests**

## Accomplishments

- Playwright configured for Next.js 16 with App Router support
- Cross-browser testing enabled (Chromium, Firefox, WebKit)
- Auto-start dev server before E2E test runs
- Authentication flow tested (login, protected routes, logout)
- Inbox messaging flow tested (conversation list, message display)
- i18n routing tested (EN/AR locales, RTL/LTR direction)
- Screenshot and trace capture on test failures

## Files Created/Modified

- `playwright.config.ts` - Playwright configuration with webServer auto-start
- `e2e/auth.spec.ts` - Authentication flow tests (3 tests)
- `e2e/inbox.spec.ts` - Inbox messaging tests (2-3 tests)
- `e2e/i18n.spec.ts` - Internationalization tests (2 tests)
- `package.json` - Added Playwright dependency and test:e2e scripts
- `.gitignore` - Excluded Playwright artifacts

## Decisions Made

- Chose Playwright over Cypress (official Next.js recommendation, faster)
- Disabled parallel execution initially (avoid database state conflicts)
- Enabled screenshot/trace capture for debugging failed tests
- Used getByRole/getByLabel selectors (accessibility-focused, more maintainable)

## Issues Encountered

[Any issues and resolutions, or "None"]

## Next Step

Ready for 20-03-PLAN.md (Error Monitoring with Sentry)
</output>
