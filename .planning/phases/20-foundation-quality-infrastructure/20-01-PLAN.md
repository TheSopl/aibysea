---
phase: 20-foundation-quality-infrastructure
plan: 01
type: execute
---

<objective>
Establish unit and integration testing infrastructure with Vitest and Testing Library.

Purpose: Enable safe refactoring and regression prevention for upcoming enterprise transformation phases (21-26). Zero test coverage blocks architectural improvements.
Output: Working test framework with 10+ critical tests covering webhook security, API routes, and utility functions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-foundation-quality-infrastructure/20-RESEARCH.md
@.planning/phases/20-foundation-quality-infrastructure/CONTEXT.md
@.planning/codebase/TESTING.md
@.planning/codebase/STACK.md
@.planning/codebase/ARCHITECTURE.md

**Current state:**
- Zero tests across 121 TypeScript files
- No test framework configured
- Critical security code (webhook signature validation) untested
- i18n/RTL functionality untested

**Tech stack available:**
- Next.js 16 with React 19 (requires specific Vitest configuration)
- Supabase for database operations
- next-intl for internationalization
- TypeScript with strict mode enabled

**From RESEARCH.md:**
- Use Vitest (not Jest) - 30-70% faster, ESM native, Next.js official recommendation
- Use @testing-library/react for component tests
- Use jsdom for DOM environment
- Key limitation: Async Server Components cannot be unit tested (use E2E in Plan 2)
- Don't hand-roll test utilities - use Testing Library
- Critical pitfall: Must wait for async updates with waitFor/findBy queries
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Vitest testing framework</name>
  <files>vitest.config.mts, package.json, src/lib/test-utils.tsx, vitest.setup.ts</files>
  <action>
Install test dependencies:
```bash
npm install -D vitest @vitejs/plugin-react @vitest/ui jsdom @testing-library/react @testing-library/dom @testing-library/user-event vite-tsconfig-paths
```

Create `vitest.config.mts` with:
- @vitejs/plugin-react for React support
- vite-tsconfig-paths for @ alias resolution
- jsdom environment (not happy-dom - better Next.js compatibility per RESEARCH.md)
- Coverage configuration with v8 provider
- Exclude node_modules, config files, type definitions from coverage

Create `vitest.setup.ts` if needed for global test setup.

Create `src/lib/test-utils.tsx` with custom render function that wraps components in NextIntlClientProvider with test messages (en locale default). Import test messages from a minimal subset covering common keys.

Add test scripts to package.json:
- "test": "vitest"
- "test:ui": "vitest --ui"
- "test:coverage": "vitest --coverage"

AVOID: Using Jest (slower, less Next.js 16 compatible). AVOID: happy-dom (use jsdom per research). AVOID: Testing async Server Components with Vitest (will fail - E2E only in Plan 2).
  </action>
  <verify>Run `npm test -- --run` (single run mode) - should execute with 0 tests found and exit cleanly. Run `npm run test:ui` - should open Vitest UI in browser.</verify>
  <done>Vitest configured, test scripts work, test-utils.tsx exports renderWithProviders function, no errors when running empty test suite</done>
</task>

<task type="auto">
  <name>Task 2: Write critical security and utility tests</name>
  <files>src/lib/whatsapp/signature.test.ts, src/lib/utils.test.ts, src/app/api/webhooks/whatsapp/route.test.ts</files>
  <action>
Create `src/lib/whatsapp/signature.test.ts`:
- Test valid HMAC signature accepts (crypto.timingSafeEqual should return true)
- Test invalid signature rejects (should return false)
- Test timing attack resistance (execution time similar for valid/invalid)
- Use vitest's `describe`, `it`, `expect` syntax
- Import signature validation function from existing code

Create `src/lib/utils.test.ts`:
- Test `cn()` function merges class names correctly
- Test Tailwind class conflicts resolve properly (e.g., 'px-2 px-4' → 'px-4')
- Test empty inputs return empty string

Create `src/app/api/webhooks/whatsapp/route.test.ts`:
- Mock Supabase client using vi.mock()
- Test signature validation is called
- Test valid webhook payload creates message record
- Test invalid signature returns 401
- Test missing signature header returns 400

Use @testing-library/user-event for user interactions (not fireEvent - more realistic per RESEARCH.md).
Use waitFor for async assertions.
Use vi.fn() for mocks, vi.mock() for module mocking.

AVOID: Testing implementation details (internal state). AVOID: getByTestId (use getByRole, getByText). AVOID: Testing async Server Components (impossible - E2E only).
  </action>
  <verify>Run `npm test -- --coverage`. Should show 10+ tests passing. Coverage report should show >30% overall coverage with 100% coverage for src/lib/whatsapp/signature.ts (critical security path).</verify>
  <done>All tests pass, webhook signature validation has 100% coverage, utils.test.ts covers cn() function, API route test validates security flow, coverage report generated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- --run` passes all tests
- [ ] `npm run test:coverage` generates coverage report
- [ ] Coverage for webhook signature validation is 100%
- [ ] No errors or warnings in test output
- [ ] Vitest UI works (`npm run test:ui`)
</verification>

<success_criteria>

- All tasks completed
- Vitest framework configured and functional
- Test utilities available for future tests
- 10+ critical tests written and passing
- Coverage ≥30% overall, 100% for webhook signature validation
- No test failures, no configuration errors
  </success_criteria>

<output>
After completion, create `.planning/phases/20-foundation-quality-infrastructure/20-01-SUMMARY.md`:

# Phase 20 Plan 1: Testing Infrastructure Setup Summary

**Testing framework established with 10+ critical tests passing**

## Accomplishments

- Vitest configured with React 19 support and jsdom environment
- Testing utilities created with NextIntlClientProvider wrapper
- Critical webhook signature validation tests (100% coverage)
- Utility function tests for cn() helper
- API route tests for WhatsApp webhook security
- Coverage reporting configured with v8 provider

## Files Created/Modified

- `vitest.config.mts` - Vitest configuration with React plugin and path resolution
- `vitest.setup.ts` - Global test setup (if needed)
- `src/lib/test-utils.tsx` - Custom render function with i18n provider
- `src/lib/whatsapp/signature.test.ts` - Webhook signature validation tests
- `src/lib/utils.test.ts` - Utility function tests
- `src/app/api/webhooks/whatsapp/route.test.ts` - API route security tests
- `package.json` - Added test dependencies and scripts

## Decisions Made

- Chose Vitest over Jest (30-70% faster, better Next.js 16 support)
- Chose jsdom over happy-dom (better Next.js compatibility)
- Targeted 30%+ coverage for foundation (will grow in future phases)
- Prioritized security-critical code (webhook validation 100% coverage)

## Issues Encountered

[Any issues and resolutions, or "None"]

## Next Step

Ready for 20-02-PLAN.md (E2E Testing with Playwright)
</output>
