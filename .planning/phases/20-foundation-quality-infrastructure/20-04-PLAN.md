---
phase: 20-foundation-quality-infrastructure
plan: 04
type: execute
---

<objective>
Establish CI/CD pipeline and database migration system for automated quality checks and version-controlled schema changes.

Purpose: Prevent broken code from reaching production via automated testing, enable safe database schema evolution across dev/staging/prod environments. Currently no safety net.
Output: Working GitHub Actions workflow with automated testing + Supabase migration system with initial schema captured.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-foundation-quality-infrastructure/20-RESEARCH.md
@.planning/phases/20-foundation-quality-infrastructure/CONTEXT.md
@.planning/phases/20-foundation-quality-infrastructure/20-01-SUMMARY.md
@.planning/phases/20-foundation-quality-infrastructure/20-02-SUMMARY.md
@.planning/phases/20-foundation-quality-infrastructure/20-03-SUMMARY.md
@.planning/codebase/STACK.md
@.planning/codebase/CONCERNS.md

**Current state:**
- No CI/CD pipeline (bad code can be deployed)
- No automated testing before merge
- Database schema changes made manually in Supabase dashboard
- No version control for schema

**Tech stack:**
- GitHub repository (assumed)
- Supabase Cloud for database
- npm for package management
- Next.js 16 build system

**From RESEARCH.md:**
- GitHub Actions is standard for Next.js CI/CD
- Use actions/setup-node@v6 with cache: 'npm' for dependency caching
- Use npm ci (not npm install) in CI for reproducible builds
- Parallel jobs: lint, typecheck, test, build
- E2E tests only on main branch (slower, save CI minutes)
- Supabase CLI for migrations: `supabase migration new`, `supabase db push`

**From prior plans:**
- Plan 1: Vitest configured, unit tests passing
- Plan 2: Playwright configured, E2E tests passing
- Plan 3: Sentry integrated (errors will be tracked in CI)

**Critical pitfalls from RESEARCH.md:**
- Using npm install instead of npm ci (non-deterministic)
- Not caching dependencies (slow CI, expensive)
- Not committing package-lock.json (broken builds)
- Running E2E on every PR (wastes CI minutes - use main branch only)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI/CD workflow</name>
  <files>.github/workflows/ci.yml, README.md</files>
  <action>
Create `.github/workflows/ci.yml`:

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npx tsc --noEmit

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm test -- --run --coverage
      - uses: codecov/codecov-action@v4
        if: success()
        continue-on-error: true

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run build
        env:
          # Add required env vars for build (use GitHub secrets)
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

  e2e:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npx playwright install --with-deps
      - run: npm run build
      - run: npm run start &
      - run: npx wait-on http://localhost:3000
      - run: npm run test:e2e
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
```

Jobs run in parallel except E2E (only on main branch to save CI minutes).

Add CI badge to README.md:
```markdown
![CI](https://github.com/username/repo/workflows/CI/badge.svg)
```

AVOID: Using npm install (use npm ci for reproducible builds). AVOID: Running E2E on all PRs (expensive - main branch only). AVOID: Not caching npm dependencies (slow, wastes CI minutes). AVOID: Forgetting environment variables for build (will fail).
  </action>
  <verify>Push to GitHub and check Actions tab. Should see workflow run with 4-5 jobs (lint, typecheck, test, build, optionally e2e if main branch). All jobs should pass except e2e (may need GitHub secrets configured).</verify>
  <done>CI workflow created, jobs run in parallel, dependency caching enabled, E2E only on main branch, badge added to README</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>GitHub Actions CI/CD workflow with automated testing</what-built>
  <how-to-verify>
1. Visit GitHub repository Actions tab: https://github.com/[username]/[repo]/actions
2. Find the workflow run triggered by the commit from Task 1
3. Verify all jobs completed:
   - ✅ lint (should pass if no linting errors)
   - ✅ typecheck (should pass if no TypeScript errors)
   - ✅ test (should pass with Vitest tests from Plan 1)
   - ✅ build (should pass if build succeeds)
   - ⚠️ e2e (may skip if not on main, or fail if secrets not configured - this is OK for now)
4. Click on each job to see logs - verify no unexpected errors
5. Check that jobs ran in parallel (start times within seconds of each other)
6. Verify dependency caching worked (npm ci should take <30 seconds after first run)

**If any job fails:**
- Describe which job failed and the error message
- I'll help fix the issue before proceeding

**If GitHub secrets need to be added:**
- Go to Settings → Secrets and variables → Actions
- Add NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY
- Re-run the workflow
  </how-to-verify>
  <resume-signal>Type "approved" when CI pipeline passes, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Setup Supabase CLI and create initial database migration</name>
  <files>supabase/config.toml, supabase/migrations/20260202000000_initial_schema.sql, .gitignore, package.json</files>
  <action>
Install Supabase CLI globally (if not already installed):
```bash
npm install -g supabase
```

Initialize Supabase project:
```bash
supabase init
```

This creates `supabase/config.toml` with project configuration.

Link to remote Supabase project:
```bash
supabase login
supabase link --project-ref [PROJECT_REF]
```

Get PROJECT_REF from Supabase dashboard URL (e.g., abcdefghijklmnop).

Pull current schema from remote as initial migration:
```bash
supabase db pull
```

This creates a migration file in `supabase/migrations/` with current schema (conversations, messages, contacts, agents, ai_agents tables).

Rename migration file to `20260202000000_initial_schema.sql` for clarity.

Add to package.json scripts:
```json
{
  "scripts": {
    "db:migrate": "supabase migration new",
    "db:reset": "supabase db reset",
    "db:push": "supabase db push"
  }
}
```

Update `.gitignore`:
```
# Supabase
.branches
.temp
```

Test migration locally:
```bash
supabase db reset
```

Should recreate local database from migration files.

AVOID: Manually writing initial migration (use supabase db pull to capture current schema). AVOID: Committing .branches or .temp directories (local Supabase files). AVOID: Not testing migration locally before committing (may be invalid SQL).
  </action>
  <verify>Run `supabase db reset` - should recreate local database successfully. Run `supabase migration list` - should show initial_schema.sql migration as applied. Check `supabase/migrations/` directory - should contain migration file with complete schema DDL.</verify>
  <done>Supabase CLI installed and linked, initial migration created from current schema, migration tested locally, scripts added to package.json, .gitignore updated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] GitHub Actions workflow exists and passes
- [ ] All CI jobs run successfully (lint, typecheck, test, build)
- [ ] Dependency caching works (fast npm ci after first run)
- [ ] Supabase CLI linked to remote project
- [ ] Initial migration file captures current schema
- [ ] `supabase db reset` works locally
</verification>

<success_criteria>

- All tasks completed
- GitHub Actions CI/CD pipeline running on push/PR
- Automated testing prevents broken code from merging
- Parallel job execution (lint, typecheck, test, build)
- Dependency caching reduces CI run times
- Supabase CLI configured and linked
- Initial database migration created and tested
- Migration workflow documented in package.json scripts
  </success_criteria>

<output>
After completion, create `.planning/phases/20-foundation-quality-infrastructure/20-04-SUMMARY.md`:

# Phase 20 Plan 4: CI/CD Pipeline + Database Migrations Summary

**Automated quality gates and version-controlled database schema established**

## Accomplishments

- GitHub Actions CI/CD workflow created with parallel jobs
- Automated testing on all push/PR events (lint, typecheck, test, build)
- Dependency caching enabled (30-60s faster CI runs after first)
- E2E tests run only on main branch (CI minute optimization)
- Supabase CLI installed and linked to remote project
- Initial database migration captured current schema
- Migration tested locally with `supabase db reset`
- CI badge added to README for visibility

## Files Created/Modified

- `.github/workflows/ci.yml` - CI/CD pipeline with 5 jobs
- `supabase/config.toml` - Supabase project configuration
- `supabase/migrations/20260202000000_initial_schema.sql` - Initial schema migration
- `package.json` - Added db:migrate, db:reset, db:push scripts
- `.gitignore` - Excluded Supabase local files (.branches, .temp)
- `README.md` - Added CI status badge

## Decisions Made

- Used npm ci instead of npm install for deterministic CI builds
- Enabled dependency caching to optimize CI performance
- Run E2E tests only on main branch (save CI minutes for PRs)
- Pulled initial migration from remote (not manual SQL writing)
- Used actions/setup-node@v6 with latest caching backend

## Issues Encountered

[Any issues and resolutions, or "None"]

## Next Phase Readiness

Phase 20 complete. All 4 infrastructure foundations established:
- ✅ Testing framework (Vitest + Testing Library)
- ✅ E2E testing (Playwright)
- ✅ Error monitoring (Sentry)
- ✅ CI/CD pipeline (GitHub Actions)
- ✅ Database migrations (Supabase CLI)

**Blocks removed:**
- Phases 21-26 can now proceed safely with test coverage
- Refactoring work in Phase 21 has safety net
- Performance optimization in Phase 24 can establish baselines
- Production errors now visible via Sentry

**Ready for Phase 21: UI Design System Enforcement**
</output>
