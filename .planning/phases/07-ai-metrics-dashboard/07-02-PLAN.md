---
phase: 07-ai-metrics-dashboard
plan: 02
type: auto
domain: real-time-state-management
---

<objective>
Wire real-time metrics to dashboard via Zustand store with Supabase Broadcast subscriptions, batching middleware, and design-aware animations.

Purpose: Enable the dashboard to receive and display live AI metrics without re-render storms. Metrics flow: n8n webhooks → Supabase → Zustand (batched) → React components with smooth teal glow animations. Health score, metric cards, and risk badges update smoothly every 100-200ms.
Output: Working real-time metrics stream with Zustand store, Supabase subscriptions, batching middleware, and animated metric updates with design system effects (glow, color changes, smooth transitions).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
.planning/phases/07-ai-metrics-dashboard/07-RESEARCH.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ai-metrics-dashboard/07-RESEARCH.md
@.planning/DESIGN-SYSTEM-V1.1.md
@.planning/FEATURE-MOCKUP-V1.1.md

**Key decisions from RESEARCH.md:**
- Use Zustand for metrics state (established from v1.0)
- Use Supabase Broadcast channel (not Postgres Changes) for high-frequency updates
- Batch updates every 100-200ms to prevent re-render storms
- Use windowing to keep only recent metrics in memory (last 1000 points)

**Design system integration (from DESIGN-SYSTEM-V1.1.md):**
- Animate metric updates with Framer Motion
- Health score color gradient: low (red) → medium (amber) → high (teal)
- Metric cards show smooth transitions when values change
- Risk badges pulse on high-risk events (animation triggers on color change)
- All animations 200ms cubic-bezier for smoothness

**Established patterns from v1.0:**
- Zustand already used in project for other state
- Supabase real-time subscriptions established (REPLICA IDENTITY FULL on messages table)
- Server wrapper + client component pattern for subscriptions
- Framer Motion already available from Plan 07-01

**Files to reference:**
- `src/stores/` - Existing Zustand store patterns
- `src/hooks/` - Existing custom hooks
- `src/lib/supabase.ts` - Supabase client configuration
- `src/components/dashboard/` - Components from Plan 07-01
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand metrics store with batching middleware + animation triggers</name>
  <files>src/stores/metricsStore.ts</files>
  <action>Create Zustand store for real-time metrics with shape: { latency, confidence, quality, sentiment, riskScore, healthScore, activeConversations, aiState, connectionStatus, metrics: MetricsPoint[], shouldAnimate: boolean }. Implement batching middleware (100ms windows). Add windowing (last 1000 points). Include animation trigger flag that pulses for 300ms when metrics change (used by components to show glow effects). Export useMetricsStore hook. All store updates are properly typed with TypeScript.</action>
  <verify>Test: Create store, call updateMetrics 5 times rapidly, verify only 1 state change (batching works). Verify shouldAnimate flag triggers and resets after 300ms. No memory leaks on windowing. npm test passes.</verify>
  <done>Store created with batching, windowing, animation triggers, TypeScript typed, tests passing</done>
</task>

<task type="auto">
  <name>Task 2: Create useMetricsSubscription hook for Supabase Broadcast + connection status</name>
  <files>src/hooks/useMetricsSubscription.ts</files>
  <action>Create hook that subscribes to Supabase Broadcast "metrics" channel and updates store. On mount: subscribe to 'metrics_update' event, call store.updateMetrics(payload). Handle connection states: connected → green badge, connecting → yellow, disconnected → red. On unmount: unsubscribe cleanly. Include error handling with fallback to offline mode. Connection state updates flow through store so UI can react (badges, colors, animations).</action>
  <verify>Hook imports cleanly. Test component using hook: verify subscription on mount, connection status changes reflect in UI (badge color changes), cleanup on unmount. Connection state drives UI visual changes (animations, badge colors).</verify>
  <done>Hook created, subscription working, connection state flows to UI with visual feedback, cleanup handles properly</done>
</task>

<task type="auto">
  <name>Task 3: Wire store to dashboard + add design-aware animations on metric updates</name>
  <files>src/components/dashboard/AIMetricsDashboard.tsx, src/components/dashboard/MetricsCard.tsx, src/components/dashboard/HealthScore.tsx, src/hooks/useMockMetricsStream.ts</files>
  <action>Update all dashboard components to consume Zustand store. Implement animated updates: (1) Health score animates color: red (#EF4444) if <50%, amber (#F59E0B) if 50-80%, teal (#00D9FF) if >80%, (2) Metric cards flash a brief teal glow when value updates (box-shadow animation 200ms), (3) Risk badges pulse red when high-risk detected (animation triggers from shouldAnimate flag), (4) All animations use Framer Motion with cubic-bezier(0.4, 0, 0.2, 1) easing. Add mock data hook (NEXT_PUBLIC_MOCK_METRICS) for testing without n8n. Production mode connects to Supabase Broadcast.</action>
  <verify>npm run dev with NEXT_PUBLIC_MOCK_METRICS=true, watch metrics update smoothly with glow animations. No jank. Health score color changes smoothly. Risk badges pulse when high-risk. React DevTools shows <5Hz re-renders (batching working). Animations feel professional (200ms, smooth easing).</verify>
  <done>All components animated with design system effects, mock data works, smooth 200ms animations, no re-render storms, professional feel</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test` passes for metricsStore tests
- [ ] `npm run dev` launches without errors
- [ ] Dashboard displays and updates live metrics (with NEXT_PUBLIC_MOCK_METRICS=true)
- [ ] Metrics update smoothly without jank (batching middleware working)
- [ ] Connection status badge updates correctly
- [ ] No TypeScript errors
- [ ] React DevTools shows efficient re-renders (<5Hz max)
- [ ] No console errors or warnings
</verification>

<success_criteria>

- Zustand store created with batching middleware and windowing
- Metrics hook connects to Supabase Broadcast "metrics" channel
- Connection status tracking working
- Dashboard displays live values from store
- Mock data stream for local testing (without n8n)
- Batching prevents re-render storms (verifiable in React DevTools)
- Error handling for subscription failures
- Code follows project TypeScript conventions

</success_criteria>

<output>
After completion, create `.planning/phases/07-ai-metrics-dashboard/07-02-SUMMARY.md`:

# Phase 7 Plan 02: Real-Time Metrics & State Management Summary

**Implemented real-time metrics streaming with Zustand store and Supabase Broadcast subscriptions.**

## Accomplishments

- Created Zustand metrics store with batching middleware (100ms windows)
- Implemented windowing to keep only last 1000 metrics in memory
- Built useMetricsSubscription hook for Supabase Broadcast channel
- Integrated metrics store with AIMetricsDashboard component
- Added mock metrics stream for local testing (NEXT_PUBLIC_MOCK_METRICS flag)
- Updated connection status badge to reflect subscription state

## Files Created/Modified

- `src/stores/metricsStore.ts` - Zustand store with batching + windowing
- `src/stores/__tests__/metricsStore.test.ts` - Store batching tests
- `src/hooks/useMetricsSubscription.ts` - Supabase Broadcast subscription hook
- `src/hooks/useMockMetricsStream.ts` - Mock data generator for testing
- `src/components/dashboard/AIMetricsDashboard.tsx` - Updated to consume store
- `src/components/dashboard/ConnectionStatus.tsx` - Now displays real subscription status

## Decisions Made

- Batching at 100ms (from RESEARCH.md) provides smooth feel (10 updates/sec max) without jitter
- Windowing at 1000 items chosen for ~100 seconds of 10Hz data (tunable per feedback)
- Mock stream uses NEXT_PUBLIC_MOCK_METRICS env var (easier than conditional imports)
- Supabase Broadcast chosen over Postgres Changes (scales better per RESEARCH.md)

## Issues Encountered

None

## Next Step

Ready for 07-03-PLAN.md: Chart visualization with Recharts and performance optimization

</output>
