---
phase: 02-whatsapp-integration
plan: 03
type: execute
---

<objective>
Create WhatsApp message sending client and complete end-to-end integration with human verification.

Purpose: Enable sending messages to WhatsApp users and verify the complete send/receive flow works.
Output: Working sendTextMessage and sendTemplateMessage functions, plus verified end-to-end flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-whatsapp-integration/02-RESEARCH.md
@.planning/phases/02-whatsapp-integration/02-02-SUMMARY.md (load after Plan 2 completes)
@src/types/database.ts
@src/lib/whatsapp/constants.ts
@src/lib/whatsapp/types.ts

**Tech stack available:** Next.js 16, Supabase, TypeScript, @whatsapp-cloudapi/types
**Established patterns:**
- WhatsApp library foundation in src/lib/whatsapp/
- Message processor persisting to database
- Conversations track handler_type (ai/human)

**From RESEARCH.md - Message Sending:**
- POST to https://graph.facebook.com/{version}/{phone_id}/messages
- Authorization: Bearer {access_token}
- messaging_product: 'whatsapp' in all requests
- Phone numbers without + prefix

**From RESEARCH.md - 24-Hour Window:**
- Free-form messages only within 24 hours of customer's last message
- After 24 hours: must use approved template message
- Error 131047 if you try free-form outside window
- Track last_customer_message_at per conversation

**From RESEARCH.md - Common Errors:**
- 131047: Re-engagement required (24h window expired)
- 131056: Pair rate limit (too many to same user)
- 132001: Template does not exist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create message sending client</name>
  <files>src/lib/whatsapp/client.ts</files>
  <action>
Create WhatsApp API client for sending messages:

**sendTextMessage(to: string, text: string): Promise<SendMessageResponse>**
- Construct POST request to BASE_URL (from constants.ts)
- Headers: Authorization Bearer token, Content-Type application/json
- Body: { messaging_product: 'whatsapp', recipient_type: 'individual', to, type: 'text', text: { body: text } }
- Handle response: if !response.ok, parse error and throw with WhatsApp error message
- Return parsed response (contains message ID for tracking)

**sendTemplateMessage(to: string, templateName: string, languageCode: string, components?: TemplateComponent[]): Promise<SendMessageResponse>**
- Same structure but type: 'template'
- Body template section: { name, language: { code }, components }
- Components optional (for templates without variables)

**Helper types to export:**
```typescript
interface SendMessageResponse {
  messaging_product: 'whatsapp';
  contacts: Array<{ input: string; wa_id: string }>;
  messages: Array<{ id: string }>;
}

interface WhatsAppError {
  error: {
    message: string;
    type: string;
    code: number;
    error_subcode?: number;
    fbtrace_id: string;
  };
}
```

**Error handling:**
- Log full error response for debugging
- Throw Error with user-friendly message including error code
- Include common error codes in error message: "Error 131047: 24-hour window expired - use template message"

**Critical notes:**
- Do NOT include + in phone number (WhatsApp format)
- Access token from WHATSAPP_ACCESS_TOKEN env var
- Phone ID from WHATSAPP_PHONE_NUMBER_ID env var
  </action>
  <verify>TypeScript compiles; exports sendTextMessage and sendTemplateMessage; types are correct</verify>
  <done>WhatsApp message sending client with text and template support</done>
</task>

<task type="auto">
  <name>Task 2: Add 24-hour window tracking</name>
  <files>supabase/migrations/003_conversation_last_customer_message.sql, src/types/database.ts, src/services/whatsapp/processor.ts</files>
  <action>
Track when customer last messaged for 24-hour window enforcement.

**Create migration supabase/migrations/003_conversation_last_customer_message.sql:**
```sql
-- Track last customer message for 24-hour window
ALTER TABLE conversations ADD COLUMN last_customer_message_at TIMESTAMPTZ;

-- Update existing conversations to use last_message_at as initial value
UPDATE conversations SET last_customer_message_at = last_message_at WHERE last_customer_message_at IS NULL;
```

**Update src/types/database.ts:**
- Add last_customer_message_at: string | null to conversations Row
- Add last_customer_message_at?: string | null to conversations Insert
- Add last_customer_message_at?: string | null to conversations Update

**Update src/services/whatsapp/processor.ts:**
- When processing inbound message, update conversation.last_customer_message_at to current timestamp
- This tracks when customer service window opened/refreshed

**Add helper function in src/lib/whatsapp/client.ts:**
```typescript
export function isWithin24HourWindow(lastCustomerMessageAt: string | null): boolean {
  if (!lastCustomerMessageAt) return false;
  const lastMessage = new Date(lastCustomerMessageAt);
  const now = new Date();
  const hoursDiff = (now.getTime() - lastMessage.getTime()) / (1000 * 60 * 60);
  return hoursDiff < 24;
}
```
  </action>
  <verify>Migration file exists; database types updated; processor updates last_customer_message_at; isWithin24HourWindow helper exports</verify>
  <done>24-hour window tracking enabled for conversations</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete WhatsApp integration: webhook receiving messages, client sending messages, database persistence with 24-hour window tracking</what-built>
  <how-to-verify>
**Prerequisites (you need to do these first):**
1. Deploy to Vercel (or use ngrok for local testing)
2. Configure webhook URL in Meta Developer Dashboard:
   - Go to your WhatsApp app > Configuration > Webhooks
   - Callback URL: https://your-domain.vercel.app/api/webhooks/whatsapp
   - Verify token: whatever you set in WHATSAPP_WEBHOOK_VERIFY_TOKEN
   - Subscribe to: messages
3. Fill in .env.local (or Vercel env vars) with WhatsApp credentials:
   - WHATSAPP_PHONE_NUMBER_ID
   - WHATSAPP_ACCESS_TOKEN
   - WHATSAPP_WEBHOOK_VERIFY_TOKEN
   - WHATSAPP_APP_SECRET
   - WHATSAPP_API_VERSION=v21.0
4. Apply migrations 002 and 003 to your Supabase database

**Test flow:**
1. Send a WhatsApp message to your business number from a test phone
2. Check Supabase database:
   - New contact created with phone number (no + prefix)
   - New conversation created with channel='whatsapp'
   - New message with direction='inbound', content matching your text
3. (Optional) Test sending via temporary API route or database function
   - Send reply within 24-hour window
   - Verify message delivered to test phone

**Expected results:**
- Webhook receives and persists incoming messages
- Contact and conversation created automatically
- No duplicate messages on webhook retries (check whatsapp_message_id)
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 2, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] sendTextMessage and sendTemplateMessage functions work
- [ ] isWithin24HourWindow helper function exists
- [ ] Migration for last_customer_message_at created
- [ ] Database types updated
- [ ] Message processor updates last_customer_message_at
- [ ] `npm run build` succeeds
- [ ] Human verified end-to-end flow (checkpoint passed)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified working integration
- Phase 2 complete - WhatsApp messages can be received and sent
</success_criteria>

<output>
After completion, create `.planning/phases/02-whatsapp-integration/02-03-SUMMARY.md` following the summary template.

Include in summary:
- Note about required Meta Developer Dashboard configuration
- Note about required environment variables
- Note about migrations to apply
- Confirmation of successful end-to-end test
</output>
