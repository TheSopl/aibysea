---
phase: 02-whatsapp-integration
plan: 01
type: execute
---

<objective>
Set up WhatsApp Cloud API library foundation with TypeScript types, signature verification, and environment configuration.

Purpose: Establish the core WhatsApp infrastructure that webhook handler and message sending will build upon.
Output: WhatsApp library files in src/lib/whatsapp/ with types, signature verification, and constants.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-whatsapp-integration/02-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@src/types/database.ts

**Tech stack available:** Next.js 16, Supabase, TypeScript
**Established patterns:** Database types in src/types/, Supabase clients in src/lib/supabase/
**Constraining decisions:**
- Phase 1: Manual TypeScript types (no CLI-generated types yet)
- Phase 1: Phone number as primary contact identifier

**From RESEARCH.md - Standard Stack:**
- Use `@whatsapp-cloudapi/types` for TypeScript types (zero runtime overhead)
- Use native `fetch` for API calls
- Use `crypto` module for HMAC-SHA256 signature verification
- Do NOT use archived `whatsapp` npm package

**From RESEARCH.md - Don't Hand-Roll:**
- Webhook types → use @whatsapp-cloudapi/types
- Signature verification → use crypto.timingSafeEqual (prevents timing attacks)
- Phone number formatting → normalize to no + prefix (WhatsApp strips it)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install WhatsApp types and configure environment</name>
  <files>.env.local.example, package.json</files>
  <action>
1. Install @whatsapp-cloudapi/types package: `npm install @whatsapp-cloudapi/types`

2. Create/update .env.local.example with required WhatsApp environment variables:
```
# WhatsApp Cloud API Configuration
WHATSAPP_PHONE_NUMBER_ID=     # From Meta Developer Dashboard
WHATSAPP_ACCESS_TOKEN=        # System user access token (permanent)
WHATSAPP_WEBHOOK_VERIFY_TOKEN= # Custom string you define for webhook verification
WHATSAPP_APP_SECRET=          # From Meta App Settings (for signature verification)
WHATSAPP_API_VERSION=v21.0    # Current Graph API version
```

Note: Do NOT create actual .env.local - user will populate credentials manually.
  </action>
  <verify>npm ls @whatsapp-cloudapi/types shows package installed; .env.local.example contains all 5 WhatsApp variables</verify>
  <done>Types package installed, environment template documented</done>
</task>

<task type="auto">
  <name>Task 2: Create WhatsApp library foundation</name>
  <files>src/lib/whatsapp/constants.ts, src/lib/whatsapp/signature.ts, src/lib/whatsapp/types.ts</files>
  <action>
Create src/lib/whatsapp/ directory with three files:

**constants.ts:**
- Export API_VERSION from env or default 'v21.0'
- Export BASE_URL template: `https://graph.facebook.com/{version}/{phone_id}/messages`
- Export getApiUrl() function that constructs full URL with env vars
- Add JSDoc explaining each constant's purpose

**signature.ts:**
- Import createHmac and timingSafeEqual from 'crypto'
- Export verifySignature(payload: string, signature: string | null): boolean
- Implementation MUST:
  - Return false if signature is null/undefined
  - Create HMAC-SHA256 hash of payload using WHATSAPP_APP_SECRET
  - Prepend 'sha256=' to the computed hash
  - Use timingSafeEqual for comparison (prevents timing attacks)
  - Wrap in try/catch (timingSafeEqual throws if buffer lengths differ)
- Add JSDoc explaining why timing-safe comparison matters

**types.ts:**
- Re-export WebhookPayload and other useful types from @whatsapp-cloudapi/types/webhook
- Export custom WhatsAppConfig interface for our configuration
- Export MessageDirection type: 'inbound' | 'outbound'
- Export MessageSenderType type: 'customer' | 'agent' | 'ai'
- These custom types bridge WhatsApp types to our database schema
  </action>
  <verify>TypeScript compilation passes (npm run build); all three files exist with correct exports</verify>
  <done>WhatsApp library foundation complete with constants, signature verification, and type re-exports</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] @whatsapp-cloudapi/types installed and in package.json
- [ ] .env.local.example documents all 5 required WhatsApp env vars
- [ ] src/lib/whatsapp/constants.ts exports API URL helpers
- [ ] src/lib/whatsapp/signature.ts exports verifySignature with timing-safe comparison
- [ ] src/lib/whatsapp/types.ts re-exports webhook types and custom types
- [ ] `npm run build` succeeds without TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- WhatsApp library foundation ready for webhook handler (Plan 2)
</success_criteria>

<output>
After completion, create `.planning/phases/02-whatsapp-integration/02-01-SUMMARY.md` following the summary template.
</output>
