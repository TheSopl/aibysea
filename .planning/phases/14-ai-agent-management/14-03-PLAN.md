---
phase: 14-ai-agent-management
plan: 03
type: execute
---

<objective>
Enable assigning AI agents to conversations and pass agent context to n8n workflows.

Purpose: Complete the agent-conversation link so specific AI agents handle specific conversations with their configured personality.
Output: Conversations can have an assigned AI agent, inbox shows which agent is handling, n8n receives agent context.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./14-03-SUMMARY.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-ai-agent-management/14-01-SUMMARY.md
@.planning/phases/14-ai-agent-management/14-02-SUMMARY.md
@src/app/(main)/inbox/page.tsx
@src/app/api/webhooks/n8n/ai-response/route.ts
@src/types/database.ts
@supabase/migrations/001_initial_schema.sql

**Prior context:**
- 14-01: ai_agents table exists with CRUD API
- 14-02: Agent management UI complete
- Conversations have `handler_type` ('ai' | 'human') but no specific agent assignment
- n8n webhook receives conversation_id but not agent personality context

**Patterns established:**
- `assigned_agent_id` on conversations references human agents table
- Need `ai_agent_id` to reference AI agents table
- Inbox already joins with contacts, add join with ai_agents
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ai_agent_id to conversations</name>
  <files>supabase/migrations/009_conversation_ai_agent.sql, src/types/database.ts</files>
  <action>
Create migration to add `ai_agent_id` column to conversations:
- `ai_agent_id` (uuid, nullable, references ai_agents(id) on delete set null)
- Default null (conversations can exist without assigned AI agent)

Update TypeScript types:
- Add `ai_agent_id: string | null` to Conversation Row/Insert/Update types

This column tracks which AI agent should handle the conversation when handler_type is 'ai'.
Separate from `assigned_agent_id` which tracks human agent assignments.
  </action>
  <verify>Migration applies successfully, TypeScript types updated</verify>
  <done>ai_agent_id column exists on conversations, types updated</done>
</task>

<task type="auto">
  <name>Task 2: Update inbox with agent assignment UI</name>
  <files>src/app/(main)/inbox/page.tsx</files>
  <action>
Enhance inbox to show and manage AI agent assignment:

1. Update conversation fetch to join ai_agents:
   `.select('*, contact:contacts(*), ai_agent:ai_agents(id, name, model, status)')`

2. In conversation details panel (right side), add "AI Agent" section:
   - Show currently assigned agent name and model (or "None assigned")
   - Add dropdown to select/change AI agent
   - Fetch available agents from /api/ai-agents for dropdown
   - On selection change, PATCH conversation with new ai_agent_id

3. In conversation list (left side), show agent indicator:
   - Small badge or icon showing assigned agent name
   - Different color if no agent assigned (warning style)

4. Add "Assign Agent" action if no agent assigned:
   - Quick action button in conversation header
   - Opens dropdown to select agent

Use existing UI patterns - dropdowns, badges, action buttons match current styling.
  </action>
  <verify>Inbox shows agent assignment, dropdown changes agent</verify>
  <done>Agent assignment visible in inbox, can change via dropdown</done>
</task>

<task type="auto">
  <name>Task 3: Pass agent context to n8n webhook</name>
  <files>src/app/api/webhooks/whatsapp/route.ts, src/app/api/webhooks/telegram/route.ts</files>
  <action>
Update incoming message webhooks to include AI agent context when forwarding to n8n:

1. When processing incoming message, fetch the conversation's assigned ai_agent
2. If ai_agent exists, include in the payload sent to n8n:
   ```
   {
     conversation_id: ...,
     message: ...,
     ai_agent: {
       id: agent.id,
       name: agent.name,
       model: agent.model,
       system_prompt: agent.system_prompt,
       greeting_message: agent.greeting_message,
       behaviors: agent.behaviors
     }
   }
   ```
3. If no ai_agent assigned, send null (n8n can use default behavior)

This allows n8n to customize AI responses based on the assigned agent's personality.

Note: The actual n8n workflow configuration is outside this codebase - we just need to send the data.
  </action>
  <verify>Check webhook code includes ai_agent data in n8n payload</verify>
  <done>Webhooks include ai_agent context when forwarding to n8n</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>AI agent assignment system - conversations linked to specific AI agents, visible in inbox, context passed to n8n</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/agents
       - Ensure at least one AI agent exists (create if needed)
    3. Visit: http://localhost:3000/inbox
    4. Select a conversation
    5. Look for AI Agent section in details panel:
       - Should show "None assigned" or current agent
       - Dropdown should list available agents
    6. Assign an agent:
       - Select agent from dropdown
       - Should save and show the selected agent
    7. Check conversation list:
       - Should show agent indicator on the conversation
    8. Change agent:
       - Select different agent
       - Should update immediately
    9. (Optional) Check network tab:
       - Incoming message webhook should include ai_agent in payload
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] ai_agent_id column exists on conversations table
- [ ] Inbox fetches and displays assigned AI agent
- [ ] Agent dropdown allows changing assignment
- [ ] Conversation list shows agent indicator
- [ ] Webhooks include ai_agent context in n8n payload
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verification approved
- No TypeScript errors
- Agent assignment works end-to-end
- Phase 14 complete
</success_criteria>

<output>
After completion, create `.planning/phases/14-ai-agent-management/14-03-SUMMARY.md`

**Phase 14 complete** - AI agents can be created, configured, assigned to conversations, and their context is passed to n8n for personalized AI responses.
</output>
