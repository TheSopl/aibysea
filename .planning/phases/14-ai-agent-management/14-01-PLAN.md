---
phase: 14-ai-agent-management
plan: 01
type: execute
---

<objective>
Create database schema and API routes for AI agent management.

Purpose: Establish the data layer for storing AI agent configurations, enabling CRUD operations that the UI will consume.
Output: `ai_agents` table in Supabase, TypeScript types, and full CRUD API at `/api/ai-agents`.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./14-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/database.ts
@supabase/migrations/001_initial_schema.sql

**Prior context:**
- Phase 13/13.1: Conversational core verified, WhatsApp bidirectional messaging complete
- Existing `agents` table stores human agents (email, name, avatar) - NOT AI agents
- `conversations.handler_type` distinguishes 'ai' vs 'human' handling
- `/agents` page exists with hardcoded demo data

**Patterns to follow:**
- Supabase migration naming: `00X_descriptive_name.sql`
- TypeScript types in `src/types/database.ts` with Row/Insert/Update pattern
- API routes use Next.js App Router conventions
- Admin client for operations bypassing RLS
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ai_agents table migration</name>
  <files>supabase/migrations/008_ai_agents.sql</files>
  <action>
Create migration for `ai_agents` table with fields:
- `id` (uuid, primary key, default gen_random_uuid())
- `name` (text, not null) - Display name like "Sales Assistant"
- `model` (text, not null, default 'gpt-4-turbo') - AI model identifier
- `system_prompt` (text) - The personality/instructions prompt
- `greeting_message` (text) - First message when conversation starts
- `triggers` (jsonb, default '[]') - Array of trigger keywords/patterns
- `behaviors` (jsonb, default '{}') - Behavior settings (escalation rules, etc.)
- `status` (text, default 'active') - 'active' or 'inactive'
- `created_at` (timestamptz, default now())
- `updated_at` (timestamptz, default now())

Add RLS policy: all authenticated users can read/write (same pattern as other tables).
Enable real-time for the table.
  </action>
  <verify>Run `npx supabase db push` or apply migration manually - table should exist in Supabase dashboard</verify>
  <done>ai_agents table exists with all columns, RLS enabled, real-time enabled</done>
</task>

<task type="auto">
  <name>Task 2: Add AIAgent TypeScript types</name>
  <files>src/types/database.ts</files>
  <action>
Add `ai_agents` table definition to Database interface following existing pattern:
- Row type with all fields
- Insert type with optional fields that have defaults
- Update type with all optional

Add convenience aliases:
- `AIAgent = Database['public']['Tables']['ai_agents']['Row']`
- `NewAIAgent = Database['public']['Tables']['ai_agents']['Insert']`

Triggers should be typed as `string[]` (array of trigger phrases).
Behaviors should be typed as `Record<string, unknown>` for flexibility.
  </action>
  <verify>`npm run build` passes with no TypeScript errors</verify>
  <done>AIAgent and NewAIAgent types exported, no type errors</done>
</task>

<task type="auto">
  <name>Task 3: Create /api/ai-agents CRUD routes</name>
  <files>src/app/api/ai-agents/route.ts, src/app/api/ai-agents/[id]/route.ts</files>
  <action>
Create `/api/ai-agents/route.ts`:
- GET: List all AI agents, ordered by created_at desc
- POST: Create new AI agent with validation (name required, model required)

Create `/api/ai-agents/[id]/route.ts`:
- GET: Fetch single agent by ID
- PATCH: Update agent fields (partial update)
- DELETE: Delete agent by ID

Use server Supabase client with proper auth checks.
Return proper HTTP status codes (200, 201, 400, 404, 500).
Include error messages in response body for debugging.

Pattern to follow from existing `/api/voice/agents/route.ts` but with real Supabase instead of mock data.
  </action>
  <verify>
Test with curl:
- `curl http://localhost:3000/api/ai-agents` returns empty array or list
- `curl -X POST http://localhost:3000/api/ai-agents -H "Content-Type: application/json" -d '{"name":"Test Agent","model":"gpt-4-turbo"}'` returns 201
  </verify>
  <done>All 5 CRUD operations work (list, create, get, update, delete), proper status codes returned</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] ai_agents table exists in Supabase with correct schema
- [ ] GET /api/ai-agents returns JSON array
- [ ] POST /api/ai-agents creates agent and returns it
- [ ] GET /api/ai-agents/[id] returns single agent
- [ ] PATCH /api/ai-agents/[id] updates agent
- [ ] DELETE /api/ai-agents/[id] removes agent
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- API routes accessible and functional
- Ready for UI integration in 14-02
</success_criteria>

<output>
After completion, create `.planning/phases/14-ai-agent-management/14-01-SUMMARY.md`
</output>
